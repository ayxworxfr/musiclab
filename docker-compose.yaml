services:
  flutter:
    image: ghcr.io/cirruslabs/flutter:3.35.0
    platform: linux/amd64
    volumes:
      - .:/app
      - flutter-cache:/opt/flutter/.pub-cache
      - gradle-cache:/root/.gradle
    working_dir: /app
    environment:
      # Flutter 中国镜像
      - PUB_HOSTED_URL=https://pub.flutter-io.cn
      - FLUTTER_STORAGE_BASE_URL=https://storage.flutter-io.cn
      # Gradle 配置
      - GRADLE_OPTS=-Dorg.gradle.daemon=false
    # 添加 --android-skip-build-dependency-validation 和 --no-track-widget-creation
    command: >
      sh -c "
        flutter clean && 
        flutter pub get && 
        flutter build apk --release --android-skip-build-dependency-validation --no-track-widget-creation
      "

volumes:
  flutter-cache:
  gradle-cache:
