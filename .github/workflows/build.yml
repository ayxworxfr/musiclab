name: Build and Release

on:
  push:
    branches:
      - main
      - dev
    tags:
      - 'v*'
  pull_request:
    branches:
      - main
      - dev
  workflow_dispatch:

env:
  # Flutter 版本 - 可根据项目需要调整
  FLUTTER_VERSION: '3.35.0'

jobs:
  # 代码质量检查
  quality:
    name: Code Quality Check
    runs-on: ubuntu-latest
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 设置 Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: 获取依赖
        run: flutter pub get

      - name: 代码格式检查
        run: dart format --set-exit-if-changed lib/ test/
        continue-on-error: true  # 开发阶段不强制格式检查

      - name: 代码分析
        run: flutter analyze
        continue-on-error: true  # 开发阶段不强制分析检查

      - name: 运行测试
        run: flutter test --coverage
        continue-on-error: true

  # Android 构建
  build-android:
    name: Build Android APK/AAB
    runs-on: ubuntu-latest
    needs: quality
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 设置 Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: 设置 Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: 获取依赖
        run: flutter pub get

      - name: 验证 Flutter 环境
        run: flutter doctor -v

      - name: 提取版本信息
        id: version
        run: |
          VERSION=$(grep '^version:' pubspec.yaml | sed 's/version: //' | sed 's/+.*//')
          BUILD_NUMBER=$(grep '^version:' pubspec.yaml | sed 's/.*+//')
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          DATE=$(date +'%Y%m%d')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "build_number=$BUILD_NUMBER" >> $GITHUB_OUTPUT
          echo "short_sha=$SHORT_SHA" >> $GITHUB_OUTPUT
          echo "date=$DATE" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"
          echo "Build Number: $BUILD_NUMBER"
          echo "Short SHA: $SHORT_SHA"
          echo "Date: $DATE"

      - name: 构建 Android APK
        run: flutter build apk --release

      - name: 构建 Android App Bundle
        run: flutter build appbundle --release

      - name: 重命名并上传 APK 产物
        run: |
          APK_NAME="musiclab-v${{ steps.version.outputs.version }}-build${{ steps.version.outputs.build_number }}-android-${{ steps.version.outputs.date }}-${{ steps.version.outputs.short_sha }}.apk"
          cp build/app/outputs/flutter-apk/app-release.apk "$APK_NAME"
          echo "APK_NAME=$APK_NAME" >> $GITHUB_ENV
        shell: bash

      - name: 上传 APK 产物
        uses: actions/upload-artifact@v4
        with:
          name: musiclab-android-apk-v${{ steps.version.outputs.version }}-${{ steps.version.outputs.date }}
          path: ${{ env.APK_NAME }}
          retention-days: 30

      - name: 重命名并上传 AAB 产物
        run: |
          AAB_NAME="musiclab-v${{ steps.version.outputs.version }}-build${{ steps.version.outputs.build_number }}-android-${{ steps.version.outputs.date }}-${{ steps.version.outputs.short_sha }}.aab"
          cp build/app/outputs/bundle/release/app-release.aab "$AAB_NAME"
          echo "AAB_NAME=$AAB_NAME" >> $GITHUB_ENV
        shell: bash

      - name: 上传 AAB 产物
        uses: actions/upload-artifact@v4
        with:
          name: musiclab-android-aab-v${{ steps.version.outputs.version }}-${{ steps.version.outputs.date }}
          path: ${{ env.AAB_NAME }}
          retention-days: 30

  # iOS 构建
  # 注意：iOS 构建需要有效的 Apple 开发证书和配置文件
  # 开发阶段允许失败，不会阻塞整个工作流
  build-ios:
    name: Build iOS IPA
    runs-on: macos-latest
    needs: quality
    continue-on-error: true  # 开发阶段允许失败
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 设置 Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: 获取依赖
        run: flutter pub get

      - name: 验证 Flutter 环境
        run: flutter doctor -v

      - name: 安装 CocoaPods 依赖
        working-directory: ios
        run: |
          sudo gem install cocoapods
          pod install

      - name: 提取版本信息
        id: version
        run: |
          VERSION=$(grep '^version:' pubspec.yaml | sed 's/version: //' | sed 's/+.*//')
          BUILD_NUMBER=$(grep '^version:' pubspec.yaml | sed 's/.*+//')
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          DATE=$(date +'%Y%m%d')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "build_number=$BUILD_NUMBER" >> $GITHUB_OUTPUT
          echo "short_sha=$SHORT_SHA" >> $GITHUB_OUTPUT
          echo "date=$DATE" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"
          echo "Build Number: $BUILD_NUMBER"
          echo "Short SHA: $SHORT_SHA"
          echo "Date: $DATE"

      - name: 构建 iOS IPA
        run: flutter build ipa --release
        env:
          # 注意：实际发布时需要配置证书和描述文件
          # 配置步骤：
          # 1. 在 Apple Developer 网站创建 App ID 和证书
          # 2. 在 GitHub Secrets 中配置：
          #    - APPLE_CERTIFICATE_BASE64: Base64 编码的 .p12 证书
          #    - APPLE_CERTIFICATE_PASSWORD: 证书密码
          #    - APPLE_PROVISIONING_PROFILE_BASE64: Base64 编码的 .mobileprovision 文件
          # 3. 在构建步骤中导入证书和配置文件
          # 当前开发阶段：允许构建失败，不阻塞工作流
          CODE_SIGN_IDENTITY: ''
          CODE_SIGNING_REQUIRED: 'NO'

      - name: 重命名并上传 IPA 产物
        if: always()
        run: |
          IPA_FILE=$(find build/ios/ipa -name "*.ipa" | head -1)
          if [ -n "$IPA_FILE" ]; then
            IPA_NAME="musiclab-v${{ steps.version.outputs.version }}-build${{ steps.version.outputs.build_number }}-ios-${{ steps.version.outputs.date }}-${{ steps.version.outputs.short_sha }}.ipa"
            cp "$IPA_FILE" "$IPA_NAME"
            echo "IPA_NAME=$IPA_NAME" >> $GITHUB_ENV
            echo "IPA_PATH=$IPA_NAME" >> $GITHUB_ENV
          else
            echo "IPA_PATH=" >> $GITHUB_ENV
          fi
        shell: bash

      - name: 上传 IPA 产物
        if: always() && env.IPA_PATH != ''
        uses: actions/upload-artifact@v4
        with:
          name: musiclab-ios-ipa-v${{ steps.version.outputs.version }}-${{ steps.version.outputs.date }}
          path: ${{ env.IPA_PATH }}
          retention-days: 30

  # 发布到 GitHub Releases（仅当推送 tag 时）
  # 注意：即使 iOS 构建失败，只要有 Android 构建成功，仍会创建 Release
  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [build-android, build-ios]
    if: startsWith(github.ref, 'refs/tags/v')
    continue-on-error: false  # Release 需要至少 Android 构建成功
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 提取版本信息
        id: version
        run: |
          VERSION=$(grep '^version:' pubspec.yaml | sed 's/version: //' | sed 's/+.*//')
          BUILD_NUMBER=$(grep '^version:' pubspec.yaml | sed 's/.*+//')
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          DATE=$(date +'%Y%m%d')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "build_number=$BUILD_NUMBER" >> $GITHUB_OUTPUT
          echo "short_sha=$SHORT_SHA" >> $GITHUB_OUTPUT
          echo "date=$DATE" >> $GITHUB_OUTPUT

      - name: 下载 Android APK
        uses: actions/download-artifact@v4
        with:
          name: musiclab-android-apk-v${{ steps.version.outputs.version }}-${{ steps.version.outputs.date }}
          path: ./artifacts/android

      - name: 下载 Android AAB
        uses: actions/download-artifact@v4
        with:
          name: musiclab-android-aab-v${{ steps.version.outputs.version }}-${{ steps.version.outputs.date }}
          path: ./artifacts/android

      - name: 下载 iOS IPA
        uses: actions/download-artifact@v4
        with:
          name: musiclab-ios-ipa-v${{ steps.version.outputs.version }}-${{ steps.version.outputs.date }}
          path: ./artifacts/ios
        continue-on-error: true

      - name: 创建 Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            ./artifacts/android/*.apk
            ./artifacts/android/*.aab
            ./artifacts/ios/*.ipa
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ============================================================================
  # 以下平台暂时注释，待需要时再启用
  # ============================================================================

  # # Web 构建
  # build-web:
  #   name: Build Web
  #   runs-on: ubuntu-latest
  #   needs: quality
  #   steps:
  #     - name: 检出代码
  #       uses: actions/checkout@v4
  #
  #     - name: 设置 Flutter
  #       uses: subosito/flutter-action@v2
  #       with:
  #         flutter-version: ${{ env.FLUTTER_VERSION }}
  #         channel: 'stable'
  #         cache: true
  #
  #     - name: 获取依赖
  #       run: flutter pub get
  #
  #     - name: 构建 Web
  #       run: flutter build web --release
  #
  #     - name: 上传 Web 产物
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: web-build
  #         path: build/web
  #         retention-days: 30

  # # Windows 构建
  # build-windows:
  #   name: Build Windows
  #   runs-on: windows-latest
  #   needs: quality
  #   steps:
  #     - name: 检出代码
  #       uses: actions/checkout@v4
  #
  #     - name: 设置 Flutter
  #       uses: subosito/flutter-action@v2
  #       with:
  #         flutter-version: ${{ env.FLUTTER_VERSION }}
  #         channel: 'stable'
  #         cache: true
  #
  #     - name: 获取依赖
  #       run: flutter pub get
  #
  #     - name: 构建 Windows
  #       run: flutter build windows --release
  #
  #     - name: 上传 Windows 产物
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: windows-build
  #         path: build/windows/runner/Release
  #         retention-days: 30

  # # Linux 构建
  # build-linux:
  #   name: Build Linux
  #   runs-on: ubuntu-latest
  #   needs: quality
  #   steps:
  #     - name: 检出代码
  #       uses: actions/checkout@v4
  #
  #     - name: 安装 Linux 依赖
  #       run: |
  #         sudo apt-get update
  #         sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev
  #
  #     - name: 设置 Flutter
  #       uses: subosito/flutter-action@v2
  #       with:
  #         flutter-version: ${{ env.FLUTTER_VERSION }}
  #         channel: 'stable'
  #         cache: true
  #
  #     - name: 获取依赖
  #       run: flutter pub get
  #
  #     - name: 构建 Linux
  #       run: flutter build linux --release
  #
  #     - name: 上传 Linux 产物
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: linux-build
  #         path: build/linux/x64/release/bundle
  #         retention-days: 30

  # # macOS 构建
  # build-macos:
  #   name: Build macOS
  #   runs-on: macos-latest
  #   needs: quality
  #   steps:
  #     - name: 检出代码
  #       uses: actions/checkout@v4
  #
  #     - name: 设置 Flutter
  #       uses: subosito/flutter-action@v2
  #       with:
  #         flutter-version: ${{ env.FLUTTER_VERSION }}
  #         channel: 'stable'
  #         cache: true
  #
  #     - name: 获取依赖
  #       run: flutter pub get
  #
  #     - name: 构建 macOS
  #       run: flutter build macos --release
  #
  #     - name: 上传 macOS 产物
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: macos-build
  #         path: build/macos/Build/Products/Release
  #         retention-days: 30

