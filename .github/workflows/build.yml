name: Build and Release

on:
  push:
    branches:
      - main
      - master
    tags:
      - 'v*'
  pull_request:
    branches:
      - main
      - master
  workflow_dispatch:

env:
  # Flutter 版本 - 可根据项目需要调整
  FLUTTER_VERSION: '3.35.0'

jobs:
  # 代码质量检查
  quality:
    name: Code Quality Check
    runs-on: ubuntu-latest
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 设置 Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: 获取依赖
        run: flutter pub get

      - name: 代码格式检查
        run: dart format --set-exit-if-changed lib/ test/

      - name: 代码分析
        run: flutter analyze

      - name: 运行测试
        run: flutter test --coverage
        continue-on-error: true

  # Android 构建
  build-android:
    name: Build Android APK/AAB
    runs-on: ubuntu-latest
    needs: quality
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 设置 Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '11'

      - name: 设置 Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: 获取依赖
        run: flutter pub get

      - name: 验证 Flutter 环境
        run: flutter doctor -v

      - name: 构建 Android APK
        run: flutter build apk --release

      - name: 构建 Android App Bundle
        run: flutter build appbundle --release

      - name: 上传 APK 产物
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: build/app/outputs/flutter-apk/app-release.apk
          retention-days: 30

      - name: 上传 AAB 产物
        uses: actions/upload-artifact@v4
        with:
          name: android-aab
          path: build/app/outputs/bundle/release/app-release.aab
          retention-days: 30

  # iOS 构建
  build-ios:
    name: Build iOS IPA
    runs-on: macos-latest
    needs: quality
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 设置 Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: 获取依赖
        run: flutter pub get

      - name: 验证 Flutter 环境
        run: flutter doctor -v

      - name: 安装 CocoaPods 依赖
        working-directory: ios
        run: |
          sudo gem install cocoapods
          pod install

      - name: 构建 iOS IPA
        run: flutter build ipa --release
        env:
          # 注意：实际发布时需要配置证书和描述文件
          # 如需自动签名，请在 GitHub Secrets 中配置：
          # - APPLE_CERTIFICATE_BASE64: Base64 编码的 .p12 证书
          # - APPLE_CERTIFICATE_PASSWORD: 证书密码
          # - APPLE_PROVISIONING_PROFILE_BASE64: Base64 编码的 .mobileprovision 文件
          # 然后使用 fastlane match 或其他工具进行签名
          # 当前配置使用自动签名，仅用于 CI 测试
          CODE_SIGN_IDENTITY: ''
          CODE_SIGNING_REQUIRED: 'NO'

      - name: 上传 IPA 产物
        uses: actions/upload-artifact@v4
        with:
          name: ios-ipa
          path: build/ios/ipa/*.ipa
          retention-days: 30
        if: always()

  # 发布到 GitHub Releases（仅当推送 tag 时）
  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [build-android, build-ios]
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - name: 下载 Android APK
        uses: actions/download-artifact@v4
        with:
          name: android-apk
          path: ./artifacts/android

      - name: 下载 Android AAB
        uses: actions/download-artifact@v4
        with:
          name: android-aab
          path: ./artifacts/android

      - name: 下载 iOS IPA
        uses: actions/download-artifact@v4
        with:
          name: ios-ipa
          path: ./artifacts/ios
        continue-on-error: true

      - name: 创建 Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            ./artifacts/android/*.apk
            ./artifacts/android/*.aab
            ./artifacts/ios/*.ipa
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ============================================================================
  # 以下平台暂时注释，待需要时再启用
  # ============================================================================

  # # Web 构建
  # build-web:
  #   name: Build Web
  #   runs-on: ubuntu-latest
  #   needs: quality
  #   steps:
  #     - name: 检出代码
  #       uses: actions/checkout@v4
  #
  #     - name: 设置 Flutter
  #       uses: subosito/flutter-action@v2
  #       with:
  #         flutter-version: ${{ env.FLUTTER_VERSION }}
  #         channel: 'stable'
  #         cache: true
  #
  #     - name: 获取依赖
  #       run: flutter pub get
  #
  #     - name: 构建 Web
  #       run: flutter build web --release
  #
  #     - name: 上传 Web 产物
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: web-build
  #         path: build/web
  #         retention-days: 30

  # # Windows 构建
  # build-windows:
  #   name: Build Windows
  #   runs-on: windows-latest
  #   needs: quality
  #   steps:
  #     - name: 检出代码
  #       uses: actions/checkout@v4
  #
  #     - name: 设置 Flutter
  #       uses: subosito/flutter-action@v2
  #       with:
  #         flutter-version: ${{ env.FLUTTER_VERSION }}
  #         channel: 'stable'
  #         cache: true
  #
  #     - name: 获取依赖
  #       run: flutter pub get
  #
  #     - name: 构建 Windows
  #       run: flutter build windows --release
  #
  #     - name: 上传 Windows 产物
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: windows-build
  #         path: build/windows/runner/Release
  #         retention-days: 30

  # # Linux 构建
  # build-linux:
  #   name: Build Linux
  #   runs-on: ubuntu-latest
  #   needs: quality
  #   steps:
  #     - name: 检出代码
  #       uses: actions/checkout@v4
  #
  #     - name: 安装 Linux 依赖
  #       run: |
  #         sudo apt-get update
  #         sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev
  #
  #     - name: 设置 Flutter
  #       uses: subosito/flutter-action@v2
  #       with:
  #         flutter-version: ${{ env.FLUTTER_VERSION }}
  #         channel: 'stable'
  #         cache: true
  #
  #     - name: 获取依赖
  #       run: flutter pub get
  #
  #     - name: 构建 Linux
  #       run: flutter build linux --release
  #
  #     - name: 上传 Linux 产物
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: linux-build
  #         path: build/linux/x64/release/bundle
  #         retention-days: 30

  # # macOS 构建
  # build-macos:
  #   name: Build macOS
  #   runs-on: macos-latest
  #   needs: quality
  #   steps:
  #     - name: 检出代码
  #       uses: actions/checkout@v4
  #
  #     - name: 设置 Flutter
  #       uses: subosito/flutter-action@v2
  #       with:
  #         flutter-version: ${{ env.FLUTTER_VERSION }}
  #         channel: 'stable'
  #         cache: true
  #
  #     - name: 获取依赖
  #       run: flutter pub get
  #
  #     - name: 构建 macOS
  #       run: flutter build macos --release
  #
  #     - name: 上传 macOS 产物
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: macos-build
  #         path: build/macos/Build/Products/Release
  #         retention-days: 30

