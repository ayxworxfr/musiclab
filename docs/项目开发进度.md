# 乐理通 - 项目开发进度

> 📅 创建时间：2026-01-12  
> 📝 最后更新：2026-01-12

---

## 一、当前进度总览

### 1.1 整体完成度

| 模块 | 完成度 | 状态 |
|------|--------|------|
| 项目架构 | 100% | ✅ 已完成 |
| 核心服务层 | 95% | ✅ 基本完成 |
| UI 框架 | 85% | 🔄 进行中 |
| 音频资源 | 100% | ✅ 已完成 |
| 数据资源 | 100% | ✅ 已完成 |
| 课程功能 | 100% | ✅ 已完成 |
| 练习功能 | 95% | ✅ 基本完成 |
| 工具功能 | 95% | ✅ 基本完成 |
| 个人中心 | 80% | 🔄 进行中 |
| 乐谱系统 | 100% | ✅ 已完成 |

**总体完成度：约 92%**

---

## 二、已完成模块详情

### 2.1 ✅ 项目架构（100%）

- [x] Flutter 项目初始化
- [x] GetX 状态管理配置
- [x] 路由系统（`app_routes.dart`、`app_pages.dart`）
- [x] 依赖注入（`app_binding.dart`）
- [x] 主题系统（亮色/暗色切换）
- [x] 目录结构按功能模块划分

### 2.2 ✅ 核心服务层（85%）

| 服务 | 状态 | 说明 |
|------|------|------|
| `StorageService` | ✅ | Hive + SharedPreferences 封装 |
| `HttpClient` | ✅ | Dio 封装 + 拦截器 |
| `AudioService` | ⚠️ | 框架完成，缺少音频文件 |
| `LoggerUtil` | ✅ | 日志工具 |
| `MusicUtils` | ✅ | MIDI 转换、五线谱位置计算 |

### 2.3 ✅ 通用组件（80%）

| 组件 | 状态 | 说明 |
|------|------|------|
| `PianoKeyboard` | ✅ | 完整的钢琴键盘组件 |
| `StaffWidget` | ✅ | 五线谱渲染组件 |
| `AppButton` | ✅ | 通用按钮 |
| `AppLoading` | ✅ | 加载状态组件 |
| `AppEmpty` | ✅ | 空状态组件 |
| `AppError` | ✅ | 错误状态组件 |

### 2.4 🔄 页面 UI（70%）

| 页面 | 状态 | 说明 |
|------|------|------|
| `SplashPage` | ✅ | 启动页 |
| `OnboardingPage` | ✅ | 引导页（4 页） |
| `MainPage` | ✅ | 底部导航框架 |
| `HomePage` | ⚠️ | UI 完成，数据为 Mock |
| `CourseListPage` | ⚠️ | 基础 UI，无详情功能 |
| `PracticeHomePage` | ⚠️ | 基础 UI，无练习功能 |
| `PianoPage` | ✅ | 虚拟钢琴功能完整 |
| `MetronomePage` | ⚠️ | UI 完成，缺音频文件 |
| `ProfilePage` | ⚠️ | 基础 UI |

---

## 三、待完成模块详情

### 3.1 ✅ 音频资源（100%）

```
assets/audio/
├── piano/           # ✅ 88 个钢琴音 (note_21.mp3 - note_108.mp3)
├── metronome/       # ✅ 节拍器音效 (柔和木质音)
└── effects/         # ✅ 效果音 (4 个)
```

**已完成的音频文件**：
- [x] 钢琴音：`note_21.mp3` 到 `note_108.mp3`（88 个，标准钢琴全音域）
- [x] 节拍器：`click_strong.mp3`、`click_weak.mp3`
- [x] 效果音：`correct.mp3`、`wrong.mp3`、`complete.mp3`、`levelUp.mp3`

**音频生成工具**：`make audio` 可重新生成所有音频文件

### 3.2 🔄 数据资源（70%）

```
assets/data/
├── courses/         # ✅ 简谱入门(10课) + 五线谱入门(15课)
├── questions/       # 需要练习题库 JSON
└── sheets/          # 需要乐谱数据 JSON
```

### 3.3 🔄 课程功能（85%）

- [x] 课程列表页 UI
- [x] 课程数据模型定义 (`CourseModel`, `LessonModel`, `ContentBlock`)
- [x] 课程详情页 (`CourseDetailPage`)
- [x] 课程学习页 (`LessonPage`)，支持以下内容块：
  - [x] 文本/Markdown 渲染
  - [x] 图片展示
  - [x] 音频播放按钮
  - [x] 钢琴键盘互动
  - [x] 小测验功能
  - [x] 节拍器入口
- [x] 课程进度追踪（进度持久化到本地）
- [x] 简谱入门课程内容（10 课）✅
- [x] 五线谱入门课程内容（15 课）✅
- [ ] 钢琴入门课程内容（20 课）

### 3.4 ✅ 练习功能（95%）

- [x] 练习首页 UI（含今日统计数据）
- [x] 练习数据模型定义 (`PracticeQuestion`, `PracticeRecord`, `AnswerRecord`)
- [x] 题目生成器 (`QuestionGenerator`)
- [x] 练习控制器 (`PracticeController`)
- [x] 识谱练习页面 (`NotePracticePage`) - 选择难度 + 答题 + 结果
- [x] 节奏练习 (`RhythmPracticePage`) - 跟拍敲击 + 连击系统 + 评分
- [x] 听音练习 (`EarPracticePage`) - 单音/音程识别
- [x] 弹奏练习 (`PianoPracticePage`) - 虚拟钢琴弹奏
- [x] 练习结果页（内置于各练习页面）
- [x] 练习记录持久化 (`PracticeRepository`)

### 3.5 ✅ 工具功能（95%）

- [x] 虚拟钢琴页面 ✅（88键全音域）
- [x] 钢琴键盘组件 ✅
- [x] 节拍器功能 ✅（音频已完成）
- [x] 乐谱库页面 (`SheetMusicPage`) - 分类筛选、搜索
- [x] 乐谱详情/播放 (`SheetDetailPage`) - 乐谱展示、播放控制
- [x] 音符对照表 (`ReferenceTablePage`) - 简谱/音程/调号对照

### 3.6 ✅ 乐谱系统（90%）- 新增功能

根据产品文档 v2.0 新增的乐谱系统功能：

- [x] 乐谱数据模型增强 (`SheetModel`, `SheetNote`, `SheetMeasure`, `NoteDuration` 等)
- [x] 简谱渲染组件 (`JianpuNotationWidget`) - 支持：
  - 音符数字渲染（1-7，0休止符）
  - 八度点（高音上加点、低音下加点）
  - 时值标记（下划线、延长线）
  - 附点音符
  - 变音记号
  - 歌词显示
  - 指法显示
  - 音符点击交互
- [x] 五线谱渲染组件 (`StaffNotationWidget`) - 支持：
  - 谱号（高音谱号/低音谱号）
  - 调号（升降号显示）
  - 拍号显示
  - 音符渲染（符头、符干、符尾）
  - 休止符
  - 加线
  - 小节线
  - 歌词显示
- [x] 双谱对照显示 (`DualNotationWidget`) - 支持：
  - 仅简谱模式
  - 仅五线谱模式
  - 上下对照（五线谱+简谱）
  - 左右对照
- [x] 键盘联动播放 (`SheetWithPianoWidget`) - 支持：
  - 乐谱+钢琴键盘联动
  - 播放时键盘高亮当前音符
  - 当前音符信息显示（简谱、音名、歌词）
  - 完整播放页面 (`SheetPlayerPage`)
- [x] 乐谱播放控制器 (`SheetPlayerController`) - 支持：
  - 播放/暂停/停止
  - 速度调节（0.5x-2.0x）
  - 循环播放
  - 小节导航
  - 音符高亮同步
- [x] 乐谱详情页增强 (`SheetDetailPage`) - 支持：
  - 进度条显示
  - 播放控制
  - 速度选择
  - 设置面板
- [x] 乐谱导入服务 (`SheetImportService`) - 策略模式设计
- [x] 简谱文本解析器 (`JianpuTextParser`) - 支持：
  - 元数据解析（标题、调号、拍号、速度）
  - 音符解析（1-7, 0休止符）
  - 八度标记（' 高八度，, 低八度）
  - 时值标记（_ 八分，__ 十六分，- 延长）
  - 变音记号（# 升号，b 降号）
  - 附点音符
  - 歌词对齐
- [x] JSON 解析器 (`JsonSheetParser`) - 支持：
  - 完整 SheetModel 格式
  - 字段验证和自动补全
  - 导出功能 (`JsonSheetExporter`)
- [x] MusicXML 解析器 (`MusicXmlParser`) - 支持：
  - score-partwise 格式
  - 调号、拍号、速度解析
  - 音符、休止符、歌词
  - 从 MuseScore/Finale/Sibelius 导入
- [x] 乐谱导入页面 (`SheetImportPage`) - 支持：
  - 三种格式的输入 Tab
  - 示例加载
  - 预览解析结果
  - 格式帮助说明
- [x] 简谱编辑器 - 支持：
  - 编辑器控制器 (`SheetEditorController`)
  - 音符输入键盘（1-7 + 休止符）
  - 时值选择（全音符~十六分音符）
  - 附点、升降号、八度调整
  - 撤销/重做功能（50步）
  - 小节管理（添加/删除）
  - 歌词输入
  - 元数据编辑（标题、调号、拍号、速度）
  - 预览播放
  - 导出为简谱文本/JSON
- [ ] 五线谱编辑器（后续版本）

### 3.7 🔄 个人中心（80%）

- [x] 个人中心页面框架
- [x] 学习统计数据模型 (`LearningStats`, `DailyLearningRecord`)
- [x] 学习统计页面 (`LearningStatsPage`)，包含：
  - 连续学习天数展示
  - 周学习趋势图表
  - 详细数据统计（课时、练习、正确率等）
- [x] 成就系统模型 (`Achievement`, `UserAchievement`)
- [x] 成就页面 (`AchievementsPage`)，包含：
  - 成就进度概览
  - 分类成就展示（学习/练习/连续/技能/特殊）
  - 19 个预定义成就
  - 隐藏成就支持
- [x] 设置页面 (`SettingsPage`)，包含：
  - 深色模式切换
  - 声音设置
  - 数据管理（清除数据）
  - 关于信息
- [x] 个人中心数据仓库 (`ProfileRepository`)
- [x] 个人中心控制器 (`ProfileController`)
- [ ] 数据导出/导入功能

---

## 四、开发计划（分阶段）

### 📌 Phase 1：资源准备（预计 2-3 天）

**目标**：准备音频和数据资源

| 任务 | 优先级 | 预计时间 |
|------|--------|----------|
| 准备钢琴音频文件（至少 C3-C6，36 个） | P0 | 1 天 |
| 准备节拍器音效 | P0 | 0.5 天 |
| 准备效果音 | P1 | 0.5 天 |
| 创建课程数据 JSON（简谱入门前 5 课） | P0 | 1 天 |

**交付物**：
- [ ] `assets/audio/piano/note_48.mp3` - `note_84.mp3`
- [ ] `assets/audio/metronome/click_strong.mp3`、`click_weak.mp3`
- [ ] `assets/audio/effects/correct.mp3`、`wrong.mp3`
- [ ] `assets/data/courses/jianpu_basics.json`

---

### 📌 Phase 2：核心功能 - 课程系统（预计 5-7 天）

**目标**：实现完整的课程学习流程

| 任务 | 优先级 | 预计时间 |
|------|--------|----------|
| 课程数据模型（`CourseModel`、`LessonModel`） | P0 | 0.5 天 |
| 课程 Repository 实现 | P0 | 1 天 |
| 课程详情页 | P0 | 1 天 |
| 课程学习页（图文类型） | P0 | 1.5 天 |
| 课程学习页（互动类型） | P1 | 1.5 天 |
| 课程进度持久化 | P0 | 1 天 |
| 首页数据联动 | P1 | 0.5 天 |

**交付物**：
- [ ] 课程列表 → 详情 → 学习完整流程
- [ ] 简谱入门前 5 课可学习
- [ ] 学习进度可保存和恢复

---

### 📌 Phase 3：核心功能 - 练习系统（预计 7-10 天）

**目标**：实现四种练习类型

| 任务 | 优先级 | 预计时间 |
|------|--------|----------|
| 练习数据模型 | P0 | 0.5 天 |
| 题目生成器（`QuestionGenerator`） | P0 | 1 天 |
| 识谱练习（简谱） | P0 | 2 天 |
| 识谱练习（五线谱） | P1 | 1.5 天 |
| 听音练习 | P1 | 2 天 |
| 节奏练习 | P2 | 2 天 |
| 弹奏练习 | P2 | 2 天 |
| 练习结果页 | P0 | 1 天 |
| 练习记录持久化 | P0 | 0.5 天 |

**交付物**：
- [ ] 4 种练习类型可用
- [ ] 练习结果展示和记录

---

### 📌 Phase 4：工具完善（预计 3-4 天）

**目标**：完善工具箱功能

| 任务 | 优先级 | 预计时间 |
|------|--------|----------|
| 节拍器功能调试（配合音频） | P0 | 1 天 |
| 乐谱库页面 | P1 | 1 天 |
| 乐谱详情/播放 | P1 | 1.5 天 |
| 音符对照表 | P2 | 0.5 天 |

**交付物**：
- [ ] 节拍器可用
- [ ] 乐谱库可浏览和播放

---

### 📌 Phase 5：用户系统（预计 3-4 天）

**目标**：完善个人中心和统计

| 任务 | 优先级 | 预计时间 |
|------|--------|----------|
| 学习统计页（时长、正确率） | P0 | 1.5 天 |
| 成就系统 | P1 | 1.5 天 |
| 设置页面（主题、音效开关） | P0 | 0.5 天 |
| 今日任务系统 | P1 | 0.5 天 |

**交付物**：
- [ ] 学习数据可视化
- [ ] 成就解锁机制

---

### 📌 Phase 6：内容补充（预计 5-7 天）

**目标**：补充完整课程内容

| 任务 | 优先级 | 预计时间 |
|------|--------|----------|
| 简谱入门剩余 5 课 | P0 | 2 天 |
| 五线谱入门 15 课 | P1 | 3 天 |
| 钢琴入门 20 课 | P2 | 5 天 |
| 练习题库扩充 | P1 | 2 天 |

---

### 📌 Phase 7：优化与测试（预计 3-5 天）

**目标**：性能优化和测试

| 任务 | 优先级 | 预计时间 |
|------|--------|----------|
| UI 动画优化 | P1 | 1 天 |
| 音频播放优化 | P0 | 1 天 |
| 单元测试 | P1 | 1.5 天 |
| Widget 测试 | P2 | 1 天 |
| 多平台适配测试 | P0 | 1 天 |

---

## 五、里程碑

| 里程碑 | 目标日期 | 内容 |
|--------|----------|------|
| **M1 - 可运行 Demo** | Phase 1 完成 | 钢琴可发声、节拍器可用 |
| **M2 - 课程 MVP** | Phase 2 完成 | 简谱入门 5 课可学 |
| **M3 - 练习 MVP** | Phase 3 完成 | 识谱练习可用 |
| **M4 - 功能完整** | Phase 5 完成 | 所有功能模块可用 |
| **M5 - 内容完整** | Phase 6 完成 | 45 节课程全部完成 |
| **M6 - 发布版本** | Phase 7 完成 | 测试通过，可发布 |

---

## 六、技术债务

| 问题 | 优先级 | 建议处理时间 |
|------|--------|--------------|
| ~~`Obx` 使用不当（onboarding_page.dart）~~ | ~~P0~~ | ✅ 已修复 |
| 首页数据 Mock，需接入真实数据 | P1 | Phase 2 |
| 课程/练习页面 TODO 未实现 | P0 | Phase 2-3 |
| 音频资源缺失 | P0 | Phase 1 |

---

## 七、开发日志

### 2026-01-12（晚间更新 10）

**五线谱音符位置修复**：

**问题诊断**：
- 五线谱音符显示位置不正确
- `getStaffPosition` 计算逻辑有误
- 中央C (C4) 应该在下加一线，但显示位置偏移

**解决方案**：
1. ✅ 重新设计 `MusicUtils.getStaffPosition()` 算法
   - 以第一线 (E4) 为参考点，position = 0
   - 每个位置代表一个线或间（半个 lineSpacing）
   - 位置映射：E4=0, G4=2, B4=4, D5=6, F5=8
   - 下加一线 C4 = -2
   - 使用绝对位置计算，避免复杂的相对计算

2. ✅ 更新 `_drawNote()` Y坐标计算
   - `firstLineY = startY + 4 * lineSpacing`（第一线Y坐标）
   - `y = firstLineY - position * (lineSpacing / 2)`
   - position 正数向上移动（Y减小）

3. ✅ 修复加线绘制逻辑
   - 下加线：从 position=-2 开始向下画
   - 上加线：从 position=10 开始向上画

**验证**：
| MIDI | 音符 | position | 位置说明 |
|------|------|----------|----------|
| 60 | C4 | -2 | 下加一线 ✓ |
| 64 | E4 | 0 | 第一线 ✓ |
| 67 | G4 | 2 | 第二线 ✓ |
| 71 | B4 | 4 | 第三线 ✓ |
| 74 | D5 | 6 | 第四线 ✓ |
| 77 | F5 | 8 | 第五线 ✓ |

---

### 2026-01-12（晚间更新 4）

**简谱编辑器完成**：
- ✅ 编辑器控制器 (`SheetEditorController`)
  - 完整的状态管理
  - 撤销/重做功能（50步历史）
  - 音符 CRUD 操作
  - 小节管理
- ✅ 编辑器 UI (`JianpuEditorWidget`)
  - 音符输入键盘（1-7 + 休止符）
  - 时值选择器（全音符~十六分音符）
  - 修饰符选择（附点、升降号、八度）
  - 可视化音符编辑
  - 工具栏（撤销/重做/模式切换）
- ✅ 编辑器页面 (`SheetEditorPage`)
  - 新建/编辑乐谱
  - 元数据编辑对话框
  - 歌词输入
  - 预览播放
  - 导出功能（简谱文本/JSON）
  - 帮助说明

**乐谱系统全部完成！**

---

### 2026-01-12（晚间更新 3）

**乐谱导入功能完成**：
- ✅ 创建乐谱导入服务 (`SheetImportService`)
  - 策略模式设计，支持多种格式
  - 自动格式检测
- ✅ 简谱文本解析器 (`JianpuTextParser`)
  - 元数据解析（标题、调号、拍号、速度）
  - 完整的简谱语法支持
  - 歌词自动对齐
- ✅ JSON 解析器 (`JsonSheetParser`)
  - 完整的 SheetModel 格式支持
  - 字段验证和自动补全
  - JSON 导出功能
- ✅ MusicXML 解析器 (`MusicXmlParser`)
  - score-partwise 格式支持
  - 从专业软件（MuseScore/Finale/Sibelius）导入
- ✅ 乐谱导入页面 (`SheetImportPage`)
  - 三种格式的输入界面
  - 示例内容加载
  - 预览解析和错误提示
  - 格式帮助说明

**乐谱系统完成度：100%**

---

### 2026-01-12（晚间更新 2）

**乐谱系统继续开发**：
- ✅ 创建五线谱渲染组件 (`StaffNotationWidget`)
  - 谱号、调号、拍号渲染
  - 音符渲染（符头、符干、符尾、休止符）
  - 加线、小节线
  - 歌词显示
- ✅ 创建双谱对照显示组件 (`DualNotationWidget`)
  - 支持 5 种显示模式
  - 简谱/五线谱切换
  - 上下/左右对照布局
- ✅ 创建键盘联动播放组件 (`SheetWithPianoWidget`)
  - 乐谱+钢琴键盘同屏显示
  - 播放时键盘高亮当前音符
  - 当前音符信息显示
- ✅ 创建完整乐谱播放页面 (`SheetPlayerPage`)
  - 谱式切换菜单
  - 钢琴显示开关
  - 完整播放控制

**乐谱系统完成度：90%**（剩余：导入、编辑器）

---

### 2026-01-12（晚间更新）

**乐谱系统开发**：
- ✅ 重构乐谱数据模型（`sheet_model.dart`）
  - 新增 `NoteDuration` 枚举（全音符到三十二分音符）
  - 新增 `Accidental` 枚举（升降号、还原号）
  - 新增 `Articulation` 枚举（跳音、重音等）
  - 新增 `Dynamics` 枚举（力度记号）
  - 增强 `SheetNote`：支持八度、时值枚举、连音、指法等
  - 增强 `SheetMeasure`：支持反复记号、力度
  - 新增 `SheetMetadata`：调号、拍号、速度、作曲家等
  - 新增 `SheetPlaybackState`：播放状态管理
- ✅ 创建简谱渲染组件 (`JianpuNotationWidget`)
  - 专业简谱渲染（数字、八度点、下划线、延长线）
  - 支持歌词、指法、变音记号显示
  - 音符点击交互
  - 可配置渲染样式 (`JianpuStyle`)
- ✅ 创建乐谱播放控制器 (`SheetPlayerController`)
  - 支持播放/暂停/停止
  - 速度调节（0.5x-2.0x）
  - 循环播放
  - 小节导航（上一小节/下一小节）
  - 音符预览播放
- ✅ 更新乐谱详情页 (`SheetDetailPage`)
  - 使用新的简谱渲染组件
  - 进度条和时间显示
  - 播放控制栏增强
  - 速度选择器
  - 设置面板
- ✅ 更新 `MusicUtils`：新增 `jianpuToMidi` 方法支持调号转换
- ✅ 更新示例乐谱数据使用新的模型格式

---

### 2026-01-12（下午更新）

**音频资源完成**：
- ✅ 生成 88 个钢琴音符文件（MIDI 21-108，A0-C8 标准钢琴全音域）
- ✅ 生成节拍器音效（柔和木质敲击声）
- ✅ 生成效果音（correct/wrong/complete/levelUp）
- ✅ 优化音频生成脚本，使用面向对象设计重构
- ✅ 添加 `make audio` 命令用于重新生成音频

**产品文档更新**：
- ✅ 新增乐谱系统完整设计（6.5 节）
  - 乐谱展示（五线谱/简谱专业渲染要素）
  - 乐谱导入（MusicXML/MIDI/简谱文本/ABC记谱/图片识别）
  - 乐谱编辑器
  - 乐谱播放器
- ✅ 更新数据模型（8.4-8.6 节 乐谱相关模型）
- ✅ 更新技术实现要点（9.2-9.6 节 乐谱渲染技术方案）
- ✅ 更新页面结构（新增乐谱系统模块）
- ✅ 产品文档版本更新为 v2.0

---

### 2026-01-12（上午）

- ✅ 修复 `OnboardingPage` 中 `Obx` 使用不当导致的 GetX 错误
- ✅ 创建项目开发进度文档
- 📝 分析当前代码完成情况，制定开发计划
- ✅ 创建课程数据模型 (`CourseModel`, `LessonModel`, `ContentBlock`)
- ✅ 创建简谱入门前 5 课的 JSON 数据 (`jianpu_basics.json`)
- ✅ 实现课程 Repository (`CourseRepositoryImpl`)
- ✅ 实现课程控制器 (`CourseController`)
- ✅ 实现课程详情页 (`CourseDetailPage`)
- ✅ 实现课时学习页 (`LessonPage`)，支持以下内容块：
  - 文本/Markdown 渲染
  - 图片展示
  - 音频播放按钮
  - 钢琴键盘互动
  - 小测验功能
  - 节拍器入口
- ✅ 更新课程列表页，接入真实数据
- ✅ 配置路由和依赖注入
- ✅ 补充简谱入门剩余 5 课（第 6-10 课）JSON 数据
- ✅ 创建练习数据模型 (`PracticeQuestion`, `PracticeRecord`, `AnswerRecord`, `PracticeStats`)
- ✅ 实现题目生成器 (`QuestionGenerator`)，支持：
  - 识谱练习（简谱/五线谱）
  - 听音练习（单音/音程）
  - 弹奏练习（旋律片段）
- ✅ 实现练习控制器 (`PracticeController`)
- ✅ 实现识谱练习页面 (`NotePracticePage`)，包含：
  - 难度选择界面（入门/初级/中级/高级）
  - 答题界面（播放音频、选择答案）
  - 结果界面（正确率、用时统计）
- ✅ 实现练习首页 (`PracticeHomePage`)，展示四种练习类型入口
- ✅ 配置练习模块路由和依赖注入
- ✅ 实现听音练习页面 (`EarPracticePage`)，支持：
  - 单音辨别（入门/初级）
  - 音程识别（中级/高级）
  - 难度选择、答题、结果展示
- ✅ 实现弹奏练习页面 (`PianoPracticePage`)，支持：
  - 看简谱弹钢琴
  - 实时音符追踪
  - 答案校验和反馈
- ✅ 实现练习记录持久化 (`PracticeRepository`)
- ✅ 更新练习首页显示今日统计数据
- ✅ 实现乐谱库功能 (`SheetMusicPage`、`SheetDetailPage`)，包含：
  - 乐谱数据模型 (`SheetModel`、`SheetMeasure`、`SheetNote`)
  - 分类筛选、搜索功能
  - 乐谱详情展示
  - 乐谱播放功能
  - 5 首示例乐谱（小星星、欢乐颂、茉莉花、C大调音阶、生日快乐）
- ✅ 实现节奏练习页面 (`RhythmPracticePage`)，包含：
  - 4 个难度等级（80-140 BPM）
  - 节拍器可视化
  - 节奏模式显示
  - 敲击检测和评分
  - 连击系统
- ✅ 实现音符对照表页面 (`ReferenceTablePage`)，包含：
  - 简谱对照表（简谱/唱名/音名）
  - 音程对照表（半音数/音程名/示例）
  - 调号对照表（升降号数）
  - 试听功能
- ✅ 优化简谱高低音显示，使用专业的上下加点标记（1̇ 1̣）
- ✅ 实现学习统计系统：
  - 学习统计数据模型 (`LearningStats`, `DailyLearningRecord`)
  - 学习统计页面 (`LearningStatsPage`)
  - 连续学习天数、周趋势图表、详细数据展示
- ✅ 实现成就系统：
  - 成就数据模型 (`Achievement`, `UserAchievement`)
  - 成就页面 (`AchievementsPage`)
  - 19 个预定义成就（学习/练习/连续/技能/特殊）
  - 隐藏成就支持
- ✅ 实现设置页面 (`SettingsPage`)：
  - 深色模式切换
  - 声音设置开关
  - 数据管理（清除所有数据）
  - 版本信息
- ✅ 实现个人中心数据仓库 (`ProfileRepository`)
- ✅ 更新个人中心页面，整合新功能
- ✅ 创建五线谱入门课程 JSON 数据（15 课，877 行）
- ✅ 创建钢琴入门课程 JSON 数据（20 课，1186 行）
- ✅ 更新 `CourseRepository` 加载全部三个课程
- ✅ 修复乐谱系统编译错误（`SheetModel` 结构变更）
- ✅ 添加 `flutter_markdown` 依赖，支持完整的 Markdown 渲染
- ✅ 重构 `LessonPage` 的 `_MarkdownText` 组件，使用 `flutter_markdown`
  - 支持粗体、斜体、列表、表格等完整 Markdown 语法
  - 自定义样式表适配应用主题
  - 支持代码块和引用块渲染
- ✅ 修复节拍器 UI 与音频不同步问题
  - 引入 `_nextBeatIndex` 分离 UI 显示和播放逻辑
  - 修复切换拍号时可能的索引越界
  - 确保节拍器从第一拍正确开始
- ✅ 修复简谱八度标记显示乱码问题
  - 重构 `_AudioNoteButton` 使用可视化圆点代替 Unicode 组合字符
  - 兼容两种格式：`'` (高八度) 和 Unicode `\u0307` (上加点)
  - 支持多八度显示（多个点）

---

## 八、下一步行动

**当前阶段**：Phase 6 进行中，准备进入 Phase 7（乐谱系统开发）

**已完成**：
1. ✅ 课程数据模型和 Repository
2. ✅ 课程详情页和学习页
3. ✅ 首页数据联动
4. ✅ 简谱入门全部 10 课 JSON 数据
5. ✅ 五线谱入门全部 15 课 JSON 数据
6. ✅ 练习数据模型和题目生成器
7. ✅ 识谱练习页面
8. ✅ 听音练习页面
9. ✅ 弹奏练习页面
10. ✅ 节奏练习页面
11. ✅ 练习记录持久化
12. ✅ 乐谱库功能
13. ✅ 音符对照表
14. ✅ 学习统计页面
15. ✅ 成就系统
16. ✅ 设置页面
17. ✅ 音频资源（88个钢琴音 + 节拍器 + 效果音）
18. ✅ 产品文档 v2.0（新增乐谱系统设计）
19. ✅ 乐谱数据模型增强（NoteDuration, Accidental, Dynamics 等枚举）
20. ✅ 简谱渲染组件 (`JianpuNotationWidget`)
21. ✅ 乐谱播放控制器 (`SheetPlayerController`)
22. ✅ 乐谱详情页增强（进度条、速度控制、循环播放）
23. ✅ 五线谱渲染组件 (`StaffNotationWidget`)
24. ✅ 双谱对照显示组件 (`DualNotationWidget`)
25. ✅ 键盘联动播放 (`SheetWithPianoWidget`, `SheetPlayerPage`)
26. ✅ 钢琴入门课程内容（20课）
27. ✅ 乐谱导入服务（简谱文本/JSON/MusicXML）
28. ✅ 乐谱导入页面
29. ✅ 简谱编辑器控制器 (`SheetEditorController`)
30. ✅ 简谱编辑器 UI (`JianpuEditorWidget`)
31. ✅ 简谱编辑器页面 (`SheetEditorPage`)

**下一步（按优先级）**：

| 优先级 | 任务 | 预计时间 |
|--------|------|----------|
| P2 | 数据导出/导入功能 | 2天 |
| P2 | UI 动画优化 | 1天 |
| P2 | 多平台适配测试 | 1天 |
| P3 | 五线谱编辑器 | 5天 |

**音频生成工具**：
- 使用 `make audio` 重新生成所有音频文件
- 脚本位置：`scripts/generate_audio.py`

---

## 八、开发日志

### 2026-01-12（晚间更新 9）

**简谱延音符号低音点对齐修复 + 记谱法切换功能**：

#### 1. 修复简谱延音符号的低音点位置问题
**问题诊断**：
- 二分音符、全音符有延长线（`1— 5—`），延长线在Row中横向扩展
- 低音点是独立的Row，会居中在整个容器宽度，而不是对齐到音符下方
- 导致带延长线的音符，低音点偏离音符中心

**解决方案**：
- 将音符数字、下划线、低音点放入同一个Column中
- 延长线仍在外层Row中，作为独立元素
- 使用`crossAxisAlignment: CrossAxisAlignment.start`确保布局正确

**修复代码结构**：
```
Row (音符主体)
├─ 变音记号 (#/b)
├─ Column (音符+下划线+低音点)
│  ├─ Stack (音符数字+附点)
│  ├─ 下划线（八分、十六分音符）
│  └─ 低音点
└─ 延长线（二分、全音符）
```

#### 2. 新增记谱法切换功能
**功能特性**：
1. ✅ 支持三种记谱法切换
   - 简谱（Jianpu）
   - 五线谱（Staff）
   - 双谱对照（Dual）
2. ✅ 在AppBar添加切换按钮
   - 动态图标（简谱、五线谱、双谱）
   - 点击弹出底部选择器
3. ✅ 所有记谱法支持播放高亮
   - 实时高亮当前演奏的小节和音符
   - 点击音符预览播放

**实现细节**：
- 新增 `NotationType` 枚举
- 新增 `_notationType` 状态管理
- 新增 `_buildNotationWidget` 根据类型渲染对应组件
- 新增 `_showNotationPicker` 底部选择器
- 使用已有的 `StaffNotationWidget` 和 `DualNotationWidget`

### 2026-01-12（晚间更新 8）

**简谱八度点布局优化**：
1. ✅ 修复高音点和低音点的布局问题
   - 将 `SizedBox(height: 12, child: ...)` 改为条件渲染 `if`
   - 只在需要显示点时才渲染容器
   - 使用 `Padding` 精确控制间距（高音点 bottom: 2，低音点 top: 2）
2. ✅ 优化视觉效果
   - 消除不必要的空白空间
   - 音符垂直对齐更整齐
   - 布局更紧凑美观

**修复前后对比**：
- **修复前**：所有音符都有上下各 12px 的固定空白，即使没有八度点
- **修复后**：只有带八度点的音符才有额外间距，布局紧凑

### 2026-01-12（晚间更新 7）

**全面检查所有乐谱数据**：
1. ✅ 系统性检查所有8首乐谱的JSON数据
   - 小星星 ✓ 无问题
   - 生日快乐歌 ✓ 无问题
   - 欢乐颂 ✓ 无问题
   - 铃儿响叮当 ✓ 无问题
   - 茉莉花 ✓ 无问题
   - 致爱丽丝 ✓ 无问题（Am调升降号正确）
   - C大调卡农 ✓ 已修正
   - 两只老虎 ⚠️ 发现并修正错误
2. ✅ 修正《两只老虎》音高错误
   - 第13、15小节的"奇"字音符
   - 从 `{"degree": 7, "octave": -1}` 改为 `{"degree": 7, "octave": 0}`
   - 原因：结尾"真奇怪"旋律是 2 7 1，不是 2 7, 1

**质量保证**：
- 所有乐谱调号与音符匹配
- 八度标记准确无误
- 音符序列符合原曲旋律
- 附点音符显示正确

### 2026-01-12（晚间更新 6）

**卡农乐谱修正和简谱附点优化**：
1. ✅ 修正卡农乐谱数据
   - 将D大调改为C大调（无升降号，更适合初学者）
   - 修正低音声部的八度标记（改为 octave: -1）
   - 重新编写旋律，使其更接近原曲
   - 增加到16个小节，更完整的主题呈现
2. ✅ 优化简谱附点显示位置
   - 附点从音符右下方移至右上方
   - 使用 Stack 和 Positioned 实现精确定位
   - 附点大小从4px改为3px，更精致
3. ✅ 更新相关文档
   - 更新乐谱索引文件标题
   - 更新《乐谱库说明》文档

**修复问题**：
- ✓ 卡农5、6音符音调不准确（原因：八度标记错误）
- ✓ 简谱附点位置显示奇怪（原因：附点在右下方而非右上方）

### 2026-01-12（晚间更新 5）

**乐谱播放进度条拖动功能**：
1. ✅ 在 `SheetPlayerController` 中添加 `seekToProgress` 方法
   - 接受 0.0-1.0 的进度值
   - 计算目标时间并找到最接近的音符
   - 支持播放中拖动跳转
2. ✅ 在 `SheetDetailPage` 中实现进度条拖动交互
   - `onChanged`: 实时跳转到拖动位置
   - `onChangeStart`: 拖动开始时暂停播放
   - `onChangeEnd`: 拖动结束后恢复播放状态
3. ✅ 优化用户体验
   - 拖动流畅，无卡顿
   - 自动暂停/恢复播放
   - 准确跳转到目标位置

**功能特性**：
- 支持任意位置快速定位
- 拖动过程中实时预览位置
- 播放状态智能管理
- 与现有播放控制完美配合

### 2026-01-12（晚间更新 4）

**乐谱库内容完善**：
1. ✅ 修复正则表达式编译错误（简谱文本解析器）
   - 将原始字符串中的单引号转义改用双引号包围
   - 修复 `_isLyricLine` 和 `_tokenize` 方法中的正则表达式
2. ✅ 创建完整的乐谱库数据（8 首经典曲目）
   - 入门级：小星星、生日快乐歌、两只老虎
   - 中级：欢乐颂、铃儿响叮当、茉莉花
   - 进阶：D大调卡农、致爱丽丝
3. ✅ 实现 JSON 格式的乐谱数据文件
   - 包含完整的音符、歌词、指法、元数据
   - 每首曲目都有详细的描述和难度标记
4. ✅ 创建乐谱索引文件 (`sheets_index.json`)
   - 记录所有乐谱的基本信息
   - 便于应用快速加载和筛选
5. ✅ 更新 `SheetMusicController` 以支持动态加载
   - 从 assets 读取 JSON 文件
   - 添加错误处理和日志记录
   - 保留硬编码数据作为降级方案
6. ✅ 创建《乐谱库说明》文档
   - 详细记录每首曲目的信息
   - 提供学习建议和扩展计划
   - 说明数据格式和技术细节

**文件清单**：
- `assets/data/sheets/twinkle_twinkle.json` - 小星星
- `assets/data/sheets/happy_birthday.json` - 生日快乐歌
- `assets/data/sheets/ode_to_joy.json` - 欢乐颂
- `assets/data/sheets/two_tigers.json` - 两只老虎
- `assets/data/sheets/jingle_bells.json` - 铃儿响叮当
- `assets/data/sheets/jasmine_flower.json` - 茉莉花
- `assets/data/sheets/canon_in_d.json` - D大调卡农
- `assets/data/sheets/fur_elise.json` - 致爱丽丝
- `assets/data/sheets/sheets_index.json` - 乐谱索引
- `docs/乐谱库说明.md` - 乐谱库文档

---

*文档维护：持续更新中...*

