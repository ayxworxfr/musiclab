# 乐理通 - 项目开发进度

> 📅 最后更新：2026-01-15

---

## 一、整体进度

| 模块 | 完成度 | 状态 |
|------|--------|------|
| 项目架构 | 100% | ✅ 完成 |
| 核心服务层 | 100% | ✅ 完成 |
| 音频资源 | 100% | ✅ 完成 |
| 课程功能 | 100% | ✅ 完成 |
| 练习功能 | 100% | ✅ 完成 |
| 工具功能 | 95% | ✅ 基本完成 |
| 个人中心 | 90% | ✅ 基本完成 |
| **乐谱系统 v3** | 90% | ✅ 基本完成 |

---

## 二、乐谱系统 Canvas 重构 - 已完成 ✅

### 2.1 重构成果

**架构升级**：
- ✅ 完全基于 Canvas 的统一渲染系统
- ✅ 支持简谱（Jianpu）和五线谱（Grand Staff）双重显示
- ✅ 支持钢琴大谱表（高音谱号 + 低音谱号）
- ✅ 钢琴键盘使用 Canvas 渲染，与乐谱像素级精确对齐
- ✅ 左右手颜色区分（红色右手、蓝色左手）

**核心功能**：
- ✅ 多轨支持（Track）：左手/右手独立轨道
- ✅ Beat-based 时间模型：精确的拍内音符控制
- ✅ 和弦支持：
  - 长时值音符（四分、二分）→ 同时演奏，垂直排列
  - 短时值音符（八分、十六分）→ 顺序演奏，水平排列
- ✅ 自动布局引擎：动态计算音符位置、小节分行
- ✅ 播放同步：音符高亮、播放指示线、钢琴键盘同步
- ✅ 导出功能：
  - PDF 导出（简谱/五线谱）
  - MIDI 导出（支持和弦/顺序演奏）

**数据格式**：
- ✅ 完善的 JSON 格式规范
- ✅ 支持 MIDI pitch 值（21-108）
- ✅ 支持多种时值（whole, half, quarter, eighth, sixteenth）
- ✅ 支持附点、临时变音记号、歌词、连音线

### 2.2 技术亮点

1. **智能演奏逻辑**：
   ```dart
   // 根据 beamCount 自动判断演奏方式
   if (note.duration.beamCount > 0) {
     // 短时值：顺序演奏（如八分音符）
   } else {
     // 长时值：同时演奏（如四分音符和弦）
   }
   ```

2. **三层架构**：
   - 数据层（Score/Track/Measure/Beat/Note）
   - 布局层（LayoutEngine 计算位置和时间）
   - 渲染层（CustomPainter 绘制）

3. **性能优化**：
   - Canvas 渲染，60fps 流畅
   - 自适应布局（根据音符密度调整间距）
   - 增量更新（仅重绘变化部分）

### 2.3 已实现的文件

**核心模型**：
- `lib/features/tools/sheet_music/models/score.dart` - 数据模型
- `lib/features/tools/sheet_music/models/enums.dart` - 枚举定义

**渲染器**：
- `lib/features/tools/sheet_music/painters/jianpu_painter.dart` - 简谱渲染器
- `lib/features/tools/sheet_music/painters/grand_staff_painter.dart` - 五线谱渲染器
- `lib/features/tools/sheet_music/painters/piano_roll_painter.dart` - 钢琴键盘渲染器
- `lib/features/tools/sheet_music/painters/render_config.dart` - 渲染配置

**布局引擎**：
- `lib/features/tools/sheet_music/layout/layout_engine.dart` - 布局计算
- `lib/features/tools/sheet_music/layout/layout_result.dart` - 布局结果

**导出服务**：
- `lib/features/tools/sheet_music/services/export/pdf_exporter.dart` - PDF 导出
- `lib/features/tools/sheet_music/services/export/midi_exporter.dart` - MIDI 导出

**工具类**：
- `lib/features/tools/sheet_music/utils/score_converter.dart` - 格式转换

**文档**：
- `docs/sheet_music_json_format.md` - JSON 格式完整文档

### 2.4 待完成功能（编辑器）

当前版本专注于**播放和导出**，编辑器功能待后续实现：

- ⏳ 简谱编辑器（添加/删除音符）
- ⏳ 五线谱编辑器
- ⏳ 从零创建新乐谱
- ⏳ 修改元数据（调号、拍号、速度）

**说明**：当前有两套数据模型：
- `SheetModel`（简谱风格，用于编辑器）
- `Score`（MIDI 风格，用于播放/渲染）
- 转换器：`ScoreConverter.fromSheetModel()`

---

## 三、已完成模块

### 3.1 课程系统 ✅

- 简谱入门（10课）
- 五线谱入门（15课）
- 钢琴入门（20课）
- 课程详情页、学习页
- 进度持久化

### 3.2 练习系统 ✅

- 识谱练习（简谱/五线谱）
- 节奏练习（跟拍敲击）
- 听音练习（单音/音程）
- 弹奏练习
- 练习记录持久化

### 3.3 工具功能

| 工具 | 状态 |
|------|------|
| 虚拟钢琴 | ✅ 完成 |
| 节拍器 | ✅ 完成 |
| 乐谱播放器 | ✅ 完成（支持简谱/五线谱/和弦） |
| 乐谱导出 | ✅ 完成（PDF/MIDI） |
| 音符对照表 | ✅ 完成 |

### 3.4 个人中心 ✅

- 学习统计页面
- 成就系统（19个成就）
- 设置页面
- 数据持久化

### 3.5 音频资源 ✅

- 88个钢琴音（MIDI 21-108）
- 节拍器音效
- 效果音（correct/wrong/complete/levelUp）

生成命令：`make audio`

---

## 四、里程碑

| 里程碑 | 目标日期 | 内容 | 状态 |
|--------|----------|------|------|
| M1 | - | 可运行 Demo | ✅ |
| M2 | - | 课程 MVP | ✅ |
| M3 | - | 练习系统 | ✅ |
| M4 | - | 功能完整版 | 🔄 |
| M5 | - | 乐谱系统 v3 | 📋 |
| M6 | - | 发布版本 | 📋 |

---

## 五、技术债务

| 问题 | 优先级 | 状态 |
|------|--------|------|
| 简谱编辑器功能有限 | P1 | 📋 待实现 |
| 钢琴键盘不支持滑奏 | P2 | 📋 待实现 |
| 需要统一 SheetModel 和 Score 数据模型 | P2 | 📋 待优化 |

---

## 六、最近更新日志

### 2026-01-15
- ✅ 修复了 16 分音符下划线/符杠显示问题（增加间距到 5px）
- ✅ 实现了和弦与顺序演奏的智能区分（基于 beamCount）
- ✅ 修复了和弦音符排序（按音高从低到高）
- ✅ 更新了 MIDI 导出支持和弦/顺序演奏
- ✅ 更新了 PDF 导出支持和弦显示（简谱/五线谱）
- ✅ 修正了多个内置乐谱的和弦数据（小星星、虫儿飞、卡农、Flower Dance）
- ✅ 编写了完整的 JSON 格式文档（`docs/sheet_music_json_format.md`）

### 2026-01-13
- ✅ 完成乐谱系统 Canvas 重构主体功能
- ✅ 实现简谱和五线谱双重渲染
- ✅ 实现钢琴键盘 Canvas 渲染与同步
- ✅ 实现布局引擎和自动分行
- ✅ 实现 PDF 和 MIDI 导出基础功能

---

## 七、开发命令

```bash
# 运行项目
make run           # Chrome
make run-web       # Web（端口 8080）
make run-ios       # iOS 模拟器
make run-android   # Android

# 音频生成
make audio         # 生成所有音频
make audio-clean   # 清理音频

# 代码质量
make analyze       # 代码分析
make format        # 格式化
make test          # 测试
```

---

## 八、文档索引

| 文档 | 说明 |
|------|------|
| [产品文档](./乐理通产品文档.md) | 产品设计、功能规划 |
| [架构设计](./乐理通应用架构设计文档.md) | 技术架构、代码规范 |
| [乐谱渲染 v3](./乐谱渲染系统设计文档.md) | Canvas 渲染架构 |
| [乐谱 JSON 格式](./sheet_music_json_format.md) | 乐谱数据格式规范 |
| [乐谱库说明](./乐谱库说明.md) | 内置乐谱数据 |

---

*文档维护：持续更新中...*
