# ä¹è°±æ¸²æŸ“ç³»ç»Ÿè®¾è®¡æ–‡æ¡£ v3.0

> **ä¹ç†é€š - Canvas ç»Ÿä¸€æ¸²æŸ“æ¶æ„**
> 
> ç‰ˆæœ¬: v3.0
> 
> ä½œè€…: MusicLab Team
> 
> æ›´æ–°æ—¥æœŸ: 2026-01-13

---

## ç›®å½•

1. [è®¾è®¡ç›®æ ‡](#1-è®¾è®¡ç›®æ ‡)
2. [æ¶æ„æ€»è§ˆ](#2-æ¶æ„æ€»è§ˆ)
3. [æ•°æ®æ¨¡å‹è®¾è®¡](#3-æ•°æ®æ¨¡å‹è®¾è®¡)
4. [Canvas æ¸²æŸ“å¼•æ“](#4-canvas-æ¸²æŸ“å¼•æ“)
5. [å¤§è°±è¡¨æ¸²æŸ“](#5-å¤§è°±è¡¨æ¸²æŸ“)
6. [é’¢ç´é”®ç›˜æ¸²æŸ“](#6-é’¢ç´é”®ç›˜æ¸²æŸ“)
7. [å¸ƒå±€å¼•æ“](#7-å¸ƒå±€å¼•æ“)
8. [äº¤äº’ç³»ç»Ÿ](#8-äº¤äº’ç³»ç»Ÿ)
9. [æ’­æ”¾åŒæ­¥](#9-æ’­æ”¾åŒæ­¥)
10. [å®æ–½è®¡åˆ’](#10-å®æ–½è®¡åˆ’)

---

## 1. è®¾è®¡ç›®æ ‡

### 1.1 æ ¸å¿ƒéœ€æ±‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ç›®æ ‡æ•ˆæœç¤ºæ„                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  ğŸ¼ é«˜éŸ³è°±è¡¨ï¼ˆå³æ‰‹/æ—‹å¾‹ï¼‰                                   â”‚ â”‚
â”‚  â”‚  â”â”â”â”â—â”â”â”â”â—â”â”â”â”â—â”â”â”â”â—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”  â”‚ â”‚
â”‚  â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”  â”‚ â”‚
â”‚  â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”  â”‚ â”‚
â”‚  â”‚    â†‘ å½“å‰æ’­æ”¾ä½ç½®                                          â”‚ â”‚
â”‚  â”‚                                                            â”‚ â”‚
â”‚  â”‚  ğŸ¼ ä½éŸ³è°±è¡¨ï¼ˆå·¦æ‰‹/ä¼´å¥ï¼‰                                   â”‚ â”‚
â”‚  â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”  â”‚ â”‚
â”‚  â”‚  â”â”â”â”â—â”â”â”â”â”â”â”â”â—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”  â”‚ â”‚
â”‚  â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”  â”‚ â”‚
â”‚  â”‚     Ped.        Ped.                                       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  ğŸ¹ é’¢ç´é”®ç›˜ï¼ˆ88é”®ï¼‰                                        â”‚ â”‚
â”‚  â”‚    â”Œâ”€â” â”Œâ”€â”   â”Œâ”€â” â”Œâ”€â” â”Œâ”€â”   â”Œâ”€â” â”Œâ”€â”   â”Œâ”€â” â”Œâ”€â” â”Œâ”€â”       â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”´â”¬â”´â”¬â”´â”€â”¬â”€â”€â”€â”´â”¬â”´â”¬â”´â”¬â”´â”€â”¬â”€â”€â”€â”¬â”€â”´â”¬â”´â”¬â”´â”€â”¬â”€â”€â”€â”´â”¬â”´â”¬â”´â”¬â”´â”€â”¬â”€â”€â”€â”     â”‚ â”‚
â”‚  â”‚  â”‚ğŸ”µâ”‚ â”‚ â”‚ğŸŸ¢ â”‚ â”‚ â”‚ â”‚   â”‚ğŸ”µâ”‚ â”‚ â”‚ğŸŸ¢ â”‚ â”‚ â”‚ â”‚   â”‚     â”‚ â”‚
â”‚  â”‚  â”‚C â”‚Dâ”‚Eâ”‚F  â”‚Gâ”‚Aâ”‚Bâ”‚C' â”‚D'â”‚E'â”‚F'â”‚G'â”‚A'â”‚B'â”‚C''â”‚     â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”´â”€â”´â”€â”´â”€â”€â”€â”´â”€â”´â”€â”´â”€â”´â”€â”€â”€â”´â”€â”€â”´â”€â”´â”€â”€â”´â”€â”€â”€â”´â”€â”€â”´â”€â”´â”€â”€â”´â”€â”€â”€â”˜     â”‚ â”‚
â”‚  â”‚     ğŸ”µ = å³æ‰‹   ğŸŸ¢ = å·¦æ‰‹                               â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                 â”‚
â”‚  â”â”â”â”â”â”â”â”â”â”â”â—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”  01:02 / 02:26      â”‚
â”‚  [â®] [âª] [â–¶ï¸] [â©] [â­]   é€Ÿåº¦: 71   [ğŸ¹ å³æ‰‹] [ğŸ¹ å·¦æ‰‹]       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 è®¾è®¡åŸåˆ™

| åŸåˆ™ | è¯´æ˜ |
|------|------|
| **Canvas ç»Ÿä¸€** | ä¹è°± + é’¢ç´ + äº¤äº’å±‚å…¨éƒ¨ä½¿ç”¨ CustomPainter |
| **åƒç´ ç²¾ç¡®** | éŸ³ç¬¦ä¸é”®ç›˜å‚ç›´å¯¹é½ï¼Œæ— è¯¯å·® |
| **é«˜æ€§èƒ½** | åˆ†å±‚æ¸²æŸ“ï¼Œå±€éƒ¨é‡ç»˜ï¼Œ60fps æµç•… |
| **å¤šè½¨æ”¯æŒ** | åŸç”Ÿæ”¯æŒå·¦å³æ‰‹ã€å¤šå£°éƒ¨ã€ä¼´å¥ |
| **è§¦æ§ä¼˜å…ˆ** | ä¼˜åŒ–ç§»åŠ¨ç«¯å¤šç‚¹è§¦æ§ä½“éªŒ |

### 1.3 åŠŸèƒ½æ¸…å•

| åŠŸèƒ½ | ä¼˜å…ˆçº§ | çŠ¶æ€ |
|------|--------|------|
| å¤§è°±è¡¨æ¸²æŸ“ï¼ˆé«˜éŸ³+ä½éŸ³ï¼‰ | P0 | ğŸ“‹ å¾…å¼€å‘ |
| å¤šè½¨æ•°æ®æ¨¡å‹ | P0 | ğŸ“‹ å¾…å¼€å‘ |
| Canvas é’¢ç´é”®ç›˜ | P0 | ğŸ“‹ å¾…å¼€å‘ |
| å·¦å³æ‰‹é¢œè‰²åŒºåˆ† | P0 | ğŸ“‹ å¾…å¼€å‘ |
| ç¬¦æ åˆ†ç»„æ¸²æŸ“ | P1 | ğŸ“‹ å¾…å¼€å‘ |
| è¿éŸ³çº¿æ¸²æŸ“ | P1 | ğŸ“‹ å¾…å¼€å‘ |
| è¸æ¿è®°å· | P1 | ğŸ“‹ å¾…å¼€å‘ |
| è‡ªåŠ¨æ»šåŠ¨ | P1 | ğŸ“‹ å¾…å¼€å‘ |
| åˆ†æ‰‹ç»ƒä¹ æ¨¡å¼ | P2 | ğŸ“‹ å¾…å¼€å‘ |

---

## 2. æ¶æ„æ€»è§ˆ

### 2.1 åˆ†å±‚æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           Widget å±‚                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                  SheetMusicView (StatefulWidget)               â”‚  â”‚
â”‚  â”‚  â€¢ æ¥æ”¶ SheetModel æ•°æ®                                        â”‚  â”‚
â”‚  â”‚  â€¢ ç®¡ç†æ»šåŠ¨å’Œç¼©æ”¾                                               â”‚  â”‚
â”‚  â”‚  â€¢ å¤„ç†æ‰‹åŠ¿äº‹ä»¶                                                 â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                        Canvas æ¸²æŸ“å±‚                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ GrandStaffPainterâ”‚  â”‚ PianoKeyPainter â”‚  â”‚ OverlayPainter  â”‚     â”‚
â”‚  â”‚   å¤§è°±è¡¨æ¸²æŸ“     â”‚  â”‚   é’¢ç´é”®ç›˜      â”‚  â”‚  é«˜äº®/è¿›åº¦      â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚           â”‚                    â”‚                    â”‚               â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                                â–¼                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                    SharedRenderContext                         â”‚  â”‚
â”‚  â”‚  â€¢ ç»Ÿä¸€åæ ‡ç³»ç»Ÿ                                                 â”‚  â”‚
â”‚  â”‚  â€¢ å…±äº«å¸ƒå±€ç¼“å­˜                                                 â”‚  â”‚
â”‚  â”‚  â€¢ éŸ³ç¬¦ â†” é”®ç›˜ ä½ç½®æ˜ å°„                                        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                           å¸ƒå±€å¼•æ“                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  LayoutEngine   â”‚  â”‚ BeamCalculator  â”‚  â”‚  TieCalculator  â”‚     â”‚
â”‚  â”‚   å¸ƒå±€è®¡ç®—      â”‚  â”‚   ç¬¦æ åˆ†ç»„      â”‚  â”‚   è¿éŸ³çº¿è®¡ç®—    â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                           æ•°æ®æ¨¡å‹å±‚                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   Score â†’ Track â†’ Measure â†’ Beat â†’ Note                       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 ç›®å½•ç»“æ„

```
lib/features/tools/sheet_music/
â”œâ”€â”€ models/                           # æ•°æ®æ¨¡å‹
â”‚   â”œâ”€â”€ score.dart                   # ä¹è°±æ€»è°±
â”‚   â”œâ”€â”€ track.dart                   # å£°éƒ¨/è½¨é“
â”‚   â”œâ”€â”€ measure.dart                 # å°èŠ‚
â”‚   â”œâ”€â”€ beat.dart                    # æ‹
â”‚   â”œâ”€â”€ note.dart                    # éŸ³ç¬¦
â”‚   â””â”€â”€ enums.dart                   # æšä¸¾å®šä¹‰
â”‚
â”œâ”€â”€ layout/                          # å¸ƒå±€å¼•æ“
â”‚   â”œâ”€â”€ layout_engine.dart           # ä¸»å¸ƒå±€è®¡ç®—
â”‚   â”œâ”€â”€ layout_result.dart           # å¸ƒå±€ç»“æœæ•°æ®
â”‚   â”œâ”€â”€ beam_calculator.dart         # ç¬¦æ åˆ†ç»„
â”‚   â”œâ”€â”€ tie_calculator.dart          # è¿éŸ³çº¿è®¡ç®—
â”‚   â””â”€â”€ spacing.dart                 # é—´è·ç®—æ³•
â”‚
â”œâ”€â”€ painters/                        # Canvas æ¸²æŸ“å™¨
â”‚   â”œâ”€â”€ base_painter.dart            # æ¸²æŸ“å™¨åŸºç±»
â”‚   â”œâ”€â”€ grand_staff_painter.dart     # å¤§è°±è¡¨æ¸²æŸ“
â”‚   â”œâ”€â”€ treble_staff_painter.dart    # é«˜éŸ³è°±è¡¨
â”‚   â”œâ”€â”€ bass_staff_painter.dart      # ä½éŸ³è°±è¡¨
â”‚   â”œâ”€â”€ piano_keyboard_painter.dart  # é’¢ç´é”®ç›˜
â”‚   â”œâ”€â”€ overlay_painter.dart         # é«˜äº®/è¿›åº¦è¦†ç›–å±‚
â”‚   â””â”€â”€ components/                  # æ¸²æŸ“ç»„ä»¶
â”‚       â”œâ”€â”€ clef_renderer.dart       # è°±å·
â”‚       â”œâ”€â”€ note_renderer.dart       # éŸ³ç¬¦
â”‚       â”œâ”€â”€ beam_renderer.dart       # ç¬¦æ 
â”‚       â”œâ”€â”€ tie_renderer.dart        # è¿éŸ³çº¿
â”‚       â””â”€â”€ dynamics_renderer.dart   # åŠ›åº¦è®°å·
â”‚
â”œâ”€â”€ widgets/                         # Widget å°è£…
â”‚   â”œâ”€â”€ sheet_music_view.dart        # ä¸»è§†å›¾
â”‚   â””â”€â”€ sheet_player_view.dart       # æ’­æ”¾è§†å›¾ï¼ˆå«é’¢ç´ï¼‰
â”‚
â”œâ”€â”€ controllers/                     # æ§åˆ¶å™¨
â”‚   â”œâ”€â”€ playback_controller.dart     # æ’­æ”¾æ§åˆ¶
â”‚   â””â”€â”€ interaction_controller.dart  # äº¤äº’æ§åˆ¶
â”‚
â””â”€â”€ services/                        # æœåŠ¡å±‚
    â””â”€â”€ import/                      # å¯¼å…¥è§£æ
        â”œâ”€â”€ import_service.dart
        â””â”€â”€ parsers/
```

---

## 3. æ•°æ®æ¨¡å‹è®¾è®¡

### 3.1 æ ¸å¿ƒæ¨¡å‹

```dart
/// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
/// æ€»è°± (Score) - ä¸€é¦–å®Œæ•´çš„ä¹æ›²
/// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
class Score {
  final String id;
  final String title;
  final String? subtitle;
  final String? composer;
  final String? arranger;
  
  /// å…ƒæ•°æ®
  final ScoreMetadata metadata;
  
  /// è½¨é“åˆ—è¡¨ï¼ˆè‡³å°‘ä¸€ä¸ªï¼Œé’¢ç´é€šå¸¸ä¸¤ä¸ªï¼‰
  final List<Track> tracks;
  
  /// æ˜¯å¦ä¸ºå¤§è°±è¡¨ï¼ˆé’¢ç´åŒæ‰‹è°±ï¼‰
  bool get isGrandStaff => tracks.length >= 2 && 
      tracks.any((t) => t.hand == Hand.right) &&
      tracks.any((t) => t.hand == Hand.left);
  
  /// è·å–å³æ‰‹è½¨é“
  Track? get rightHandTrack => tracks.firstWhereOrNull((t) => t.hand == Hand.right);
  
  /// è·å–å·¦æ‰‹è½¨é“
  Track? get leftHandTrack => tracks.firstWhereOrNull((t) => t.hand == Hand.left);
  
  /// æ€»å°èŠ‚æ•°
  int get measureCount => tracks.isEmpty ? 0 : tracks.first.measures.length;
  
  /// æ€»æ—¶é•¿ï¼ˆç§’ï¼‰
  double get totalDuration {
    final totalBeats = measureCount * metadata.beatsPerMeasure;
    return totalBeats * 60 / metadata.tempo;
  }
}

/// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
/// ä¹è°±å…ƒæ•°æ®
/// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
class ScoreMetadata {
  /// è°ƒå· (C, G, D, F, Bb, etc.)
  final Key key;
  
  /// æ‹å·åˆ†å­ï¼ˆæ¯å°èŠ‚æ‹æ•°ï¼‰
  final int beatsPerMeasure;
  
  /// æ‹å·åˆ†æ¯ï¼ˆä»¥å‡ åˆ†éŸ³ç¬¦ä¸ºä¸€æ‹ï¼‰
  final int beatUnit;
  
  /// é€Ÿåº¦ BPM
  final int tempo;
  
  /// é€Ÿåº¦æœ¯è¯­
  final String? tempoText;
  
  /// éš¾åº¦ (1-5)
  final int difficulty;
  
  /// åˆ†ç±»
  final Category category;
  
  /// æ ‡ç­¾
  final List<String> tags;
  
  String get timeSignature => '$beatsPerMeasure/$beatUnit';
}

/// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
/// è½¨é“ (Track) - ä¸€ä¸ªå£°éƒ¨
/// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
class Track {
  final String id;
  final String name;
  
  /// è°±å·
  final Clef clef;
  
  /// æ‰‹ï¼ˆé’¢ç´ç”¨ï¼‰
  final Hand? hand;
  
  /// å°èŠ‚åˆ—è¡¨
  final List<Measure> measures;
  
  /// éŸ³è‰²
  final Instrument instrument;
  
  /// æ˜¯å¦é™éŸ³
  final bool isMuted;
  
  /// éŸ³é‡ (0.0 - 1.0)
  final double volume;
}

/// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
/// å°èŠ‚ (Measure)
/// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
class Measure {
  final int number;
  
  /// æ‹åˆ—è¡¨
  final List<Beat> beats;
  
  /// åå¤è®°å·
  final RepeatSign? repeatSign;
  
  /// æˆ¿å­æ ‡è®° (1, 2)
  final int? ending;
  
  /// å°èŠ‚åŠ›åº¦
  final Dynamic? dynamic;
  
  /// è¸æ¿ï¼ˆèµ·/æ­¢ï¼‰
  final PedalMark? pedal;
  
  /// è·å–æ‰€æœ‰éŸ³ç¬¦ï¼ˆæ‰å¹³åŒ–ï¼‰
  List<Note> get allNotes => beats.expand((b) => b.notes).toList();
}

/// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
/// æ‹ (Beat) - æ—¶é—´å¯¹é½çš„åŸºæœ¬å•ä½
/// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
class Beat {
  /// æ‹ç´¢å¼•ï¼ˆå°èŠ‚å†…ç¬¬å‡ æ‹ï¼Œä»0å¼€å§‹ï¼‰
  final int index;
  
  /// éŸ³ç¬¦åˆ—è¡¨ï¼ˆå¯ä»¥å¤šä¸ªéŸ³ç¬¦å½¢æˆå’Œå¼¦ï¼‰
  final List<Note> notes;
  
  /// æ˜¯å¦ä¸ºä¼‘æ­¢
  bool get isRest => notes.isEmpty || notes.every((n) => n.isRest);
}

/// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
/// éŸ³ç¬¦ (Note)
/// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
class Note {
  /// éŸ³é«˜ (MIDI number, 21-108)
  final int pitch;
  
  /// æ—¶å€¼
  final Duration duration;
  
  /// ä¸´æ—¶å˜éŸ³è®°å·
  final Accidental? accidental;
  
  /// é™„ç‚¹æ•°é‡ (0, 1, 2)
  final int dots;
  
  /// æŒ‡æ³• (1-5)
  final int? fingering;
  
  /// æ­Œè¯
  final String? lyric;
  
  /// å¥æ³•
  final Articulation? articulation;
  
  /// è¿éŸ³çº¿èµ·å§‹
  final bool tieStart;
  
  /// è¿éŸ³çº¿ç»“æŸ
  final bool tieEnd;
  
  /// æ˜¯å¦ä¸ºä¼‘æ­¢ç¬¦
  bool get isRest => pitch == 0;
  
  /// å®é™…æ‹æ•°ï¼ˆè€ƒè™‘é™„ç‚¹ï¼‰
  double get actualBeats {
    var beats = duration.beats;
    for (var i = 0; i < dots; i++) {
      beats *= 1.5;
    }
    return beats;
  }
  
  /// è·å–ç®€è°±æ•°å­— (1-7, 0=ä¼‘æ­¢)
  int get jianpuDegree => isRest ? 0 : MusicUtils.midiToJianpuDegree(pitch);
  
  /// è·å–å…«åº¦åç§» (ç›¸å¯¹äºä¸­å¤®Cæ‰€åœ¨å…«åº¦)
  int get octaveOffset => isRest ? 0 : MusicUtils.midiToOctaveOffset(pitch);
  
  /// è·å–éŸ³å (C, D, E...)
  String get noteName => isRest ? 'R' : MusicUtils.midiToNoteName(pitch);
}
```

### 3.2 æšä¸¾å®šä¹‰

```dart
/// è°±å·
enum Clef {
  treble('ğ„', 'Gè°±å·'),    // é«˜éŸ³è°±å·
  bass('ğ„¢', 'Fè°±å·'),      // ä½éŸ³è°±å·
  alto('ğ„¡', 'Cè°±å·'),      // ä¸­éŸ³è°±å·
  tenor('ğ„¡', 'æ¬¡ä¸­éŸ³è°±å·'); // æ¬¡ä¸­éŸ³è°±å·
  
  final String symbol;
  final String name;
  const Clef(this.symbol, this.name);
}

/// æ‰‹
enum Hand {
  right('å³æ‰‹', Color(0xFF2196F3)),  // è“è‰²
  left('å·¦æ‰‹', Color(0xFF4CAF50)),   // ç»¿è‰²
  both('åŒæ‰‹', Color(0xFF9C27B0));   // ç´«è‰²
  
  final String label;
  final Color color;
  const Hand(this.label, this.color);
}

/// æ—¶å€¼
enum Duration {
  whole(4.0, 'ğ…'),
  half(2.0, 'ğ…—ğ…¥'),
  quarter(1.0, 'â™©'),
  eighth(0.5, 'â™ª'),
  sixteenth(0.25, 'ğ…˜ğ…¥ğ…¯'),
  thirtySecond(0.125, 'ğ…˜ğ…¥ğ…°');
  
  final double beats;
  final String symbol;
  const Duration(this.beats, this.symbol);
  
  /// ç¬¦æ æ•°é‡ (å…«åˆ†=1, åå…­åˆ†=2, ä¸‰åäºŒåˆ†=3)
  int get beamCount => switch (this) {
    Duration.eighth => 1,
    Duration.sixteenth => 2,
    Duration.thirtySecond => 3,
    _ => 0,
  };
}

/// è°ƒå·
enum Key {
  C(0, 'Cå¤§è°ƒ'),
  G(1, 'Gå¤§è°ƒ'),
  D(2, 'Då¤§è°ƒ'),
  A(3, 'Aå¤§è°ƒ'),
  E(4, 'Eå¤§è°ƒ'),
  B(5, 'Bå¤§è°ƒ'),
  Fs(6, 'F#å¤§è°ƒ'),
  Cs(7, 'C#å¤§è°ƒ'),
  F(-1, 'Få¤§è°ƒ'),
  Bb(-2, 'Bbå¤§è°ƒ'),
  Eb(-3, 'Ebå¤§è°ƒ'),
  Ab(-4, 'Abå¤§è°ƒ'),
  Db(-5, 'Dbå¤§è°ƒ'),
  Gb(-6, 'Gbå¤§è°ƒ'),
  Cb(-7, 'Cbå¤§è°ƒ'),
  // å°è°ƒ
  Am(0, 'Aå°è°ƒ', isMinor: true),
  Em(1, 'Eå°è°ƒ', isMinor: true),
  // ... æ›´å¤šå°è°ƒ
  ;
  
  final int sharpsOrFlats; // æ­£æ•°=å‡å·æ•°ï¼Œè´Ÿæ•°=é™å·æ•°
  final String name;
  final bool isMinor;
  
  const Key(this.sharpsOrFlats, this.name, {this.isMinor = false});
  
  bool get hasSharps => sharpsOrFlats > 0;
  bool get hasFlats => sharpsOrFlats < 0;
  int get signatureCount => sharpsOrFlats.abs();
}

/// åŠ›åº¦è®°å·
enum Dynamic {
  ppp(0.2), pp(0.3), p(0.4), mp(0.5), 
  mf(0.6), f(0.7), ff(0.85), fff(1.0),
  sfz(0.9), fp(0.7);
  
  final double velocity;
  const Dynamic(this.velocity);
}

/// è¸æ¿è®°å·
enum PedalMark {
  start('Ped.'),
  end('*'),
  change('Ped.*');
  
  final String symbol;
  const PedalMark(this.symbol);
}

/// åˆ†ç±»
enum Category {
  children('å„¿æ­Œ', 'ğŸ’'),
  folk('æ°‘æ­Œ', 'ğŸ®'),
  pop('æµè¡Œ', 'ğŸ¤'),
  classical('å¤å…¸', 'ğŸ»'),
  exercise('ç»ƒä¹ æ›²', 'ğŸ“');
  
  final String label;
  final String emoji;
  const Category(this.label, this.emoji);
}
```

### 3.3 JSON æ ¼å¼ç¤ºä¾‹

```json
{
  "id": "canon_in_c",
  "title": "Cå¤§è°ƒå¡å†œ",
  "composer": "å¸•èµ«è´å°”",
  "metadata": {
    "key": "C",
    "beatsPerMeasure": 4,
    "beatUnit": 4,
    "tempo": 60,
    "tempoText": "Andante",
    "difficulty": 3,
    "category": "classical"
  },
  "tracks": [
    {
      "id": "right_hand",
      "name": "å³æ‰‹",
      "clef": "treble",
      "hand": "right",
      "measures": [
        {
          "number": 1,
          "beats": [
            { "index": 0, "notes": [{ "pitch": 72, "duration": "quarter" }] },
            { "index": 1, "notes": [{ "pitch": 71, "duration": "quarter" }] },
            { "index": 2, "notes": [{ "pitch": 69, "duration": "quarter" }] },
            { "index": 3, "notes": [{ "pitch": 67, "duration": "quarter" }] }
          ]
        }
      ]
    },
    {
      "id": "left_hand",
      "name": "å·¦æ‰‹",
      "clef": "bass",
      "hand": "left",
      "measures": [
        {
          "number": 1,
          "pedal": "start",
          "beats": [
            { "index": 0, "notes": [{ "pitch": 48, "duration": "half" }] },
            { "index": 2, "notes": [{ "pitch": 43, "duration": "half" }] }
          ]
        }
      ]
    }
  ]
}
```

---

## 4. Canvas æ¸²æŸ“å¼•æ“

### 4.1 æ¸²æŸ“ä¸Šä¸‹æ–‡

```dart
/// å…±äº«æ¸²æŸ“ä¸Šä¸‹æ–‡ - æ‰€æœ‰ Painter å…±ç”¨
class RenderContext {
  /// å¯ç”¨å®½åº¦
  final double width;
  
  /// é…ç½®
  final RenderConfig config;
  
  /// å¸ƒå±€ç»“æœï¼ˆç¼“å­˜ï¼‰
  final LayoutResult layout;
  
  /// å½“å‰æ’­æ”¾çŠ¶æ€
  final PlaybackState? playbackState;
  
  /// ä¸»é¢˜é¢œè‰²
  final ThemeColors colors;
}

/// æ¸²æŸ“é…ç½®
class RenderConfig {
  /// çº¿é—´è·ï¼ˆäº”çº¿è°±ï¼‰
  final double lineSpacing;
  
  /// å°èŠ‚æœ€å°å®½åº¦
  final double minMeasureWidth;
  
  /// è¾¹è·
  final EdgeInsets padding;
  
  /// æ˜¯å¦æ˜¾ç¤ºæ­Œè¯
  final bool showLyrics;
  
  /// æ˜¯å¦æ˜¾ç¤ºæŒ‡æ³•
  final bool showFingering;
  
  /// æ˜¯å¦æ˜¾ç¤ºå°èŠ‚å·
  final bool showMeasureNumbers;
  
  /// é’¢ç´é”®ç›˜é«˜åº¦
  final double pianoHeight;
  
  /// è°±è¡¨é—´è·
  final double staffGap;
  
  const RenderConfig({
    this.lineSpacing = 10.0,
    this.minMeasureWidth = 80.0,
    this.padding = const EdgeInsets.all(16),
    this.showLyrics = true,
    this.showFingering = true,
    this.showMeasureNumbers = true,
    this.pianoHeight = 120.0,
    this.staffGap = 60.0,
  });
}

/// ä¸»é¢˜é¢œè‰²
class ThemeColors {
  final Color staffLine;
  final Color noteDefault;
  final Color noteRightHand;
  final Color noteLeftHand;
  final Color highlight;
  final Color lyric;
  final Color pianoWhiteKey;
  final Color pianoBlackKey;
  final Color pianoHighlightRight;
  final Color pianoHighlightLeft;
  
  const ThemeColors.light() : 
    staffLine = const Color(0xFF333333),
    noteDefault = const Color(0xFF000000),
    noteRightHand = const Color(0xFF2196F3),
    noteLeftHand = const Color(0xFF4CAF50),
    highlight = const Color(0xFFFF9800),
    lyric = const Color(0xFF666666),
    pianoWhiteKey = const Color(0xFFFFFFFF),
    pianoBlackKey = const Color(0xFF222222),
    pianoHighlightRight = const Color(0xFF2196F3),
    pianoHighlightLeft = const Color(0xFF4CAF50);
    
  const ThemeColors.dark() :
    staffLine = const Color(0xFFCCCCCC),
    noteDefault = const Color(0xFFFFFFFF),
    noteRightHand = const Color(0xFF64B5F6),
    noteLeftHand = const Color(0xFF81C784),
    highlight = const Color(0xFFFFB74D),
    lyric = const Color(0xFFAAAAAA),
    pianoWhiteKey = const Color(0xFFE0E0E0),
    pianoBlackKey = const Color(0xFF333333),
    pianoHighlightRight = const Color(0xFF64B5F6),
    pianoHighlightLeft = const Color(0xFF81C784);
}
```

### 4.2 åŸºç¡€æ¸²æŸ“å™¨

```dart
/// æ¸²æŸ“å™¨åŸºç±»
abstract class BasePainter extends CustomPainter {
  final RenderContext context;
  
  BasePainter(this.context);
  
  /// ç»˜åˆ¶æ–‡æœ¬
  void drawText(
    Canvas canvas,
    String text,
    Offset position, {
    double fontSize = 14,
    Color? color,
    FontWeight fontWeight = FontWeight.normal,
    TextAlign align = TextAlign.left,
  }) {
    final textPainter = TextPainter(
      text: TextSpan(
        text: text,
        style: TextStyle(
          fontSize: fontSize,
          color: color ?? context.colors.noteDefault,
          fontWeight: fontWeight,
        ),
      ),
      textDirection: TextDirection.ltr,
      textAlign: align,
    )..layout();
    
    var offset = position;
    if (align == TextAlign.center) {
      offset = Offset(position.dx - textPainter.width / 2, position.dy);
    } else if (align == TextAlign.right) {
      offset = Offset(position.dx - textPainter.width, position.dy);
    }
    
    textPainter.paint(canvas, offset);
  }
  
  /// ç»˜åˆ¶è´å¡å°”æ›²çº¿
  void drawSlur(Canvas canvas, Offset start, Offset end, {
    bool curveUp = true,
    Color? color,
    double strokeWidth = 1.5,
  }) {
    final midX = (start.dx + end.dx) / 2;
    final curveHeight = (end.dx - start.dx) * 0.15;
    final controlY = curveUp 
        ? min(start.dy, end.dy) - curveHeight
        : max(start.dy, end.dy) + curveHeight;
    
    final path = Path()
      ..moveTo(start.dx, start.dy)
      ..quadraticBezierTo(midX, controlY, end.dx, end.dy);
    
    canvas.drawPath(
      path,
      Paint()
        ..color = color ?? context.colors.noteDefault
        ..style = PaintingStyle.stroke
        ..strokeWidth = strokeWidth
        ..strokeCap = StrokeCap.round,
    );
  }
}
```

---

## 5. å¤§è°±è¡¨æ¸²æŸ“

### 5.1 å¤§è°±è¡¨å¸ƒå±€

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         å¤§è°±è¡¨ç»“æ„                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  â”Œâ”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ â”‚ â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”  â”‚   â”‚
â”‚  â”‚ â”‚ â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”  â”‚   â”‚
â”‚  â”‚èŠ±â”‚ â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”  â”‚   â”‚
â”‚  â”‚æ‹¬â”‚ â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”  â”‚   â”‚
â”‚  â”‚å·â”‚ â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”  â”‚   â”‚
â”‚  â”‚ â”‚ â”‚                   é«˜éŸ³è°±è¡¨ (å³æ‰‹)                      â”‚   â”‚
â”‚  â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”‚ â”‚                                                           â”‚
â”‚  â”‚ â”‚              staffGap (è°±è¡¨é—´è·)                           â”‚
â”‚  â”‚ â”‚                                                           â”‚
â”‚  â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ â”‚ â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”  â”‚   â”‚
â”‚  â”‚ â”‚ â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”  â”‚   â”‚
â”‚  â”‚ â”‚ â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”  â”‚   â”‚
â”‚  â”‚ â”‚ â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”  â”‚   â”‚
â”‚  â”‚ â”‚ â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”  â”‚   â”‚
â”‚  â”‚ â”‚ â”‚                   ä½éŸ³è°±è¡¨ (å·¦æ‰‹)                      â”‚   â”‚
â”‚  â””â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â”‚       â†‘ èŠ±æ‹¬å·è¿æ¥ä¸¤ä¸ªè°±è¡¨ï¼Œè¡¨ç¤ºé’¢ç´åŒæ‰‹åŒæ—¶æ¼”å¥                    â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 å¤§è°±è¡¨æ¸²æŸ“å™¨

```dart
/// å¤§è°±è¡¨æ¸²æŸ“å™¨
class GrandStaffPainter extends BasePainter {
  final Score score;
  
  GrandStaffPainter(super.context, this.score);
  
  @override
  void paint(Canvas canvas, Size size) {
    final config = context.config;
    final layout = context.layout;
    
    // 1. ç»˜åˆ¶èŠ±æ‹¬å·ï¼ˆBraceï¼‰
    _drawBrace(canvas, layout);
    
    // 2. ç»˜åˆ¶é«˜éŸ³è°±è¡¨
    final trebleY = layout.trebleStaffY;
    _drawStaff(canvas, trebleY, Clef.treble, score.rightHandTrack);
    
    // 3. ç»˜åˆ¶ä½éŸ³è°±è¡¨
    final bassY = layout.bassStaffY;
    _drawStaff(canvas, bassY, Clef.bass, score.leftHandTrack);
    
    // 4. ç»˜åˆ¶è¿æ¥å°èŠ‚çº¿
    _drawConnectedBarLines(canvas, layout);
    
    // 5. ç»˜åˆ¶è¸æ¿è®°å·
    _drawPedalMarks(canvas, layout);
  }
  
  /// ç»˜åˆ¶èŠ±æ‹¬å·
  void _drawBrace(Canvas canvas, LayoutResult layout) {
    final x = context.config.padding.left - 10;
    final topY = layout.trebleStaffY;
    final bottomY = layout.bassStaffY + 4 * context.config.lineSpacing;
    
    // ä½¿ç”¨è´å¡å°”æ›²çº¿ç»˜åˆ¶èŠ±æ‹¬å·
    final path = Path();
    final midY = (topY + bottomY) / 2;
    
    // ä¸ŠåŠéƒ¨åˆ†
    path.moveTo(x, topY);
    path.cubicTo(x - 15, topY + 20, x - 15, midY - 10, x - 5, midY);
    
    // ä¸‹åŠéƒ¨åˆ†
    path.cubicTo(x - 15, midY + 10, x - 15, bottomY - 20, x, bottomY);
    
    canvas.drawPath(
      path,
      Paint()
        ..color = context.colors.staffLine
        ..style = PaintingStyle.stroke
        ..strokeWidth = 3,
    );
  }
  
  /// ç»˜åˆ¶å•ä¸ªè°±è¡¨
  void _drawStaff(Canvas canvas, double y, Clef clef, Track? track) {
    if (track == null) return;
    
    final lineSpacing = context.config.lineSpacing;
    final width = context.width - context.config.padding.horizontal;
    final startX = context.config.padding.left;
    
    // ç»˜åˆ¶äº”æ¡çº¿
    final linePaint = Paint()
      ..color = context.colors.staffLine
      ..strokeWidth = 1;
    
    for (var i = 0; i < 5; i++) {
      final lineY = y + i * lineSpacing;
      canvas.drawLine(
        Offset(startX, lineY),
        Offset(startX + width, lineY),
        linePaint,
      );
    }
    
    // ç»˜åˆ¶è°±å·
    _drawClef(canvas, startX, y, clef);
    
    // ç»˜åˆ¶è°ƒå·ï¼ˆé¦–è¡Œï¼‰
    var currentX = startX + 35;
    currentX = _drawKeySignature(canvas, currentX, y);
    
    // ç»˜åˆ¶æ‹å·ï¼ˆé¦–è¡Œï¼‰
    _drawTimeSignature(canvas, currentX, y);
    currentX += 25;
    
    // ç»˜åˆ¶éŸ³ç¬¦
    _drawNotes(canvas, track, y, currentX);
  }
  
  /// ç»˜åˆ¶éŸ³ç¬¦ï¼ˆå¸¦å·¦/å³æ‰‹é¢œè‰²ï¼‰
  void _drawNotes(Canvas canvas, Track track, double staffY, double startX) {
    final hand = track.hand;
    final color = hand == Hand.right 
        ? context.colors.noteRightHand
        : hand == Hand.left
            ? context.colors.noteLeftHand
            : context.colors.noteDefault;
    
    // ... éŸ³ç¬¦ç»˜åˆ¶é€»è¾‘
  }
  
  @override
  bool shouldRepaint(covariant GrandStaffPainter oldDelegate) {
    return oldDelegate.score != score ||
           oldDelegate.context.playbackState != context.playbackState;
  }
}
```

---

## 6. é’¢ç´é”®ç›˜æ¸²æŸ“

### 6.1 Canvas é’¢ç´é”®ç›˜

```dart
/// Canvas é’¢ç´é”®ç›˜æ¸²æŸ“å™¨
class PianoKeyboardPainter extends BasePainter {
  /// èµ·å§‹ MIDI
  final int startMidi;
  
  /// ç»“æŸ MIDI
  final int endMidi;
  
  /// é«˜äº®çš„éŸ³ç¬¦ (MIDI -> Hand)
  final Map<int, Hand> highlightedNotes;
  
  /// æŒ‰ä¸‹çš„éŸ³ç¬¦
  final Set<int> pressedNotes;
  
  /// å¸ƒå±€ç¼“å­˜
  late final List<_KeyLayout> _whiteKeyLayouts;
  late final List<_KeyLayout> _blackKeyLayouts;
  
  PianoKeyboardPainter(
    super.context, {
    this.startMidi = 36,  // C2
    this.endMidi = 96,    // C7
    this.highlightedNotes = const {},
    this.pressedNotes = const {},
  }) {
    _calculateKeyLayouts();
  }
  
  @override
  void paint(Canvas canvas, Size size) {
    // 1. ç»˜åˆ¶ç™½é”®
    for (final key in _whiteKeyLayouts) {
      _drawWhiteKey(canvas, key, size.height);
    }
    
    // 2. ç»˜åˆ¶é»‘é”®
    for (final key in _blackKeyLayouts) {
      _drawBlackKey(canvas, key, size.height);
    }
  }
  
  /// è®¡ç®—é”®ç›˜å¸ƒå±€
  void _calculateKeyLayouts() {
    _whiteKeyLayouts = [];
    _blackKeyLayouts = [];
    
    var whiteKeyIndex = 0;
    final whiteKeyWidth = _calculateWhiteKeyWidth();
    
    for (var midi = startMidi; midi <= endMidi; midi++) {
      final isBlack = _isBlackKey(midi);
      
      if (isBlack) {
        // é»‘é”®ä½ç½®ï¼šåœ¨å‰ä¸€ä¸ªç™½é”®çš„å³è¾¹ç¼˜
        final blackKeyWidth = whiteKeyWidth * 0.6;
        final x = whiteKeyIndex * whiteKeyWidth - blackKeyWidth / 2;
        _blackKeyLayouts.add(_KeyLayout(midi: midi, x: x, width: blackKeyWidth));
      } else {
        _whiteKeyLayouts.add(_KeyLayout(
          midi: midi, 
          x: whiteKeyIndex * whiteKeyWidth, 
          width: whiteKeyWidth,
        ));
        whiteKeyIndex++;
      }
    }
  }
  
  /// ç»˜åˆ¶ç™½é”®
  void _drawWhiteKey(Canvas canvas, _KeyLayout key, double height) {
    final isHighlighted = highlightedNotes.containsKey(key.midi);
    final isPressed = pressedNotes.contains(key.midi);
    final hand = highlightedNotes[key.midi];
    
    // é”®çš„é¢œè‰²
    Color keyColor;
    if (isPressed) {
      keyColor = context.colors.highlight.withOpacity(0.5);
    } else if (isHighlighted) {
      keyColor = hand == Hand.right 
          ? context.colors.pianoHighlightRight.withOpacity(0.4)
          : context.colors.pianoHighlightLeft.withOpacity(0.4);
    } else {
      keyColor = context.colors.pianoWhiteKey;
    }
    
    final rect = RRect.fromRectAndCorners(
      Rect.fromLTWH(key.x, 0, key.width - 1, height),
      bottomLeft: const Radius.circular(4),
      bottomRight: const Radius.circular(4),
    );
    
    // ç»˜åˆ¶é”®
    canvas.drawRRect(rect, Paint()..color = keyColor);
    
    // ç»˜åˆ¶è¾¹æ¡†
    canvas.drawRRect(
      rect,
      Paint()
        ..color = Colors.grey.shade300
        ..style = PaintingStyle.stroke
        ..strokeWidth = 1,
    );
    
    // ç»˜åˆ¶é«˜äº®æŒ‡ç¤ºå™¨ï¼ˆåœ¨åº•éƒ¨ï¼‰
    if (isHighlighted) {
      final indicatorColor = hand == Hand.right 
          ? context.colors.pianoHighlightRight
          : context.colors.pianoHighlightLeft;
      
      canvas.drawRect(
        Rect.fromLTWH(key.x + 2, height - 6, key.width - 5, 4),
        Paint()..color = indicatorColor,
      );
    }
  }
  
  /// ç»˜åˆ¶é»‘é”®
  void _drawBlackKey(Canvas canvas, _KeyLayout key, double whiteKeyHeight) {
    final isHighlighted = highlightedNotes.containsKey(key.midi);
    final isPressed = pressedNotes.contains(key.midi);
    final hand = highlightedNotes[key.midi];
    final blackKeyHeight = whiteKeyHeight * 0.6;
    
    Color keyColor;
    if (isPressed) {
      keyColor = context.colors.highlight;
    } else if (isHighlighted) {
      keyColor = hand == Hand.right 
          ? context.colors.pianoHighlightRight
          : context.colors.pianoHighlightLeft;
    } else {
      keyColor = context.colors.pianoBlackKey;
    }
    
    final rect = RRect.fromRectAndCorners(
      Rect.fromLTWH(key.x, 0, key.width, blackKeyHeight),
      bottomLeft: const Radius.circular(3),
      bottomRight: const Radius.circular(3),
    );
    
    canvas.drawRRect(rect, Paint()..color = keyColor);
    
    // ç»˜åˆ¶é˜´å½±æ•ˆæœ
    canvas.drawRRect(
      rect,
      Paint()
        ..color = Colors.black.withOpacity(0.3)
        ..maskFilter = const MaskFilter.blur(BlurStyle.normal, 2),
    );
  }
  
  /// åˆ¤æ–­æ˜¯å¦ä¸ºé»‘é”®
  bool _isBlackKey(int midi) {
    const blackKeyPattern = [1, 3, 6, 8, 10];
    return blackKeyPattern.contains(midi % 12);
  }
  
  /// è®¡ç®—ç™½é”®å®½åº¦
  double _calculateWhiteKeyWidth() {
    var whiteKeyCount = 0;
    for (var midi = startMidi; midi <= endMidi; midi++) {
      if (!_isBlackKey(midi)) whiteKeyCount++;
    }
    return context.width / whiteKeyCount;
  }
  
  /// ç‚¹å‡»æµ‹è¯•ï¼šè¿”å›è¢«ç‚¹å‡»çš„ MIDI ç¼–å·
  int? hitTest(Offset position, double height) {
    final blackKeyHeight = height * 0.6;
    
    // å…ˆæ£€æµ‹é»‘é”®ï¼ˆå› ä¸ºé»‘é”®åœ¨ä¸Šå±‚ï¼‰
    if (position.dy <= blackKeyHeight) {
      for (final key in _blackKeyLayouts.reversed) {
        if (position.dx >= key.x && position.dx <= key.x + key.width) {
          return key.midi;
        }
      }
    }
    
    // å†æ£€æµ‹ç™½é”®
    for (final key in _whiteKeyLayouts) {
      if (position.dx >= key.x && position.dx <= key.x + key.width) {
        return key.midi;
      }
    }
    
    return null;
  }
  
  @override
  bool shouldRepaint(covariant PianoKeyboardPainter oldDelegate) {
    return oldDelegate.highlightedNotes != highlightedNotes ||
           oldDelegate.pressedNotes != pressedNotes;
  }
}

class _KeyLayout {
  final int midi;
  final double x;
  final double width;
  
  _KeyLayout({required this.midi, required this.x, required this.width});
}
```

---

## 7. å¸ƒå±€å¼•æ“

### 7.1 å¸ƒå±€ç»“æœæ•°æ®ç»“æ„

```dart
/// å¸ƒå±€ç»“æœ
class LayoutResult {
  /// æ€»å®½åº¦
  final double totalWidth;
  
  /// æ€»é«˜åº¦
  final double totalHeight;
  
  /// é«˜éŸ³è°±è¡¨ Y èµ·å§‹ä½ç½®
  final double trebleStaffY;
  
  /// ä½éŸ³è°±è¡¨ Y èµ·å§‹ä½ç½®
  final double bassStaffY;
  
  /// é’¢ç´é”®ç›˜ Y èµ·å§‹ä½ç½®
  final double pianoY;
  
  /// è¡Œå¸ƒå±€åˆ—è¡¨
  final List<LineLayout> lines;
  
  /// å°èŠ‚å¸ƒå±€æ˜ å°„ (measureIndex -> MeasureLayout)
  final Map<int, MeasureLayout> measureLayouts;
  
  /// éŸ³ç¬¦å¸ƒå±€åˆ—è¡¨
  final List<NoteLayout> noteLayouts;
  
  /// ç¬¦æ ç»„
  final List<BeamGroup> beamGroups;
  
  /// è¿éŸ³çº¿
  final List<TieLayout> ties;
}

/// è¡Œå¸ƒå±€
class LineLayout {
  final int lineIndex;
  final double y;
  final double height;
  final List<int> measureIndices;
  final bool showClef;
  final bool showKeySignature;
  final bool showTimeSignature;
}

/// å°èŠ‚å¸ƒå±€
class MeasureLayout {
  final int measureIndex;
  final int lineIndex;
  final double x;
  final double width;
  final List<NoteLayout> notes;
}

/// éŸ³ç¬¦å¸ƒå±€
class NoteLayout {
  final int trackIndex;
  final int measureIndex;
  final int beatIndex;
  final int noteIndex;
  
  final Note note;
  
  /// æ¸²æŸ“ä½ç½®
  final double x;
  final double y;
  
  /// äº”çº¿è°±ä½ç½® (0 = ç¬¬ä¸€çº¿)
  final int staffPosition;
  
  /// ç¬¦å¹²æ–¹å‘
  final bool stemUp;
  
  /// æ‰€å±ç¬¦æ ç»„ç´¢å¼• (-1 = æ— )
  final int beamGroupIndex;
  
  /// ç‚¹å‡»åŒºåŸŸ
  final Rect hitBox;
  
  /// å¯¹åº”çš„é’¢ç´é”® X åæ ‡
  final double pianoKeyX;
}

/// ç¬¦æ ç»„
class BeamGroup {
  final List<int> noteLayoutIndices;
  final int beamCount;
  final bool stemUp;
  final double startX;
  final double endX;
  final double startY;
  final double endY;
}

/// è¿éŸ³çº¿å¸ƒå±€
class TieLayout {
  final int startNoteIndex;
  final int endNoteIndex;
  final Offset startPoint;
  final Offset endPoint;
  final Offset controlPoint1;
  final Offset controlPoint2;
}
```

### 7.2 å¸ƒå±€å¼•æ“

```dart
/// å¸ƒå±€å¼•æ“
class LayoutEngine {
  final RenderConfig config;
  final double availableWidth;
  
  LayoutEngine({
    required this.config,
    required this.availableWidth,
  });
  
  /// è®¡ç®—å®Œæ•´å¸ƒå±€
  LayoutResult calculate(Score score) {
    // 1. è®¡ç®—è°±è¡¨ä½ç½®
    final trebleY = config.padding.top;
    final bassY = trebleY + config.lineSpacing * 4 + config.staffGap;
    final pianoY = bassY + config.lineSpacing * 4 + config.staffGap;
    
    // 2. åˆ†è¡Œ
    final lines = _breakIntoLines(score);
    
    // 3. è®¡ç®—å°èŠ‚å¸ƒå±€
    final measureLayouts = _layoutMeasures(score, lines);
    
    // 4. è®¡ç®—éŸ³ç¬¦å¸ƒå±€
    final noteLayouts = _layoutNotes(score, measureLayouts);
    
    // 5. è®¡ç®—ç¬¦æ 
    final beamGroups = BeamCalculator.calculate(noteLayouts, config);
    
    // 6. è®¡ç®—è¿éŸ³çº¿
    final ties = TieCalculator.calculate(noteLayouts);
    
    return LayoutResult(
      totalWidth: availableWidth,
      totalHeight: pianoY + config.pianoHeight + config.padding.bottom,
      trebleStaffY: trebleY,
      bassStaffY: bassY,
      pianoY: pianoY,
      lines: lines,
      measureLayouts: measureLayouts,
      noteLayouts: noteLayouts,
      beamGroups: beamGroups,
      ties: ties,
    );
  }
  
  /// å°†å°èŠ‚åˆ†æˆå¤šè¡Œ
  List<LineLayout> _breakIntoLines(Score score) {
    // ... åˆ†è¡Œç®—æ³•
  }
  
  /// è®¡ç®—å°èŠ‚å¸ƒå±€
  Map<int, MeasureLayout> _layoutMeasures(Score score, List<LineLayout> lines) {
    // ... å°èŠ‚å¸ƒå±€ç®—æ³•
  }
  
  /// è®¡ç®—éŸ³ç¬¦å¸ƒå±€
  List<NoteLayout> _layoutNotes(Score score, Map<int, MeasureLayout> measures) {
    // ... éŸ³ç¬¦å¸ƒå±€ç®—æ³•
  }
}
```

---

## 8. äº¤äº’ç³»ç»Ÿ

### 8.1 ä¸»è§†å›¾ç»„ä»¶

```dart
/// ä¹è°±æ’­æ”¾è§†å›¾
class SheetMusicView extends StatefulWidget {
  final Score score;
  final PlaybackController playbackController;
  final bool showPiano;
  final bool showLyrics;
  
  const SheetMusicView({
    super.key,
    required this.score,
    required this.playbackController,
    this.showPiano = true,
    this.showLyrics = true,
  });
  
  @override
  State<SheetMusicView> createState() => _SheetMusicViewState();
}

class _SheetMusicViewState extends State<SheetMusicView> {
  late RenderContext _context;
  late LayoutResult _layout;
  final Set<int> _pressedKeys = {};
  
  @override
  Widget build(BuildContext context) {
    return LayoutBuilder(
      builder: (context, constraints) {
        _updateLayout(constraints.maxWidth);
        
        return GestureDetector(
          onTapDown: _handleTapDown,
          onTapUp: _handleTapUp,
          onPanUpdate: _handlePan,
          child: Stack(
            children: [
              // å¤§è°±è¡¨å±‚
              RepaintBoundary(
                child: CustomPaint(
                  painter: GrandStaffPainter(_context, widget.score),
                  size: Size(constraints.maxWidth, _layout.pianoY),
                ),
              ),
              
              // é’¢ç´é”®ç›˜å±‚
              if (widget.showPiano)
                Positioned(
                  top: _layout.pianoY,
                  left: 0,
                  right: 0,
                  height: _context.config.pianoHeight,
                  child: RepaintBoundary(
                    child: Obx(() => CustomPaint(
                      painter: PianoKeyboardPainter(
                        _context,
                        highlightedNotes: _getCurrentHighlightedNotes(),
                        pressedNotes: _pressedKeys,
                      ),
                    )),
                  ),
                ),
              
              // é«˜äº®è¦†ç›–å±‚
              RepaintBoundary(
                child: Obx(() => CustomPaint(
                  painter: OverlayPainter(
                    _context,
                    highlightedNotes: _getCurrentPlayingNotes(),
                  ),
                )),
              ),
            ],
          ),
        );
      },
    );
  }
  
  /// å¤„ç†ç‚¹å‡»
  void _handleTapDown(TapDownDetails details) {
    final position = details.localPosition;
    
    // æ£€æµ‹é’¢ç´é”®ç›˜ç‚¹å‡»
    if (widget.showPiano && position.dy >= _layout.pianoY) {
      final pianoPosition = Offset(position.dx, position.dy - _layout.pianoY);
      final midi = _hitTestPianoKey(pianoPosition);
      if (midi != null) {
        setState(() => _pressedKeys.add(midi));
        _playNote(midi);
      }
      return;
    }
    
    // æ£€æµ‹éŸ³ç¬¦ç‚¹å‡»
    final noteLayout = _hitTestNote(position);
    if (noteLayout != null) {
      widget.playbackController.seekToNote(
        noteLayout.measureIndex,
        noteLayout.noteIndex,
      );
    }
  }
  
  /// è·å–å½“å‰é«˜äº®çš„éŸ³ç¬¦ (MIDI -> Hand)
  Map<int, Hand> _getCurrentHighlightedNotes() {
    final state = widget.playbackController.playbackState.value;
    if (!state.isPlaying) return {};
    
    final result = <int, Hand>{};
    
    // å³æ‰‹å½“å‰éŸ³ç¬¦
    final rightNote = _getCurrentNoteForTrack(widget.score.rightHandTrack, state);
    if (rightNote != null && !rightNote.isRest) {
      result[rightNote.pitch] = Hand.right;
    }
    
    // å·¦æ‰‹å½“å‰éŸ³ç¬¦
    final leftNote = _getCurrentNoteForTrack(widget.score.leftHandTrack, state);
    if (leftNote != null && !leftNote.isRest) {
      result[leftNote.pitch] = Hand.left;
    }
    
    return result;
  }
}
```

---

## 9. æ’­æ”¾åŒæ­¥

### 9.1 æ’­æ”¾æ§åˆ¶å™¨

```dart
/// æ’­æ”¾æ§åˆ¶å™¨
class PlaybackController extends GetxController {
  final Score score;
  final AudioService audioService;
  
  PlaybackController({required this.score, required this.audioService});
  
  /// æ’­æ”¾çŠ¶æ€
  final playbackState = PlaybackState().obs;
  
  /// è®¡æ—¶å™¨
  Timer? _timer;
  
  /// éŸ³ç¬¦æ—¶é—´è¡¨
  late final List<_ScheduledNote> _noteSchedule;
  
  @override
  void onInit() {
    super.onInit();
    _buildNoteSchedule();
  }
  
  /// æ„å»ºéŸ³ç¬¦æ—¶é—´è¡¨
  void _buildNoteSchedule() {
    _noteSchedule = [];
    final beatsPerSecond = score.metadata.tempo / 60.0;
    var currentTime = 0.0;
    
    for (var measureIndex = 0; measureIndex < score.measureCount; measureIndex++) {
      // å³æ‰‹
      final rightMeasure = score.rightHandTrack?.measures[measureIndex];
      if (rightMeasure != null) {
        for (var beatIndex = 0; beatIndex < rightMeasure.beats.length; beatIndex++) {
          final beat = rightMeasure.beats[beatIndex];
          final beatTime = currentTime + beatIndex / beatsPerSecond;
          
          for (final note in beat.notes) {
            if (!note.isRest) {
              _noteSchedule.add(_ScheduledNote(
                time: beatTime,
                midi: note.pitch,
                hand: Hand.right,
                measureIndex: measureIndex,
                beatIndex: beatIndex,
                duration: note.actualBeats / beatsPerSecond,
              ));
            }
          }
        }
      }
      
      // å·¦æ‰‹
      final leftMeasure = score.leftHandTrack?.measures[measureIndex];
      if (leftMeasure != null) {
        for (var beatIndex = 0; beatIndex < leftMeasure.beats.length; beatIndex++) {
          final beat = leftMeasure.beats[beatIndex];
          final beatTime = currentTime + beatIndex / beatsPerSecond;
          
          for (final note in beat.notes) {
            if (!note.isRest) {
              _noteSchedule.add(_ScheduledNote(
                time: beatTime,
                midi: note.pitch,
                hand: Hand.left,
                measureIndex: measureIndex,
                beatIndex: beatIndex,
                duration: note.actualBeats / beatsPerSecond,
              ));
            }
          }
        }
      }
      
      currentTime += score.metadata.beatsPerMeasure / beatsPerSecond;
    }
    
    // æŒ‰æ—¶é—´æ’åº
    _noteSchedule.sort((a, b) => a.time.compareTo(b.time));
  }
  
  /// å¼€å§‹æ’­æ”¾
  void play() {
    if (playbackState.value.isPlaying) return;
    
    playbackState.value = playbackState.value.copyWith(isPlaying: true);
    
    _timer = Timer.periodic(const Duration(milliseconds: 16), (_) {
      _tick();
    });
  }
  
  /// æš‚åœ
  void pause() {
    _timer?.cancel();
    playbackState.value = playbackState.value.copyWith(isPlaying: false);
  }
  
  /// åœæ­¢
  void stop() {
    _timer?.cancel();
    playbackState.value = PlaybackState();
  }
  
  /// æ’­æ”¾èŠ‚æ‹
  void _tick() {
    final state = playbackState.value;
    final newTime = state.currentTime + 0.016 * state.speed;
    
    // æ£€æŸ¥æ˜¯å¦éœ€è¦æ’­æ”¾æ–°éŸ³ç¬¦
    final speed = state.speed;
    for (final scheduled in _noteSchedule) {
      if (scheduled.time > state.currentTime && scheduled.time <= newTime) {
        // æ ¹æ®è®¾ç½®å†³å®šæ˜¯å¦æ’­æ”¾å·¦/å³æ‰‹
        if (state.playRightHand && scheduled.hand == Hand.right) {
          audioService.playPianoNote(scheduled.midi);
        }
        if (state.playLeftHand && scheduled.hand == Hand.left) {
          audioService.playPianoNote(scheduled.midi);
        }
      }
    }
    
    // æ›´æ–°çŠ¶æ€
    playbackState.value = state.copyWith(
      currentTime: newTime,
      currentMeasureIndex: _getMeasureIndexAtTime(newTime),
    );
    
    // æ£€æŸ¥æ˜¯å¦æ’­æ”¾å®Œæ¯•
    if (newTime >= score.totalDuration) {
      if (state.isLooping) {
        playbackState.value = state.copyWith(currentTime: 0);
      } else {
        stop();
      }
    }
  }
}

class _ScheduledNote {
  final double time;
  final int midi;
  final Hand hand;
  final int measureIndex;
  final int beatIndex;
  final double duration;
  
  _ScheduledNote({
    required this.time,
    required this.midi,
    required this.hand,
    required this.measureIndex,
    required this.beatIndex,
    required this.duration,
  });
}

/// æ’­æ”¾çŠ¶æ€
class PlaybackState {
  final bool isPlaying;
  final double currentTime;
  final int currentMeasureIndex;
  final double speed;
  final bool isLooping;
  final bool playRightHand;
  final bool playLeftHand;
  
  const PlaybackState({
    this.isPlaying = false,
    this.currentTime = 0,
    this.currentMeasureIndex = 0,
    this.speed = 1.0,
    this.isLooping = false,
    this.playRightHand = true,
    this.playLeftHand = true,
  });
  
  PlaybackState copyWith({
    bool? isPlaying,
    double? currentTime,
    int? currentMeasureIndex,
    double? speed,
    bool? isLooping,
    bool? playRightHand,
    bool? playLeftHand,
  }) {
    return PlaybackState(
      isPlaying: isPlaying ?? this.isPlaying,
      currentTime: currentTime ?? this.currentTime,
      currentMeasureIndex: currentMeasureIndex ?? this.currentMeasureIndex,
      speed: speed ?? this.speed,
      isLooping: isLooping ?? this.isLooping,
      playRightHand: playRightHand ?? this.playRightHand,
      playLeftHand: playLeftHand ?? this.playLeftHand,
    );
  }
}
```

---

## 10. å®æ–½è®¡åˆ’

### 10.1 é˜¶æ®µåˆ’åˆ†

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          å®æ–½é˜¶æ®µ                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  Phase 1: æ•°æ®æ¨¡å‹é‡æ„ (2å¤©)                                      â”‚
â”‚  â”œâ”€â”€ [1] æ–°å»º Score/Track/Measure/Beat/Note æ¨¡å‹                 â”‚
â”‚  â”œâ”€â”€ [2] å®ç°æšä¸¾å’Œè¾…åŠ©ç±»                                         â”‚
â”‚  â””â”€â”€ [3] JSON è§£æå™¨é€‚é…æ–°æ¨¡å‹                                    â”‚
â”‚                                                                 â”‚
â”‚  Phase 2: å¸ƒå±€å¼•æ“ (2å¤©)                                         â”‚
â”‚  â”œâ”€â”€ [4] å®ç° LayoutEngine                                       â”‚
â”‚  â”œâ”€â”€ [5] å®ç° BeamCalculatorï¼ˆç¬¦æ åˆ†ç»„ï¼‰                          â”‚
â”‚  â””â”€â”€ [6] å®ç° TieCalculatorï¼ˆè¿éŸ³çº¿ï¼‰                             â”‚
â”‚                                                                 â”‚
â”‚  Phase 3: å¤§è°±è¡¨æ¸²æŸ“ (3å¤©)                                        â”‚
â”‚  â”œâ”€â”€ [7] å®ç° BasePainter åŸºç±»                                   â”‚
â”‚  â”œâ”€â”€ [8] å®ç° GrandStaffPainterï¼ˆå¤§è°±è¡¨ï¼‰                         â”‚
â”‚  â”œâ”€â”€ [9] å®ç° NoteRendererï¼ˆéŸ³ç¬¦ç»˜åˆ¶ï¼‰                            â”‚
â”‚  â””â”€â”€ [10] å®ç°å·¦å³æ‰‹é¢œè‰²åŒºåˆ†                                      â”‚
â”‚                                                                 â”‚
â”‚  Phase 4: Canvas é’¢ç´é”®ç›˜ (2å¤©)                                   â”‚
â”‚  â”œâ”€â”€ [11] å®ç° PianoKeyboardPainter                              â”‚
â”‚  â”œâ”€â”€ [12] å®ç°è§¦æ§å’Œé«˜äº®                                          â”‚
â”‚  â””â”€â”€ [13] éŸ³ç¬¦-é”®ç›˜ä½ç½®å¯¹é½                                       â”‚
â”‚                                                                 â”‚
â”‚  Phase 5: æ’­æ”¾åŒæ­¥ (2å¤©)                                         â”‚
â”‚  â”œâ”€â”€ [14] å®ç° PlaybackController                                â”‚
â”‚  â”œâ”€â”€ [15] å®ç°åˆ†æ‰‹æ’­æ”¾æ¨¡å¼                                        â”‚
â”‚  â””â”€â”€ [16] å®ç°è‡ªåŠ¨æ»šåŠ¨                                           â”‚
â”‚                                                                 â”‚
â”‚  Phase 6: é›†æˆæµ‹è¯• (1å¤©)                                         â”‚
â”‚  â”œâ”€â”€ [17] ç»„ä»¶é›†æˆ                                               â”‚
â”‚  â”œâ”€â”€ [18] ä¹è°±æ•°æ®è¿ç§»                                           â”‚
â”‚  â””â”€â”€ [19] åˆ é™¤æ—§ä»£ç                                              â”‚
â”‚                                                                 â”‚
â”‚  é¢„è®¡æ€»å·¥æœŸï¼š12 ä¸ªå·¥ä½œæ—¥                                          â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 10.2 éªŒæ”¶æ ‡å‡†

| åŠŸèƒ½ç‚¹ | éªŒæ”¶æ ‡å‡† |
|--------|---------|
| å¤§è°±è¡¨æ¸²æŸ“ | é«˜éŸ³+ä½éŸ³è°±è¡¨æ­£ç¡®æ˜¾ç¤ºï¼ŒèŠ±æ‹¬å·è¿æ¥ |
| å·¦å³æ‰‹åŒºåˆ† | å³æ‰‹è“è‰²ã€å·¦æ‰‹ç»¿è‰²ï¼Œè§†è§‰æ¸…æ™° |
| Canvas é’¢ç´ | è§¦æ§å“åº” <50msï¼Œæ»‘å¥æµç•… |
| é”®ç›˜é«˜äº® | æ’­æ”¾æ—¶æ­£ç¡®é«˜äº®å·¦å³æ‰‹æŒ‰é”® |
| åˆ†æ‰‹ç»ƒä¹  | å¯å•ç‹¬æ’­æ”¾/é™éŸ³å·¦æ‰‹æˆ–å³æ‰‹ |
| æ€§èƒ½ | 100å°èŠ‚ä¹è°± 60fps æµç•…æ¸²æŸ“ |

### 10.3 å¾…åˆ é™¤çš„æ—§ä»£ç 

```
lib/features/tools/sheet_music/
â”œâ”€â”€ widgets/
â”‚   â”œâ”€â”€ staff_notation_widget.dart      # åˆ é™¤
â”‚   â”œâ”€â”€ jianpu_notation_widget.dart     # åˆ é™¤
â”‚   â”œâ”€â”€ dual_notation_widget.dart       # åˆ é™¤
â”‚   â”œâ”€â”€ sheet_with_piano_widget.dart    # åˆ é™¤
â”‚   â””â”€â”€ jianpu_editor_widget.dart       # åˆ é™¤
â”œâ”€â”€ models/
â”‚   â””â”€â”€ sheet_model.dart                # å®Œå…¨é‡å†™
â””â”€â”€ controllers/
    â””â”€â”€ sheet_player_controller.dart    # å®Œå…¨é‡å†™

lib/core/widgets/music/
â””â”€â”€ piano_keyboard.dart                  # åˆ é™¤ï¼ˆCanvas æ›¿ä»£ï¼‰
```

---

## é™„å½•

### A. éŸ³ç¬¦-äº”çº¿è°±ä½ç½®æ˜ å°„

```
MIDI  éŸ³å    é«˜éŸ³è°±ä½ç½®    ä½éŸ³è°±ä½ç½®
----- ------- ------------ ------------
60    C4      -2 (ä¸‹åŠ ä¸€çº¿)  10
62    D4      -1            11
64    E4       0 (ç¬¬ä¸€çº¿)    12
65    F4       1            13
67    G4       2 (ç¬¬äºŒçº¿)    14
69    A4       3            15
71    B4       4 (ç¬¬ä¸‰çº¿)    16
72    C5       5            17
74    D5       6 (ç¬¬å››çº¿)    18
76    E5       7            19
77    F5       8 (ç¬¬äº”çº¿)    20
```

### B. å‚è€ƒèµ„æ–™

- [SMuFL å®˜æ–¹è§„èŒƒ](https://www.w3.org/2019/03/smufl13/)
- [Behind Bars - Notation Guide](https://www.amazon.com/Behind-Bars-Definitive-Music-Notation/dp/0571514561)
- [Flutter CustomPainter](https://api.flutter.dev/flutter/rendering/CustomPainter-class.html)

---

> ğŸ“ **æ–‡æ¡£ç‰ˆæœ¬**: v3.0  
> **åˆ›å»ºæ—¥æœŸ**: 2026-01-13  
> **çŠ¶æ€**: è®¾è®¡å®Œæˆï¼Œå¾…å®æ–½
