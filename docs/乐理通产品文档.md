# 乐理通 - 音乐入门学习 App 产品设计文档

## 一、产品概述

### 1.1 产品定位

| 项目 | 说明 |
|------|------|
| **App 名称** | 乐理通 (MusicStart) |
| **Slogan** | 从零开始，轻松学音乐 |
| **产品类型** | 教育工具 + 游戏化学习 |
| **目标用户** | 零基础 → 入门级的音乐学习者 |
| **核心价值** | 一个 App 搞定简谱 + 五线谱 + 钢琴基础 |

### 1.2 目标平台

- ✅ Android
- ✅ iOS
- ✅ Web（H5）
- ✅ macOS
- ✅ Windows
- ✅ Linux

---

## 二、用户画像

| 用户类型 | 特征 | 核心需求 | 使用场景 |
|---------|------|---------|---------|
| **零基础小白** | 完全不懂乐理，对音乐有兴趣 | 从头开始，循序渐进 | 闲暇时间自学 |
| **简谱初学者** | 会唱简谱但不会弹奏 | 学五线谱 + 钢琴入门 | 配合学琴使用 |
| **钢琴爱好者** | 想学钢琴但无基础 | 乐理 + 指法 + 简单曲目 | 自学钢琴前置知识 |
| **琴童家长** | 陪孩子学琴，自己不懂 | 了解基础乐理，能辅导孩子 | 辅导孩子练琴 |
| **音乐老师** | 需要教学辅助工具 | 课堂演示、布置作业 | 教学场景 |

---

## 三、功能架构

### 3.1 整体架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                           乐理通 App                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                      课程体系                             │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐      │   │
│  │  │   简谱入门   │→ │  五线谱入门  │→ │  钢琴入门   │      │   │
│  │  │  (10课时)   │  │  (15课时)   │  │  (20课时)  │      │   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘      │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                      练习系统                             │   │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐   │   │
│  │  │ 识谱练习  │ │ 节奏练习  │ │ 听音练习  │ │ 弹奏练习  │   │   │
│  │  └──────────┘ └──────────┘ └──────────┘ └──────────┘   │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                      工具箱                               │   │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐   │   │
│  │  │ 虚拟钢琴  │ │  节拍器   │ │ 乐谱系统  │ │ 对照表   │   │   │
│  │  └──────────┘ └──────────┘ └──────────┘ └──────────┘   │   │
│  │                                                         │   │
│  │  ┌──────────────────────────────────────────────────┐  │   │
│  │  │              乐谱系统子功能                         │  │   │
│  │  │  ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐    │  │   │
│  │  │  │乐谱浏览 │ │乐谱导入 │ │乐谱编辑 │ │乐谱播放 │    │  │   │
│  │  │  └────────┘ └────────┘ └────────┘ └────────┘    │  │   │
│  │  └──────────────────────────────────────────────────┘  │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                      用户系统                             │   │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐   │   │
│  │  │ 学习进度  │ │ 成就系统  │ │ 练习统计  │ │  设置    │   │   │
│  │  └──────────┘ └──────────┘ └──────────┘ └──────────┘   │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 3.2 底部导航结构

```
┌────────────┬────────────┬────────────┬────────────┐
│    🏠      │     📚     │     🎯     │     👤     │
│    首页    │    课程     │    练习    │    我的    │
└────────────┴────────────┴────────────┴────────────┘
```

---

## 四、课程体系设计

### 4.1 简谱入门（10课时）

| 课时 | 课程标题 | 学习内容 | 教学形式 | 时长 |
|------|---------|---------|---------|------|
| 1 | 走进音乐世界 | 什么是音乐？声音的高低 | 动画 + 音频演示 | 5min |
| 2 | 认识 Do Re Mi | 1 2 3 三个音的认识 | 听音 + 跟唱 | 8min |
| 3 | 七个音符朋友 | 完整的 1234567 | 互动练习 | 10min |
| 4 | 音乐的心跳 | 节奏概念、拍子是什么 | 节拍器 + 拍手练习 | 8min |
| 5 | 长音和短音 | 全音符、二分、四分、八分音符 | 动画演示 + 练习 | 10min |
| 6 | 音符的小尾巴 | 附点音符、连音线 | 图解 + 练习 | 8min |
| 7 | 升高和降低 | 升降音 #/b 的概念 | 钢琴对照演示 | 8min |
| 8 | 高音和低音 | 高八度、低八度标记 | 键盘对照 | 8min |
| 9 | 唱一首歌吧（上） | 《小星星》完整学习 | 逐句教学 + 跟唱 | 12min |
| 10 | 唱一首歌吧（下） | 《欢乐颂》完整学习 | 逐句教学 + 跟唱 | 12min |

### 4.2 五线谱入门（15课时）

| 课时 | 课程标题 | 学习内容 | 教学形式 | 时长 |
|------|---------|---------|---------|------|
| 1 | 五线谱的诞生 | 五线谱历史、基本结构 | 图文动画 | 6min |
| 2 | 认识五条线 | 线、间、加线的概念 | 互动标注 | 8min |
| 3 | 高音谱号 | G谱号的由来和位置 | 动画 + 描摹 | 8min |
| 4 | 线上的音符 | E G B D F 五个音 | 口诀记忆 + 练习 | 10min |
| 5 | 间上的音符 | F A C E 四个音 | 口诀记忆 + 练习 | 10min |
| 6 | 找到中央C | 中央C的位置和意义 | 键盘对照 | 8min |
| 7 | 简谱对照五线谱 | 建立两种谱的映射 | 双谱对照练习 | 12min |
| 8 | 音符的时值 | 五线谱中的音符形状 | 图解对比 | 10min |
| 9 | 休止符 | 各种休止符的认识 | 节奏练习 | 8min |
| 10 | 低音谱号 | F谱号的认识 | 动画 + 练习 | 10min |
| 11 | 低音谱号的音 | 低音谱表的音位 | 口诀 + 练习 | 10min |
| 12 | 升降号 | 五线谱中的升降记号 | 对照练习 | 8min |
| 13 | 调号入门 | 常见调号的认识 | 图解 + 练习 | 10min |
| 14 | 读谱实战（上） | 《小星星》五线谱版 | 视奏练习 | 12min |
| 15 | 读谱实战（下） | 《欢乐颂》五线谱版 | 视奏练习 | 12min |

### 4.3 钢琴入门（20课时）

| 课时 | 课程标题 | 学习内容 | 教学形式 | 时长 |
|------|---------|---------|---------|------|
| 1 | 认识钢琴 | 钢琴的结构、键盘布局 | 互动键盘 | 8min |
| 2 | 黑键和白键 | 黑白键的规律 | 动画演示 | 8min |
| 3 | 找到中央C | 在键盘上找到中央C | 互动练习 | 6min |
| 4 | 坐姿和手型 | 正确的弹奏姿势 | 视频 + 图示 | 10min |
| 5 | 五指位置 | C位置的五指放置 | 跟弹练习 | 10min |
| 6 | 右手单音 | 右手弹 1-5 | 虚拟键盘练习 | 12min |
| 7 | 右手音阶 | 右手弹完整音阶 | 跟弹练习 | 12min |
| 8 | 左手单音 | 左手弹 1-5 | 虚拟键盘练习 | 12min |
| 9 | 左手音阶 | 左手弹完整音阶 | 跟弹练习 | 12min |
| 10 | 简单节奏型 | 基本的节奏弹奏 | 节奏练习 | 10min |
| 11 | 双手预备 | 双手同时放在键盘上 | 姿势练习 | 8min |
| 12 | 双手齐奏 | 双手同时弹同样的音 | 跟弹练习 | 12min |
| 13 | 右手旋律+左手长音 | 最简单的双手配合 | 分手→合手 | 15min |
| 14 | 曲目练习1 | 《小星星》双手版 | 分句练习 | 15min |
| 15 | 曲目练习2 | 《欢乐颂》简化版 | 分句练习 | 15min |
| 16 | 曲目练习3 | 《生日快乐》 | 完整练习 | 15min |
| 17 | 曲目练习4 | 《两只老虎》 | 完整练习 | 15min |
| 18 | 基础乐理复习 | 音阶、和弦初步 | 理论 + 练习 | 12min |
| 19 | 练习方法指导 | 如何高效练琴 | 方法讲解 | 10min |
| 20 | 结业测试 | 综合能力测试 | 测验 | 20min |

---

## 五、练习系统设计

### 5.1 识谱练习

#### 5.1.1 简谱识别

```
┌─────────────────────────────────────────┐
│                                         │
│         🎵 听一听，这是哪个音？           │
│                                         │
│              🔊 播放音频                 │
│                                         │
│    ┌───┐  ┌───┐  ┌───┐  ┌───┐        │
│    │ 1 │  │ 2 │  │ 3 │  │ 4 │        │
│    └───┘  └───┘  └───┘  └───┘        │
│                                         │
│    ┌───┐  ┌───┐  ┌───┐               │
│    │ 5 │  │ 6 │  │ 7 │               │
│    └───┘  └───┘  └───┘               │
│                                         │
│         第 3/10 题    正确率 80%         │
│                                         │
└─────────────────────────────────────────┘
```

#### 5.1.2 五线谱识别

```
┌─────────────────────────────────────────┐
│                                         │
│  ┌──────────────────────────────────┐  │
│  │  🎼 ━━━━━━━━━━━━━━━━━━━━━━━━━━━  │  │
│  │     ━━━━━━●━━━━━━━━━━━━━━━━━━━  │  │
│  │     ━━━━━━━━━━━━━━━━━━━━━━━━━━  │  │
│  │     ━━━━━━━━━━━━━━━━━━━━━━━━━━  │  │
│  │     ━━━━━━━━━━━━━━━━━━━━━━━━━━  │  │
│  └──────────────────────────────────┘  │
│                                         │
│           这个音符对应简谱？              │
│                                         │
│    ┌───┐  ┌───┐  ┌───┐  ┌───┐        │
│    │ 5 │  │ 6 │  │ 7 │  │ 1 │        │
│    └───┘  └───┘  └───┘  └───┘        │
│                                         │
└─────────────────────────────────────────┘
```

#### 5.1.3 双谱对照

```
┌─────────────────────────────────────────┐
│                                         │
│  五线谱：                                │
│  ┌──────────────────────────────────┐  │
│  │  🎼 ━━●━━━━●━━━━●━━━━●━━━━━━━━━  │  │
│  │     ━━━━━━━━━━━━━━━━━━━━━━━━━━  │  │
│  │     ━━━━━━━━━━━━━━━━━━━━━━━━━━  │  │
│  └──────────────────────────────────┘  │
│                                         │
│  请选择对应的简谱：                       │
│                                         │
│  A: 1  2  3  4                          │
│  B: 3  4  5  6                          │
│  C: 5  6  7  1                          │
│  D: 1  3  5  7                          │
│                                         │
└─────────────────────────────────────────┘
```

### 5.2 节奏练习

```
┌─────────────────────────────────────────┐
│                                         │
│     🥁 跟着节拍敲击屏幕                  │
│                                         │
│     ♩    ♩    ♪ ♪   ♩                  │
│                                         │
│     1    2    3 &   4                   │
│                                         │
│  ┌─────────────────────────────────┐   │
│  │                                  │   │
│  │        👆 点击这里打节拍 👆       │   │
│  │                                  │   │
│  └─────────────────────────────────┘   │
│                                         │
│     ●    ●    ● ●   ◌                  │
│    完美  完美  完美   等待                │
│                                         │
│          BPM: 80    得分: 95           │
│                                         │
└─────────────────────────────────────────┘
```

### 5.3 弹奏练习

```
┌─────────────────────────────────────────┐
│                                         │
│  🎼 请弹奏以下旋律：                      │
│                                         │
│  ┌──────────────────────────────────┐  │
│  │     1   1 │ 5   5 │ 6   6 │ 5 - │  │
│  │  一闪一闪   亮晶晶                  │  │
│  └──────────────────────────────────┘  │
│                                         │
│  ┌──────────────────────────────────┐  │
│  │  ┌─┐ ┌─┐   ┌─┐ ┌─┐ ┌─┐         │  │
│  │  └┬┘ └┬┘   └┬┘ └┬┘ └┬┘         │  │
│  │ ┌─┴┬──┴┬────┴┬──┴┬──┴┬────┬──┐ │  │
│  │ │C │ D │ E  │ F │ G │ A  │ B │ │  │
│  │ │1 │ 2 │ 3  │ 4 │ 5 │ 6  │ 7 │ │  │
│  │ └──┴───┴────┴───┴───┴────┴───┘ │  │
│  └──────────────────────────────────┘  │
│                                         │
│     当前：1  正确！✓   进度：2/8        │
│                                         │
└─────────────────────────────────────────┘
```

### 5.4 练习难度等级

| 等级 | 名称 | 内容范围 |
|------|------|---------|
| ⭐ | 入门 | 中央C附近一个八度，基本节奏 |
| ⭐⭐ | 初级 | 两个八度，附点节奏 |
| ⭐⭐⭐ | 进阶 | 加入升降音，切分节奏 |
| ⭐⭐⭐⭐ | 中级 | 快速识谱，复杂节奏 |
| ⭐⭐⭐⭐⭐ | 高级 | 视奏能力，双手配合 |

---

## 六、工具箱设计

### 6.1 虚拟钢琴

```
┌─────────────────────────────────────────────────────────────┐
│                        🎹 虚拟钢琴                           │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  显示设置：  [简谱] [音名] [无]     键数：[61键] [88键]       │
│                                                             │
│  ┌──────────────────────────────────────────────────────┐  │
│  │                                                       │  │
│  │    ┌─┐ ┌─┐   ┌─┐ ┌─┐ ┌─┐   ┌─┐ ┌─┐   ┌─┐ ┌─┐ ┌─┐   │  │
│  │    │ │ │ │   │ │ │ │ │ │   │ │ │ │   │ │ │ │ │ │   │  │
│  │    │ │ │ │   │ │ │ │ │ │   │ │ │ │   │ │ │ │ │ │   │  │
│  │    └┬┘ └┬┘   └┬┘ └┬┘ └┬┘   └┬┘ └┬┘   └┬┘ └┬┘ └┬┘   │  │
│  │  ┌──┴┬──┴┬────┴┬──┴┬──┴┬────┴┬──┴┬────┴┬──┴┬──┴┬───┐│  │
│  │  │ C │ D │ E  │ F │ G │ A  │ B │ C  │ D │ E │ F ││  │
│  │  │ 1 │ 2 │ 3  │ 4 │ 5 │ 6  │ 7 │ 1' │ 2'│ 3'│ 4'││  │
│  │  └───┴───┴────┴───┴───┴────┴───┴────┴───┴───┴───┘│  │
│  │                     ↑ 中央C                        │  │
│  └──────────────────────────────────────────────────────┘  │
│                                                             │
│  [🔴 录制]  [⏸ 暂停]  [▶️ 播放]  [🗑 清除]                   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

**功能特性**：
- 支持多点触控（和弦）
- 可显示简谱/音名标记
- 录制和回放功能
- 音色选择（钢琴/电钢琴/风琴）
- 键盘可滑动查看完整音域

### 6.2 节拍器

```
┌─────────────────────────────────────────┐
│              🥁 节拍器                   │
├─────────────────────────────────────────┤
│                                         │
│              ┌─────────┐                │
│              │         │                │
│              │   120   │  BPM           │
│              │         │                │
│              └─────────┘                │
│           [-10] [-1] [+1] [+10]         │
│                                         │
│                  ●                      │
│               ╱     ╲                   │
│              ●       ●                  │
│               ╲     ╱                   │
│                  ●                      │
│                                         │
│  拍号：  [2/4]  [3/4]  [4/4]  [6/8]     │
│                                         │
│  强弱：  [● ○ ○ ○]  四四拍               │
│                                         │
│        ┌──────────────────┐             │
│        │    ▶️  开始       │             │
│        └──────────────────┘             │
│                                         │
└─────────────────────────────────────────┘
```

**功能特性**：
- 速度可调（20-240 BPM）
- 多种拍号选择
- 可视化节拍指示
- 音效可选（木鱼/电子/鼓声）
- 渐进练习模式（自动加速）

### 6.3 乐谱库

```
┌─────────────────────────────────────────┐
│              📚 乐谱库                   │
├─────────────────────────────────────────┤
│                                         │
│  [全部] [入门] [初级] [中级] [收藏]       │
│                                         │
│  ┌─────────────────────────────────┐   │
│  │ 🎵 小星星                        │   │
│  │ 难度：⭐  |  简谱 ✓  五线谱 ✓    │   │
│  └─────────────────────────────────┘   │
│                                         │
│  ┌─────────────────────────────────┐   │
│  │ 🎵 欢乐颂                        │   │
│  │ 难度：⭐⭐  |  简谱 ✓  五线谱 ✓  │   │
│  └─────────────────────────────────┘   │
│                                         │
│  ┌─────────────────────────────────┐   │
│  │ 🎵 生日快乐                      │   │
│  │ 难度：⭐  |  简谱 ✓  五线谱 ✓    │   │
│  └─────────────────────────────────┘   │
│                                         │
│  ┌─────────────────────────────────┐   │
│  │ 🎵 两只老虎                      │   │
│  │ 难度：⭐  |  简谱 ✓  五线谱 ✓    │   │
│  └─────────────────────────────────┘   │
│                                         │
└─────────────────────────────────────────┘
```

### 6.4 音符对照表

```
┌─────────────────────────────────────────┐
│            📋 音符对照表                 │
├─────────────────────────────────────────┤
│                                         │
│  调号选择：[C大调] [G大调] [F大调] ...    │
│                                         │
│  ┌─────────────────────────────────┐   │
│  │  简谱  │  音名  │  五线谱位置     │   │
│  ├────────┼────────┼────────────────┤   │
│  │   1    │   C    │  下加一线       │   │
│  │   2    │   D    │  下加一间       │   │
│  │   3    │   E    │  第一线        │   │
│  │   4    │   F    │  第一间        │   │
│  │   5    │   G    │  第二线        │   │
│  │   6    │   A    │  第二间        │   │
│  │   7    │   B    │  第三线        │   │
│  │  1'    │  C'    │  第三间        │   │
│  └─────────────────────────────────┘   │
│                                         │
│  点击任意行可听到对应音高 🔊             │
│                                         │
└─────────────────────────────────────────┘
```

### 6.5 乐谱系统（核心功能）

乐谱系统是本应用的核心功能模块，提供专业级的乐谱展示、导入、编辑和播放能力。

#### 6.5.1 乐谱展示

**五线谱专业渲染要素**

| 类别 | 渲染元素 | 优先级 | 说明 |
|------|----------|--------|------|
| **谱表基础** | 五线、谱号、小节线、终止线 | P0 | 基础框架 |
| **谱号** | G谱号(高音)、F谱号(低音)、C谱号(中音) | P0 | 支持大谱表 |
| **音符** | 全音符、二分、四分、八分、十六分、三十二分 | P0 | 完整时值 |
| **休止符** | 对应各时值的休止符 | P0 | 完整休止符系统 |
| **附点** | 单附点、复附点 | P0 | 增加时值 |
| **拍号** | 2/4, 3/4, 4/4, 6/8, 3/8 等 | P0 | 常见拍号 |
| **调号** | 升号调(G,D,A,E,B,F#,C#)、降号调(F,Bb,Eb,Ab,Db,Gb,Cb) | P0 | 所有大小调 |
| **临时记号** | 升号#、降号b、还原号♮、重升×、重降bb | P0 | 临时变音 |
| **连线** | 连音线(tie)、圆滑线(slur) | P1 | 音乐表情 |
| **延音记号** | 延长记号(fermata) | P1 | 自由延长 |
| **力度记号** | pp, p, mp, mf, f, ff, sfz | P1 | 力度变化 |
| **渐变记号** | crescendo(渐强)、diminuendo(渐弱) | P1 | 渐变力度 |
| **速度标记** | Allegro, Andante, Adagio 等 / BPM | P1 | 速度指示 |
| **反复记号** | 反复线、1/2房子、D.C.、D.S.、Coda、Fine | P1 | 反复结构 |
| **装饰音** | 倚音、颤音、波音、回音 | P2 | 装饰技巧 |
| **踏板记号** | 踏板(Ped.)、释放(*) | P2 | 钢琴专用 |
| **指法标注** | 1-5 指法数字 | P2 | 演奏指导 |
| **歌词** | 对位歌词排版 | P1 | 声乐谱 |

**简谱专业渲染要素**

| 类别 | 渲染元素 | 说明 |
|------|----------|------|
| **音符** | 1 2 3 4 5 6 7、0(休止) | 基础数字音符 |
| **高低八度** | 上方点(高八度)、下方点(低八度) | 支持3个八度 |
| **时值-减时线** | 下划线(八分)、双下划线(十六分) | 缩短时值 |
| **时值-增时线** | 横线(延长)、附点 | 延长时值 |
| **调号** | 1=C, 1=G, 1=F, 1=D 等 | 调性标记 |
| **拍号** | 4/4, 3/4, 2/4, 6/8 等 | 节拍标记 |
| **小节线** | 单竖线、双竖线、终止线 | 小节分隔 |
| **连音线** | 弧线连接 | 同五线谱 |
| **反复记号** | ‖: :‖、D.C.、D.S. | 反复结构 |
| **歌词** | 字对音排版 | 歌曲歌词 |
| **升降音** | #1, b7 等 | 临时变音 |

**双谱对照显示**

```
┌─────────────────────────────────────────────────────────────────┐
│  📖 乐谱查看 - 小星星                    [简谱] [五线谱] [对照]  │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │  五线谱：                                                   │ │
│  │  𝄞 ┃ ♩  ♩ │ ♩  ♩ │ ♩  ♩ │ 𝅗𝅥   │ ♩  ♩ │ ♩  ♩ │ ♩  ♩ │ 𝅗𝅥  ┃│ │
│  │     C  C   G  G   A  A   G      F  F   E  E   D  D   C    │ │
│  └───────────────────────────────────────────────────────────┘ │
│                              ↕ 同步                             │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │  简谱：                                                     │ │
│  │  1=C  4/4                                                  │ │
│  │  1  1 │ 5  5 │ 6  6 │ 5  - │ 4  4 │ 3  3 │ 2  2 │ 1  - │ │ │
│  │  一 闪  一 闪  亮 晶  晶      满 天  都 是  小 星  星       │ │
│  └───────────────────────────────────────────────────────────┘ │
│                                                                 │
│  [🔊 播放]  [⏸ 暂停]  [🔄 循环]  [📥 下载]  [❤️ 收藏]           │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

#### 6.5.2 乐谱导入

```
┌─────────────────────────────────────────────────────────────────┐
│                        📥 导入乐谱                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  选择导入方式：                                                  │
│                                                                 │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐            │
│  │  📄          │  │  🎹          │  │  📝          │            │
│  │  MusicXML   │  │    MIDI     │  │   简谱文本   │            │
│  │   .xml      │  │   .mid      │  │   .txt      │            │
│  │  (推荐)     │  │             │  │             │            │
│  │             │  │             │  │             │            │
│  │  最完整的   │  │  通用格式    │  │  手动输入    │            │
│  │  乐谱信息   │  │  仅音高时值  │  │  快速录入    │            │
│  └─────────────┘  └─────────────┘  └─────────────┘            │
│                                                                 │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐            │
│  │  🔤          │  │  📷          │  │  ☁️          │            │
│  │   ABC记谱   │  │  图片识别   │  │  云端曲库    │            │
│  │   .abc      │  │  .jpg/.png  │  │             │            │
│  │             │  │  (Beta)     │  │             │            │
│  │  民谣常用   │  │  AI智能识别  │  │  在线搜索    │            │
│  └─────────────┘  └─────────────┘  └─────────────┘            │
│                                                                 │
│  ─────────────────────────────────────────────────────────────  │
│                                                                 │
│  最近导入：                                                      │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ 🎵 欢乐颂.xml          2024-01-10  MusicXML            │   │
│  │ 🎵 小星星.mid          2024-01-09  MIDI                │   │
│  │ 🎵 两只老虎.txt        2024-01-08  简谱文本            │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

**支持格式详情**

| 格式 | 扩展名 | 优先级 | 特点 | 适用场景 |
|------|--------|--------|------|----------|
| **MusicXML** | .xml, .mxl | P0 | 业界标准，信息完整 | 专业乐谱交换 |
| **MIDI** | .mid, .midi | P0 | 通用格式，支持广泛 | 音序器导出 |
| **简谱文本** | .txt | P0 | 自定义格式，易于编写 | 手动快速输入 |
| **ABC记谱** | .abc | P2 | 文本格式，简洁 | 民谣/传统音乐 |
| **图片识别** | .jpg, .png | P3 | AI-OCR识别 | 纸质乐谱数字化 |

**简谱文本格式规范**

```
# 小星星
# 1=C 4/4

1 1 | 5 5 | 6 6 | 5 - |
一闪 一闪  亮晶  晶

4 4 | 3 3 | 2 2 | 1 - |
满天 都是  小星  星

# 语法说明：
# 数字1-7表示音符，0表示休止
# -表示延长一拍，_表示连接(八分音符)
# .表示附点，'表示高八度，,表示低八度
# #表示升号，b表示降号
# |表示小节线，||表示终止线
# 歌词直接写在音符下方
```

#### 6.5.3 乐谱编辑器

```
┌─────────────────────────────────────────────────────────────────────┐
│  📝 乐谱编辑器                                    [简谱] [五线谱]    │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  曲名：[小星星                    ]  作曲：[莫扎特               ]  │
│  调号：[1=C     ▼]   拍号：[4/4  ▼]   速度：[Moderato  ▼] 120 BPM │
│                                                                     │
├─────────────────────────────────────────────────────────────────────┤
│  工具栏：                                                            │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │ 音符: [𝅝] [𝅗𝅥] [♩] [♪] [𝅘𝅥𝅯] │ 休止: [𝄻] [𝄼] [𝄽] [𝄾] │ 附点: [.] │   │
│  ├─────────────────────────────────────────────────────────────┤   │
│  │ 变音: [#] [b] [♮] │ 连线: [⌒] │ 小节: [│] [‖] │ 反复: [𝄆] [𝄇] │   │
│  ├─────────────────────────────────────────────────────────────┤   │
│  │ 力度: [p] [mf] [f] │ 渐变: [<] [>] │ 指法: [1-5]            │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
├─────────────────────────────────────────────────────────────────────┤
│  编辑区（简谱模式）：                                                │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │                                                              │   │
│  │   1=C  4/4                         《小星星》                 │   │
│  │                                                              │   │
│  │   ┌─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┐        │   │
│  │   │ 1   │ 1   │ 5   │ 5   │ 6   │ 6   │ 5   │ -   │ ← 当前 │   │
│  │   │ 一  │ 闪  │ 一  │ 闪  │ 亮  │ 晶  │ 晶  │     │        │   │
│  │   └─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┘        │   │
│  │                                                              │   │
│  │   ┌─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┐        │   │
│  │   │ 4   │ 4   │ 3   │ 3   │ 2   │ 2   │ 1   │ -   │        │   │
│  │   │ 满  │ 天  │ 都  │ 是  │ 小  │ 星  │ 星  │     │        │   │
│  │   └─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┘        │   │
│  │                                                              │   │
│  │   [+ 添加小节]                                               │   │
│  │                                                              │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
├─────────────────────────────────────────────────────────────────────┤
│  歌词编辑：                                                          │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │ 一闪一闪亮晶晶，满天都是小星星...                             │   │
│  └─────────────────────────────────────────────────────────────┘   │
│  [自动对齐] [手动调整]                                              │
│                                                                     │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  [▶️ 试听] [💾 保存] [📤 导出] [🔄 简谱⇄五线谱] [↩️ 撤销] [↪️ 重做]   │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

**编辑功能**

| 功能 | 说明 | 优先级 |
|------|------|--------|
| **音符输入** | 点击/键盘输入音符 | P0 |
| **时值选择** | 全音符～三十二分音符 | P0 |
| **调号设置** | 所有大小调 | P0 |
| **拍号设置** | 常见拍号 | P0 |
| **小节管理** | 添加/删除/插入小节 | P0 |
| **歌词编辑** | 对位歌词输入 | P1 |
| **连线绘制** | 连音线/圆滑线 | P1 |
| **力度标记** | 力度记号添加 | P2 |
| **指法标注** | 1-5指法 | P2 |
| **撤销/重做** | 操作历史 | P0 |
| **简谱⇄五线谱** | 双向转换 | P1 |
| **导出** | MusicXML/MIDI/PDF/图片 | P1 |

#### 6.5.4 乐谱播放器

```
┌─────────────────────────────────────────────────────────────────────┐
│  🎵 正在播放：小星星                                 Wolfgang Mozart │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  显示模式：[简谱] [五线谱] [双谱对照] [带键盘]                        │
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │                                                              │   │
│  │   1=C  4/4                              第 1/4 小节           │   │
│  │                                                              │   │
│  │   1   1  │ 5   5  │ 6   6  │ 5   -  │                       │   │
│  │   ▲                                      ← 当前播放位置       │   │
│  │   一  闪   一  闪   亮  晶   晶                                │   │
│  │                                                              │   │
│  │   4   4  │ 3   3  │ 2   2  │ 1   -  │                       │   │
│  │   满  天   都  是   小  星   星                                │   │
│  │                                                              │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │                      虚拟键盘                                 │   │
│  │    ┌─┐ ┌─┐   ┌─┐ ┌─┐ ┌─┐   ┌─┐ ┌─┐   ┌─┐ ┌─┐ ┌─┐         │   │
│  │    │ │ │ │   │ │ │ │ │ │   │ │ │ │   │ │ │ │ │ │         │   │
│  │    └┬┘ └┬┘   └┬┘ └┬┘ └┬┘   └┬┘ └┬┘   └┬┘ └┬┘ └┬┘         │   │
│  │   ┌─┴┬──┴┬────┴┬──┴┬──┴┬────┴┬──┴┬────┴┬──┴┬──┴┬────┐    │   │
│  │   │★ │ D │ E  │ F │ G │ A  │ B │ C' │ D'│ E'│ F' │    │   │
│  │   │1 │ 2 │ 3  │ 4 │ 5 │ 6  │ 7 │ 1' │ 2'│ 3'│ 4' │    │   │
│  │   └──┴───┴────┴───┴───┴────┴───┴────┴───┴───┴────┘    │   │
│  │                 ★ = 当前音符高亮                          │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
│  ━━━━━━●━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━  0:05 / 0:32    │
│                                                                     │
├─────────────────────────────────────────────────────────────────────┤
│  播放控制：                                                          │
│                                                                     │
│  [⏮️ 上一句] [⏪ -5s]  [▶️ 播放/⏸️ 暂停]  [⏩ +5s] [⏭️ 下一句]       │
│                                                                     │
│  速度：[🐢 0.5x] [0.75x] [★1.0x] [1.25x] [1.5x] [🐰 2.0x]          │
│                                                                     │
│  循环：[🔁 整曲循环] [🔂 单句循环] [📍 A-B循环]   当前：A-B循环       │
│                                                                     │
│  练习模式：[👀 跟看] [👂 跟听] [🎹 跟弹]                              │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

**播放功能**

| 功能 | 说明 | 优先级 |
|------|------|--------|
| **基础播放** | 播放/暂停/停止 | P0 |
| **进度控制** | 进度条拖拽、前进后退 | P0 |
| **速度调节** | 0.5x ~ 2.0x | P0 |
| **当前音符高亮** | 乐谱+键盘同步高亮 | P0 |
| **循环播放** | 整曲/单句/A-B区间 | P1 |
| **分轨播放** | 左手/右手/伴奏分离 | P2 |
| **跟弹模式** | 等待用户弹对才继续 | P1 |
| **节拍器同步** | 播放时显示节拍 | P1 |

#### 6.5.5 乐谱数据格式设计

**内部存储格式（JSON）**

```json
{
  "id": "sheet_001",
  "title": "小星星",
  "composer": "莫扎特",
  "arranger": null,
  "difficulty": 1,
  "tags": ["入门", "儿歌", "钢琴"],
  "metadata": {
    "key": "C",
    "timeSignature": "4/4",
    "tempo": 120,
    "tempoText": "Moderato"
  },
  "tracks": [
    {
      "id": "track_1",
      "name": "旋律",
      "clef": "treble",
      "measures": [
        {
          "number": 1,
          "notes": [
            {"pitch": "C4", "duration": "quarter", "lyric": "一"},
            {"pitch": "C4", "duration": "quarter", "lyric": "闪"},
            {"pitch": "G4", "duration": "quarter", "lyric": "一"},
            {"pitch": "G4", "duration": "quarter", "lyric": "闪"}
          ]
        },
        {
          "number": 2,
          "notes": [
            {"pitch": "A4", "duration": "quarter", "lyric": "亮"},
            {"pitch": "A4", "duration": "quarter", "lyric": "晶"},
            {"pitch": "G4", "duration": "half", "lyric": "晶"}
          ]
        }
      ]
    }
  ],
  "jianpuText": "1=C 4/4\n1 1 | 5 5 | 6 6 | 5 - |\n一闪 一闪 亮晶 晶",
  "createdAt": "2024-01-10T10:00:00Z",
  "updatedAt": "2024-01-10T10:00:00Z"
}
```

---

## 七、页面结构（信息架构）

```
App
├── 启动页 (SplashPage)
├── 引导页 (OnboardingPage) - 首次使用
│
├── 主框架 (MainFrame) - 底部导航
│   │
│   ├── 🏠 首页 Tab (HomePage)
│   │   ├── 今日任务卡片
│   │   ├── 学习地图（课程进度）
│   │   ├── 继续学习入口
│   │   └── 推荐练习
│   │
│   ├── 📚 课程 Tab (CoursePage)
│   │   ├── 课程分类（简谱/五线谱/钢琴）
│   │   ├── 课程列表页 (CourseListPage)
│   │   ├── 课程详情页 (CourseDetailPage)
│   │   └── 课程学习页 (CourseLearningPage)
│   │       ├── 图文课程
│   │       ├── 视频课程
│   │       └── 互动课程
│   │
│   ├── 🎯 练习 Tab (PracticePage)
│   │   ├── 练习类型选择
│   │   │   ├── 识谱练习
│   │   │   ├── 节奏练习
│   │   │   ├── 听音练习
│   │   │   └── 弹奏练习
│   │   ├── 练习进行页 (PracticePlayPage)
│   │   └── 练习结果页 (PracticeResultPage)
│   │
│   └── 👤 我的 Tab (ProfilePage)
│       ├── 用户信息
│       ├── 学习统计 (StatisticsPage)
│       ├── 成就徽章 (AchievementPage)
│       ├── 收藏夹 (FavoritesPage)
│       └── 设置 (SettingsPage)
│
├── 工具（可从多处进入）
│   ├── 虚拟钢琴 (PianoPage)
│   ├── 节拍器 (MetronomePage)
│   ├── 对照表 (ReferenceTablePage)
│   │
│   └── 乐谱系统 (SheetMusicModule)
│       ├── 乐谱库首页 (SheetLibraryPage)
│       │   ├── 内置乐谱列表
│       │   ├── 我的乐谱列表
│       │   └── 搜索/筛选
│       ├── 乐谱详情/播放 (SheetPlayerPage)
│       │   ├── 简谱视图
│       │   ├── 五线谱视图
│       │   ├── 双谱对照视图
│       │   ├── 键盘联动视图
│       │   └── 播放控制器
│       ├── 乐谱编辑器 (SheetEditorPage)
│       │   ├── 简谱编辑模式
│       │   ├── 五线谱编辑模式
│       │   ├── 歌词编辑
│       │   └── 工具栏
│       └── 乐谱导入 (SheetImportPage)
│           ├── 文件选择
│           ├── 格式解析
│           └── 预览确认
│
└── 通用组件
    ├── 五线谱渲染组件 (StaffNotationWidget)
    │   ├── 谱号渲染
    │   ├── 音符渲染
    │   ├── 小节线渲染
    │   └── 各种记号渲染
    ├── 简谱渲染组件 (JianpuNotationWidget)
    │   ├── 数字音符
    │   ├── 时值标记
    │   ├── 歌词对齐
    │   └── 小节布局
    ├── 钢琴键盘组件 (PianoKeyboardWidget)
    ├── 节拍器组件 (MetronomeWidget)
    ├── 乐谱播放器组件 (SheetPlayerWidget)
    ├── 音频播放器组件 (AudioPlayerWidget)
    └── 进度指示器组件 (ProgressWidget)
```

---

## 八、数据模型设计

### 8.1 用户模型

```dart
/// 用户信息
class UserModel {
  final String id;
  final String nickname;
  final String? avatar;
  final int totalStudyMinutes;     // 总学习时长（分钟）
  final int consecutiveDays;       // 连续学习天数
  final int totalPracticeCount;    // 总练习次数
  final int correctCount;          // 总正确数
  final DateTime createdAt;
  final DateTime lastActiveAt;
}

/// 用户设置
class UserSettings {
  final String themeMode;          // light / dark / system
  final bool soundEnabled;
  final bool vibrationEnabled;
  final String reminderTime;       // 每日提醒时间
  final bool reminderEnabled;
}
```

### 8.2 课程模型

```dart
/// 课程分类
class CourseCategory {
  final String id;
  final String name;               // 简谱入门 / 五线谱入门 / 钢琴入门
  final String icon;
  final int totalLessons;
  final int completedLessons;
}

/// 课程
class CourseModel {
  final String id;
  final String categoryId;
  final int order;                 // 课程顺序
  final String title;
  final String description;
  final String type;               // video / text / interactive
  final int durationMinutes;
  final bool isLocked;
  final bool isCompleted;
}

/// 课程内容
class LessonContent {
  final String lessonId;
  final List<ContentBlock> blocks; // 内容块列表
}

/// 内容块（图文/视频/互动）
class ContentBlock {
  final String type;               // text / image / video / quiz / interactive
  final Map<String, dynamic> data;
}
```

### 8.3 练习模型

```dart
/// 练习类型
enum PracticeType {
  noteRecognition,    // 音符识别
  rhythmTapping,      // 节奏敲击
  earTraining,        // 听音辨别
  pianoPlaying,       // 弹奏练习
}

/// 练习题目
class PracticeQuestion {
  final String id;
  final PracticeType type;
  final int difficulty;            // 难度 1-5
  final Map<String, dynamic> question;  // 题目内容
  final dynamic correctAnswer;
  final List<dynamic>? options;    // 选项（如果是选择题）
}

/// 练习记录
class PracticeRecord {
  final String odatetime;
  final PracticeType type;
  final int difficulty;
  final int totalQuestions;
  final int correctCount;
  final int durationSeconds;
  final DateTime practiceAt;
}
```

### 8.4 音乐基础模型

```dart
/// 音符（单个音）
class NoteModel {
  final String name;               // C4, D4, E4...
  final int midiNumber;            // MIDI 编号 (21-108)
  final int octave;                // 八度 (0-8)
  final String jianpu;             // 简谱表示 "1", "2", "#1", "1'"
  final int staffPosition;         // 五线谱位置（相对于中央C）
  final String clef;               // treble / bass
}

/// 节奏型
class RhythmPattern {
  final String id;
  final String name;
  final List<double> beats;        // 节拍时值列表
  final int difficulty;
}

/// 音符时值枚举
enum NoteDuration {
  whole,          // 全音符 (4拍)
  half,           // 二分音符 (2拍)
  quarter,        // 四分音符 (1拍)
  eighth,         // 八分音符 (0.5拍)
  sixteenth,      // 十六分音符 (0.25拍)
  thirtySecond,   // 三十二分音符 (0.125拍)
}
```

### 8.5 乐谱数据模型

```dart
/// 乐谱元数据
class SheetMetadata {
  final String key;                // 调号: "C", "G", "F", "D", "Bb" 等
  final String timeSignature;      // 拍号: "4/4", "3/4", "6/8" 等
  final int tempo;                 // 速度 BPM
  final String? tempoText;         // 速度术语: "Allegro", "Andante" 等
}

/// 乐谱音符（带时值和位置）
class SheetNote {
  final String pitch;              // 音高: "C4", "D#5", "Bb3"
  final NoteDuration duration;     // 时值
  final bool isDotted;             // 是否附点
  final String? lyric;             // 对应歌词
  final String? accidental;        // 临时升降号: "#", "b", "natural"
  final int? fingering;            // 指法 1-5
  final String? articulation;      // 奏法: "staccato", "accent", "tenuto"
}

/// 小节
class SheetMeasure {
  final int number;                // 小节号
  final List<SheetNote> notes;     // 音符列表
  final String? startRepeat;       // 反复开始记号
  final String? endRepeat;         // 反复结束记号
  final String? ending;            // 1/2房子: "1", "2"
  final String? dynamics;          // 力度记号: "p", "f", "mf"
}

/// 音轨（用于多声部/双手）
class SheetTrack {
  final String id;
  final String name;               // "旋律", "左手", "右手", "伴奏"
  final String clef;               // "treble", "bass", "alto"
  final List<SheetMeasure> measures;
}

/// 完整乐谱
class SheetMusic {
  final String id;
  final String title;              // 曲名
  final String? subtitle;          // 副标题
  final String? composer;          // 作曲
  final String? arranger;          // 编曲
  final String? lyricist;          // 作词
  final int difficulty;            // 难度 1-5
  final List<String> tags;         // 标签
  final SheetMetadata metadata;    // 元数据
  final List<SheetTrack> tracks;   // 音轨列表
  final String? jianpuText;        // 简谱文本（快速预览）
  final String? audioUrl;          // 示范音频
  final String? coverUrl;          // 封面图
  final bool isFavorite;           // 是否收藏
  final bool isBuiltIn;            // 是否内置
  final String? sourceFormat;      // 来源格式: "musicxml", "midi", "text"
  final DateTime createdAt;
  final DateTime updatedAt;
}

/// 乐谱播放状态
class SheetPlaybackState {
  final bool isPlaying;
  final int currentMeasure;        // 当前小节
  final int currentNoteIndex;      // 当前音符索引
  final double currentTime;        // 当前播放时间（秒）
  final double totalDuration;      // 总时长
  final double playbackSpeed;      // 播放速度 0.5-2.0
  final bool isLooping;            // 是否循环
  final int? loopStartMeasure;     // 循环起点
  final int? loopEndMeasure;       // 循环终点
}

/// 乐谱收藏/我的乐谱
class UserSheetMusic {
  final String id;
  final String sheetId;            // 关联的乐谱ID
  final String? customTitle;       // 用户自定义标题
  final String? notes;             // 用户笔记
  final int practiceCount;         // 练习次数
  final DateTime? lastPracticeAt;  // 最后练习时间
  final double? bestAccuracy;      // 最佳准确率
  final DateTime addedAt;
}
```

### 8.6 乐谱导入/导出模型

```dart
/// 导入配置
class SheetImportConfig {
  final String sourceFormat;       // "musicxml", "midi", "abc", "text"
  final String? filePath;
  final String? textContent;
  final bool autoDetectKey;        // 自动检测调号
  final bool autoDetectTempo;      // 自动检测速度
}

/// 导入结果
class SheetImportResult {
  final bool success;
  final SheetMusic? sheet;
  final String? errorMessage;
  final List<String>? warnings;    // 导入警告（如：部分记号不支持）
}

/// 导出配置
class SheetExportConfig {
  final String targetFormat;       // "musicxml", "midi", "pdf", "png", "text"
  final bool includeMetadata;
  final bool includeLyrics;
  final bool includeFingering;
  final String? paperSize;         // "A4", "Letter" (for PDF)
}
```

### 8.7 成就模型

```dart
/// 成就
class Achievement {
  final String id;
  final String name;
  final String description;
  final String icon;
  final String condition;          // 达成条件描述
  final bool isUnlocked;
  final DateTime? unlockedAt;
}

/// 成就类型示例
/*
- 初次启程：完成第一节课
- 坚持不懈：连续学习7天
- 千里之行：完成1000道练习题
- 火眼金睛：识谱正确率达到95%
- 节奏大师：节奏练习满分
- 小星星：完成《小星星》弹奏
- 毕业典礼：完成全部课程
*/
```

---

## 九、技术实现要点

### 9.1 核心组件

| 组件 | 功能 | 技术方案 |
|------|------|---------|
| **五线谱渲染** | 渲染五线谱、音符、谱号 | CustomPainter 自绘 |
| **简谱渲染** | 渲染简谱、时值线、歌词 | CustomPainter 自绘 |
| **钢琴键盘** | 虚拟钢琴、多点触控 | GestureDetector + 音频 |
| **音频播放** | 播放音符、示范音频 | just_audio / audioplayers |
| **节拍器** | 精准节拍、可视化 | Timer + 音频 |
| **乐谱播放器** | 同步播放+高亮 | 自定义控制器 |
| **MIDI支持** | 外接MIDI键盘（预留） | flutter_midi |

### 9.2 乐谱渲染技术方案

#### 9.2.1 五线谱渲染架构

```
┌─────────────────────────────────────────────────────────────┐
│                    StaffNotationWidget                       │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │                StaffPainter (CustomPainter)          │   │
│  │  ┌───────────────────────────────────────────────┐  │   │
│  │  │  StaffLineRenderer    - 五线渲染               │  │   │
│  │  │  ClefRenderer         - 谱号渲染               │  │   │
│  │  │  KeySignatureRenderer - 调号渲染               │  │   │
│  │  │  TimeSignatureRenderer- 拍号渲染               │  │   │
│  │  │  NoteRenderer         - 音符渲染               │  │   │
│  │  │  RestRenderer         - 休止符渲染             │  │   │
│  │  │  BarlineRenderer      - 小节线渲染             │  │   │
│  │  │  BeamRenderer         - 符杠渲染               │  │   │
│  │  │  TieSlurRenderer      - 连线渲染               │  │   │
│  │  │  DynamicsRenderer     - 力度记号渲染           │  │   │
│  │  │  LyricRenderer        - 歌词渲染               │  │   │
│  │  └───────────────────────────────────────────────┘  │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  LayoutEngine - 布局计算                             │   │
│  │  - 音符间距计算                                       │   │
│  │  - 小节宽度计算                                       │   │
│  │  - 换行计算                                           │   │
│  │  - 符杠分组                                           │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

**五线谱渲染关键参数**

| 参数 | 说明 | 典型值 |
|------|------|--------|
| staffLineSpacing | 线间距 | 8-12px |
| noteHeadWidth | 符头宽度 | 10-14px |
| stemHeight | 符干高度 | 3.5 × lineSpacing |
| beamThickness | 符杠厚度 | 0.5 × lineSpacing |
| measureMinWidth | 小节最小宽度 | 80px |

#### 9.2.2 简谱渲染架构

```
┌─────────────────────────────────────────────────────────────┐
│                    JianpuNotationWidget                      │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │                JianpuPainter (CustomPainter)         │   │
│  │  ┌───────────────────────────────────────────────┐  │   │
│  │  │  HeaderRenderer       - 调号拍号标题渲染       │  │   │
│  │  │  NoteNumberRenderer   - 数字音符渲染           │  │   │
│  │  │  OctaveDotRenderer    - 高低八度点渲染         │  │   │
│  │  │  DurationLineRenderer - 时值线渲染(下划线)     │  │   │
│  │  │  ExtensionLineRenderer- 延长线渲染(横线)       │  │   │
│  │  │  DotRenderer          - 附点渲染               │  │   │
│  │  │  BarlineRenderer      - 小节线渲染             │  │   │
│  │  │  TieRenderer          - 连音线渲染             │  │   │
│  │  │  LyricRenderer        - 歌词渲染               │  │   │
│  │  └───────────────────────────────────────────────┘  │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

**简谱渲染规则**

```
音符表示：
  1 2 3 4 5 6 7   - 基本音符
  0               - 休止符
  1̇ 2̇ 3̇           - 高八度（上方加点）
  1̣ 2̣ 3̣           - 低八度（下方加点）
  #1 b7           - 升降音

时值表示：
  1               - 四分音符（一拍）
  1 -             - 二分音符（两拍）
  1 - - -         - 全音符（四拍）
  1̲               - 八分音符（下划线）
  1̲̲              - 十六分音符（双下划线）
  1.              - 附点（增加一半时值）

连接表示：
  1͡2              - 连音线（同音相连）
  1⁀2             - 圆滑线（不同音连奏）
```

### 9.3 乐谱格式解析

#### MusicXML 解析

```dart
class MusicXMLParser {
  /// 解析 MusicXML 文件
  Future<SheetMusic> parse(String xmlContent) async {
    // 1. 解析 XML DOM
    // 2. 提取 <part-list> 获取声部信息
    // 3. 解析 <attributes> 获取调号、拍号
    // 4. 遍历 <measure> 解析各小节
    // 5. 解析 <note> 获取音高、时值
    // 6. 解析 <lyric> 获取歌词
    // 7. 构建 SheetMusic 对象
  }
}
```

#### MIDI 解析

```dart
class MIDIParser {
  /// 解析 MIDI 文件
  Future<SheetMusic> parse(Uint8List midiData) async {
    // 1. 解析 MIDI Header（格式、轨道数、时间分辨率）
    // 2. 解析各轨道的 MIDI 事件
    // 3. 提取 Note On/Off 事件
    // 4. 计算音符时值
    // 5. 量化到标准时值
    // 6. 构建 SheetMusic 对象
  }
}
```

#### 简谱文本解析

```dart
class JianpuTextParser {
  /// 解析简谱文本
  Future<SheetMusic> parse(String text) async {
    // 1. 解析头部信息（调号、拍号）
    // 2. 按行解析音符
    // 3. 识别时值标记（下划线、横线、附点）
    // 4. 识别八度标记（点）
    // 5. 解析歌词行
    // 6. 对齐音符和歌词
    // 7. 构建 SheetMusic 对象
  }
}
```

### 9.4 数据存储

| 数据类型 | 存储方案 | 说明 |
|---------|---------|------|
| 用户设置 | SharedPreferences | 轻量级键值存储 |
| 学习进度 | Hive | 高性能NoSQL |
| 练习记录 | Hive | 结构化数据 |
| 课程内容 | 本地 JSON + 远程更新 | 版本控制 |
| 内置乐谱 | Assets JSON | 随应用分发 |
| 用户乐谱 | Hive + 文件系统 | 用户创建/导入 |
| 音频文件 | Assets / 缓存 | 按需加载 |

### 9.5 音频资源

需要准备的音频：
- 88个钢琴音（A0-C8，MIDI 21-108）✅ 已生成
- 节拍器音效（强拍/弱拍）✅ 已生成
- 正确/错误/完成/升级提示音 ✅ 已生成
- 示范曲目音频（可选，或实时合成）

### 9.6 性能优化

| 优化点 | 方案 |
|--------|------|
| 乐谱渲染 | 虚拟化长乐谱，只渲染可见区域 |
| 音频预加载 | 预加载常用音域音符 |
| 乐谱缓存 | 解析结果缓存，避免重复解析 |
| 图片导出 | 后台线程处理，避免UI卡顿 |

---

## 十、开发计划

### 10.1 MVP 版本（v1.0）

| 阶段 | 内容 | 预计时间 |
|------|------|---------|
| P1 | 项目搭建、基础架构 | 1周 |
| P2 | 虚拟钢琴组件 | 1周 |
| P3 | 五线谱渲染组件 | 1周 |
| P4 | 简谱入门课程（5课） | 1周 |
| P5 | 基础识谱练习 | 1周 |
| P6 | 我的模块、数据持久化 | 1周 |

**MVP 功能**：
- ✅ 虚拟钢琴（可弹奏）
- ✅ 简谱入门（5课）
- ✅ 识谱练习（简谱）
- ✅ 学习进度记录

### 10.2 完整版本（v2.0）

- 全部 45 节课程
- 五线谱渲染和练习
- 节奏练习
- 弹奏练习
- 节拍器工具
- 乐谱库
- 成就系统
- 数据统计

---

## 十一、待确认问题

1. **App 名称**：乐理通 / MusicStart / 其他？
2. **课程是否需要付费/VIP 模式**？
3. **是否需要用户登录/云同步**？
4. **是否需要社区/分享功能**？
5. **首发平台优先级**？
6. **乐谱图片识别(OCR)**：是否需要？技术难度较高
7. **云端曲库**：是否需要在线乐谱库？涉及版权问题
8. **乐谱分享**：用户是否可以分享自己创建的乐谱？

---

## 十二、版本规划补充

### 12.1 乐谱系统开发阶段

| 阶段 | 功能 | 优先级 | 预计时间 |
|------|------|--------|----------|
| **Phase 1** | 简谱渲染、内置乐谱库、基础播放 | P0 | 2周 |
| **Phase 2** | 五线谱渲染、双谱对照、键盘联动 | P0 | 2周 |
| **Phase 3** | 乐谱导入（MusicXML/MIDI） | P1 | 1周 |
| **Phase 4** | 简谱编辑器 | P1 | 2周 |
| **Phase 5** | 五线谱编辑器 | P2 | 2周 |
| **Phase 6** | 乐谱导出（PDF/图片） | P2 | 1周 |
| **Phase 7** | 简谱文本导入、ABC记谱 | P2 | 1周 |
| **Phase 8** | 图片识别（AI-OCR） | P3 | 待定 |

### 12.2 MVP 乐谱功能

- ✅ 简谱渲染（数字、时值、歌词）
- ✅ 内置10首入门乐谱
- ✅ 乐谱播放（速度可调）
- ✅ 当前音符高亮
- ⬜ 五线谱渲染（基础）
- ⬜ 双谱对照显示

---

*文档版本：v2.0*  
*更新时间：2026年1月*  
*更新内容：新增乐谱系统完整设计*

