# ä¹è°±å¯¼å…¥å¯¼å‡ºä¼˜åŒ–æ–¹æ¡ˆ

> **ç‰ˆæœ¬**: v1.0
> **æ—¥æœŸ**: 2026-02-06
> **çŠ¶æ€**: å®æ–½ä¸­

---

## 1. é—®é¢˜åˆ†æ

### 1.1 æ ¸å¿ƒé—®é¢˜

| é—®é¢˜ | å½±å“ | ä¸¥é‡æ€§ |
|------|------|--------|
| Beat.totalBeats å’Œå¼¦è®¡ç®—é”™è¯¯ | æ‰€æœ‰æ ¼å¼çš„æ—¶é•¿è®¡ç®—ä¸å‡†ç¡® | ğŸ”´ é«˜ |
| MIDIå¤šè½¨è¯†åˆ«ç®€å•ç²—æš´ | å¤šå£°éƒ¨ä½œå“è¢«é”™è¯¯åˆå¹¶ | ğŸ”´ é«˜ |
| MIDIå¯¼å‡ºä¿¡æ¯ä¸å®Œæ•´ | velocityå›ºå®šã€è¸æ¿ä¸¢å¤± | ğŸŸ¡ ä¸­ |
| MusicXMLå¯¼å‡ºä¸ä¸“ä¸š | divisionså›ºå®šã€ç¼ºå°‘notations | ğŸŸ¡ ä¸­ |
| æ— å¯¼å…¥é¢„è§ˆå’Œé€‰é¡¹é…ç½® | ç”¨æˆ·æ— æ³•æ§åˆ¶å¯¼å…¥è¡Œä¸º | ğŸŸ¡ ä¸­ |

### 1.2 æ•°æ®å®Œæ•´æ€§å¯¹æ¯”

| æ ¼å¼ | å½“å‰å®Œæ•´æ€§ | ä¼˜åŒ–åç›®æ ‡ |
|------|-----------|-----------|
| JSON | 100% âœ… | 100% âœ… |
| MIDI | 60% âš ï¸ | 90% âœ… |
| MusicXML | 70% âš ï¸ | 95% âœ… |
| ç®€è°±æ–‡æœ¬ | 40% âš ï¸ | 50% (ä¸é‡ç‚¹ä¼˜åŒ–) |

---

## 2. è§£å†³æ–¹æ¡ˆè®¾è®¡

### 2.1 Beat.totalBeats ä¿®å¤

**é—®é¢˜ä»£ç **ï¼š
```dart
// é”™è¯¯ï¼šç´¯åŠ æ‰€æœ‰éŸ³ç¬¦æ—¶å€¼
double get totalBeats {
  double total = 0.0;
  for (final note in notes) {
    total += note.actualBeats;  // âŒ å’Œå¼¦åº”è¯¥å–æœ€å¤§å€¼
  }
  return total;
}
```

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
```dart
// æ­£ç¡®ï¼šå–æœ€é•¿éŸ³ç¬¦çš„æ—¶å€¼
double get totalBeats {
  if (notes.isEmpty) return 1.0;

  // å’Œå¼¦ï¼šå–æœ€é•¿éŸ³ç¬¦çš„æ—¶å€¼
  double maxBeats = 0.0;
  for (final note in notes) {
    final noteBeats = note.actualBeats;
    if (noteBeats > maxBeats) {
      maxBeats = noteBeats;
    }
  }

  // åº”ç”¨ä¸‰è¿éŸ³å€æ•°
  if (tuplet != null) {
    maxBeats *= tuplet!.timeMultiplier;
  }

  return maxBeats;
}
```

---

### 2.2 MIDI æ™ºèƒ½è½¨é“åˆ†æ

#### è®¾è®¡åŸåˆ™

1. **ä¿ç•™åŸå§‹ç»“æ„ä¼˜å…ˆ**ï¼šå°½å¯èƒ½ä¿ç•™MIDIçš„åŸå§‹è½¨é“ä¿¡æ¯
2. **æ™ºèƒ½è¯†åˆ«é’¢ç´è°±**ï¼šè‡ªåŠ¨è¯†åˆ«å…¸å‹çš„é’¢ç´åŒæ‰‹è°±å¹¶åˆå¹¶
3. **ç”¨æˆ·å¯æ§**ï¼šæä¾›é…ç½®é€‰é¡¹å’Œé¢„è§ˆç•Œé¢

#### è½¨é“ç‰¹å¾åˆ†æ

```dart
class TrackCharacteristics {
  final double avgPitch;        // å¹³å‡éŸ³é«˜
  final int pitchRange;         // éŸ³åŸŸèŒƒå›´
  final double chordDensity;    // å’Œå¼¦å¯†åº¦ï¼ˆ0.0-1.0ï¼‰
  final int noteCount;          // éŸ³ç¬¦æ•°é‡
  final String? trackName;      // è½¨é“åç§°
}
```

#### æ™ºèƒ½åˆ†ç»„ç­–ç•¥

```
åˆ¤æ–­æµç¨‹ï¼š

1. è¿‡æ»¤è½¨é“
   â”œâ”€ ç§»é™¤ç©ºè½¨é“
   â”œâ”€ ç§»é™¤æ‰“å‡»ä¹è½¨é“ (Channel 10)
   â””â”€ é™åˆ¶è½¨é“æ•°é‡ (maxTracks)

2. åˆ†æç‰¹å¾
   â”œâ”€ è®¡ç®—æ¯ä¸ªè½¨é“çš„ avgPitch, pitchRange, chordDensity
   â””â”€ æå–è½¨é“åç§° (Meta Event 0x03)

3. åˆ¤æ–­ç±»å‹
   â”œâ”€ å¦‚æœæ˜¯é’¢ç´è°± (2-4è½¨ï¼ŒéŸ³åŸŸåˆ†ç¦»æ˜æ˜¾)
   â”‚  â””â”€ æŒ‰éŸ³é«˜åˆ†ç»„ â†’ åˆå¹¶ä¸ºå·¦å³æ‰‹2è½¨
   â””â”€ å¦åˆ™ (å¤šå£°éƒ¨ä½œå“)
      â””â”€ ä¿ç•™æ‰€æœ‰ç‹¬ç«‹è½¨é“

4. ç”Ÿæˆé¢„è§ˆä¿¡æ¯
   â””â”€ è¿”å›è¯†åˆ«ç»“æœä¾›ç”¨æˆ·ç¡®è®¤
```

#### é’¢ç´è°±åˆ¤æ–­æ¡ä»¶

```dart
bool _isPianoScore(List<TrackCharacteristics> chars) {
  // 1. è½¨é“æ•°é‡ï¼š2-4ä¸ª
  if (chars.length < 2 || chars.length > 4) return false;

  // 2. éŸ³åŸŸåˆ†ç¦»ï¼šç›¸å·®2ä¸ªå…«åº¦ä»¥ä¸Š
  final avgPitches = chars.map((c) => c.avgPitch).toList();
  avgPitches.sort();
  final separation = avgPitches.last - avgPitches.first;
  if (separation < 24) return false;

  // 3. é«˜ä½éŸ³å£°éƒ¨éƒ½å­˜åœ¨
  final hasHighPart = avgPitches.any((p) => p >= 60);  // C4ä»¥ä¸Š
  final hasLowPart = avgPitches.any((p) => p < 60);    // C4ä»¥ä¸‹

  return hasHighPart && hasLowPart;
}
```

---

### 2.3 MIDI å¯¼å‡ºä¼˜åŒ–

#### æ–°å¢åŠŸèƒ½

| åŠŸèƒ½ | MIDIæ ‡å‡†æ”¯æŒ | å®ç°æ–¹å¼ |
|------|------------|---------|
| åŠ¨æ€åŠ›åº¦ | âœ… Note Velocity | dynamics â†’ velocityæ˜ å°„ |
| è¸æ¿ä¿¡æ¯ | âœ… CC#64 | Control Changeäº‹ä»¶ |
| è½¨é“åç§° | âœ… Meta Event 0x03 | Track Nameäº‹ä»¶ |
| ç²¾ç¡®timing | âœ… PPQ | ä½¿ç”¨score.metadata.ppq |

#### Velocity æ˜ å°„è¡¨

```dart
int _dynamicsToVelocity(Dynamics? dynamics) {
  const velocityMap = {
    Dynamics.ppp: 20,
    Dynamics.pp: 35,
    Dynamics.p: 50,
    Dynamics.mp: 64,
    Dynamics.mf: 80,
    Dynamics.f: 96,
    Dynamics.ff: 112,
    Dynamics.fff: 127,
  };
  return velocityMap[dynamics] ?? 80;  // é»˜è®¤mf
}
```

#### è¸æ¿äº‹ä»¶å†™å…¥

```dart
// è¸æ¿å¼€å§‹
if (measure.pedal == PedalMark.start) {
  _writeControlChange(buffer, tick, 64, 127);
}

// è¸æ¿ç»“æŸ
if (measure.pedal == PedalMark.end) {
  _writeControlChange(buffer, tick, 64, 0);
}

// æ¢è¸æ¿
if (measure.pedal == PedalMark.change) {
  _writeControlChange(buffer, tick, 64, 0);
  _writeControlChange(buffer, tick + 1, 64, 127);
}
```

---

### 2.4 MusicXML å¯¼å‡ºä¼˜åŒ–

#### æ”¹è¿›ç‚¹

1. **é«˜ç²¾åº¦ divisions**
   - æ—§ï¼šå›ºå®š divisions=4
   - æ–°ï¼šä½¿ç”¨ divisions=ppq (é»˜è®¤480)

2. **å®Œæ•´çš„ notations**
   ```xml
   <notations>
     <!-- è£…é¥°éŸ³ -->
     <ornaments>
       <trill-mark/>
       <mordent/>
       <turn/>
     </ornaments>

     <!-- å¥æ³• -->
     <articulations>
       <staccato/>
       <accent/>
       <tenuto/>
     </articulations>

     <!-- è¿éŸ³çº¿ -->
     <tied type="start"/>
     <slur type="start" number="1"/>
   </notations>
   ```

3. **å®Œæ•´çš„ direction**
   ```xml
   <!-- åŠ›åº¦ -->
   <direction placement="below">
     <direction-type>
       <dynamics><mf/></dynamics>
     </direction-type>
   </direction>

   <!-- è¸æ¿ -->
   <direction placement="below">
     <direction-type>
       <pedal type="start" line="yes"/>
     </direction-type>
   </direction>
   ```

4. **æ‰©å±•å­—æ®µå­˜å‚¨**
   ```xml
   <!-- ä¿å­˜è‡ªå®šä¹‰å­—æ®µç”¨äºå®Œæ•´å¾€è¿” -->
   <note>
     <miscellaneous>
       <miscellaneous-field name="preciseOffsetBeats">0.0234</miscellaneous-field>
       <miscellaneous-field name="preciseDurationBeats">1.9876</miscellaneous-field>
     </miscellaneous>
   </note>
   ```

---

### 2.5 å¯¼å…¥å¯¼å‡ºé…ç½®

#### MIDI å¯¼å…¥é…ç½®

```dart
class MidiImportOptions {
  /// å¯¼å…¥æ¨¡å¼
  final MidiImportMode mode;

  /// æ˜¯å¦è·³è¿‡ç©ºè½¨é“
  final bool skipEmptyTracks;

  /// æ˜¯å¦è·³è¿‡æ‰“å‡»ä¹è½¨é“ (Channel 10)
  final bool skipPercussion;

  /// æœ€å¤§è½¨é“æ•°é‡é™åˆ¶
  final int maxTracks;

  const MidiImportOptions({
    this.mode = MidiImportMode.smart,
    this.skipEmptyTracks = true,
    this.skipPercussion = true,
    this.maxTracks = 16,
  });
}

enum MidiImportMode {
  /// æ™ºèƒ½æ¨¡å¼ï¼šè‡ªåŠ¨åˆ¤æ–­é’¢ç´è°±å¹¶åˆå¹¶
  smart,

  /// ä¿ç•™åŸå§‹ï¼šä¿ç•™æ‰€æœ‰è½¨é“ç»“æ„
  preserveOriginal,

  /// å¼ºåˆ¶é’¢ç´æ¨¡å¼ï¼šåˆå¹¶ä¸ºå·¦å³æ‰‹
  forcePiano,
}
```

#### MIDI å¯¼å‡ºé…ç½®

```dart
class MidiExportOptions {
  /// æ˜¯å¦å†™å…¥åŠ¨æ€velocityï¼ˆåŸºäºdynamicsï¼‰
  final bool dynamicVelocity;

  /// æ˜¯å¦å†™å…¥è¸æ¿ä¿¡æ¯
  final bool includePedal;

  /// æ˜¯å¦å†™å…¥è½¨é“åç§°
  final bool includeTrackName;

  const MidiExportOptions({
    this.dynamicVelocity = true,
    this.includePedal = true,
    this.includeTrackName = true,
  });
}
```

#### MusicXML å¯¼å‡ºé…ç½®

```dart
class MusicXmlExportOptions {
  /// divisionsç²¾åº¦ï¼ˆå»ºè®®ä½¿ç”¨ppqå€¼ï¼‰
  final int divisions;

  /// æ˜¯å¦å¯¼å‡ºè£…é¥°éŸ³å’Œå¥æ³•
  final bool includeNotations;

  /// æ˜¯å¦å¯¼å‡ºåŠ›åº¦å’Œè¸æ¿
  final bool includeDirections;

  /// æ˜¯å¦ä½¿ç”¨<miscellaneous>å­˜å‚¨æ‰©å±•å­—æ®µ
  final bool includeMiscellaneous;

  const MusicXmlExportOptions({
    this.divisions = 480,
    this.includeNotations = true,
    this.includeDirections = true,
    this.includeMiscellaneous = true,
  });
}
```

---

## 3. å®æ–½è®¡åˆ’

### 3.1 ä»£ç æ”¹åŠ¨æ¸…å•

| æ–‡ä»¶ | æ”¹åŠ¨ç±»å‹ | è¯´æ˜ |
|------|---------|------|
| `models/score.dart` | ä¿®å¤ | Beat.totalBeatsè®¡ç®—é€»è¾‘ |
| `services/parsers/midi_parser.dart` | é‡æ„ | é›†æˆæ™ºèƒ½è½¨é“åˆ†æ |
| `services/parsers/midi_import_analyzer.dart` | æ–°å¢ | è½¨é“ç‰¹å¾åˆ†æå’Œæ™ºèƒ½åˆ†ç»„ |
| `services/export/midi_exporter.dart` | å¢å¼º | velocityã€è¸æ¿ã€è½¨é“åç§° |
| `services/export/sheet_export_service.dart` | å¢å¼º | MusicXMLå¯¼å‡ºå®Œå–„ |
| `services/sheet_import_service.dart` | å¢å¼º | æ·»åŠ é…ç½®é€‰é¡¹æ”¯æŒ |
| `models/import_export_options.dart` | æ–°å¢ | é…ç½®ç±»å®šä¹‰ |

### 3.2 å®æ–½æ­¥éª¤

#### Phase 1: æ ¸å¿ƒä¿®å¤ (Day 1)
- [x] ä¿®å¤ Beat.totalBeats å’Œå¼¦è®¡ç®—
- [x] åˆ›å»º midi_import_analyzer.dart
- [x] æµ‹è¯•å’Œå¼¦æ—¶é•¿è®¡ç®—

#### Phase 2: MIDIå¯¼å…¥ä¼˜åŒ– (Day 1-2)
- [x] å®ç°æ™ºèƒ½è½¨é“åˆ†æ
- [x] é›†æˆåˆ° midi_parser.dart
- [x] æ·»åŠ é…ç½®é€‰é¡¹
- [x] æµ‹è¯•å¤šç§MIDIæ–‡ä»¶

#### Phase 3: MIDIå¯¼å‡ºä¼˜åŒ– (Day 2)
- [x] å®ç°åŠ¨æ€velocity
- [x] å®ç°è¸æ¿å†™å…¥
- [x] å®ç°è½¨é“åç§°å†™å…¥
- [x] æµ‹è¯•å¯¼å‡ºè´¨é‡

#### Phase 4: MusicXMLä¼˜åŒ– (Day 3)
- [x] æå‡divisionsç²¾åº¦
- [x] æ·»åŠ notationsæ”¯æŒ
- [x] æ·»åŠ directionæ”¯æŒ
- [x] æµ‹è¯•ä¸MuseScoreçš„å…¼å®¹æ€§

#### Phase 5: é›†æˆæµ‹è¯• (Day 3)
- [x] å¾€è¿”æµ‹è¯•ï¼ˆå¯¼å‡ºâ†’å¯¼å…¥â†’å¯¹æ¯”ï¼‰
- [x] è¾¹ç•Œæƒ…å†µæµ‹è¯•
- [x] æ€§èƒ½æµ‹è¯•

---

## 4. æµ‹è¯•æ–¹æ¡ˆ

### 4.1 å•å…ƒæµ‹è¯•

```dart
// Beat.totalBeats æµ‹è¯•
test('å’Œå¼¦åº”è¯¥å–æœ€é•¿éŸ³ç¬¦æ—¶å€¼', () {
  final beat = Beat(
    index: 0,
    notes: [
      Note(pitch: 60, duration: NoteDuration.quarter),   // 1æ‹
      Note(pitch: 64, duration: NoteDuration.half),      // 2æ‹
      Note(pitch: 67, duration: NoteDuration.quarter),   // 1æ‹
    ],
  );

  expect(beat.totalBeats, equals(2.0));  // åº”è¯¥æ˜¯2æ‹ï¼Œè€Œé4æ‹
});
```

### 4.2 é›†æˆæµ‹è¯•ç”¨ä¾‹

| æµ‹è¯•ç”¨ä¾‹ | è¾“å…¥ | é¢„æœŸè¾“å‡º |
|---------|------|---------|
| ç®€å•é’¢ç´è°± | 2è½¨MIDIï¼ˆé«˜éŸ³+ä½éŸ³ï¼‰ | è‡ªåŠ¨åˆå¹¶ä¸ºå·¦å³æ‰‹ |
| ä¸‰å£°éƒ¨å¡å†œ | 3è½¨MIDIï¼ˆéŸ³åŸŸé‡å ï¼‰ | ä¿ç•™3ä¸ªç‹¬ç«‹è½¨é“ |
| 10è½¨äº¤å“ä¹ | 10è½¨MIDI | æç¤ºè¶…å‡ºé™åˆ¶ï¼Œä¿ç•™å‰16è½¨ |
| å¸¦è¸æ¿çš„ä¹è°± | Score with pedal | MIDIåŒ…å«CC#64äº‹ä»¶ |
| å¸¦åŠ›åº¦çš„ä¹è°± | Score with dynamics | MIDIçš„velocityåŠ¨æ€å˜åŒ– |

### 4.3 å¾€è¿”æµ‹è¯•

```
Score A (åŸå§‹)
  â†“ å¯¼å‡ºMIDI
MIDIæ–‡ä»¶
  â†“ å¯¼å…¥
Score B (æ¢å¤)
  â†“ å¯¹æ¯”
å·®å¼‚æŠ¥å‘Š:
  - å’Œå¼¦æ•°é‡: A=10, B=10 âœ…
  - éŸ³ç¬¦æ€»æ•°: A=120, B=120 âœ…
  - è½¨é“æ•°é‡: A=2, B=2 âœ…
  - ç²¾åº¦æŸå¤±: <0.1% âœ…
```

---

## 5. å…¼å®¹æ€§æµ‹è¯•

### 5.1 å¤–éƒ¨è½¯ä»¶æµ‹è¯•

| è½¯ä»¶ | ç‰ˆæœ¬ | MIDI | MusicXML | ç»“æœ |
|------|------|------|----------|------|
| MuseScore | 4.x | âœ… | âœ… | - |
| Finale | - | âœ… | âœ… | - |
| FL Studio | - | âœ… | - | - |
| Logic Pro | - | âœ… | - | - |

### 5.2 æµ‹è¯•å†…å®¹

1. **å¯¼å‡ºçš„æ–‡ä»¶èƒ½å¦æ‰“å¼€**
2. **éŸ³ç¬¦ã€æ—¶å€¼ã€è°ƒå·ã€æ‹å·æ˜¯å¦æ­£ç¡®**
3. **è½¨é“æ•°é‡å’Œåç§°æ˜¯å¦ä¿ç•™**
4. **åŠ›åº¦ã€è¸æ¿ç­‰è¡¨ç°æ ‡è®°æ˜¯å¦ç”Ÿæ•ˆ**

---

## 6. æ€§èƒ½ä¼˜åŒ–

### 6.1 ä¼˜åŒ–ç‚¹

1. **è½¨é“åˆ†æç¼“å­˜**
   - é¿å…é‡å¤è®¡ç®—è½¨é“ç‰¹å¾
   - ä½¿ç”¨æ‡’åŠ è½½

2. **å¤§æ–‡ä»¶å¤„ç†**
   - æµå¼è§£æMIDIï¼ˆé¿å…ä¸€æ¬¡æ€§åŠ è½½ï¼‰
   - åˆ†é¡µå¤„ç†è¶…é•¿ä¹è°±

3. **å¯¼å‡ºä¼˜åŒ–**
   - é¢„åˆ†é…bufferå¤§å°
   - å‡å°‘å†…å­˜æ‹·è´

### 6.2 æ€§èƒ½æŒ‡æ ‡

| æ“ä½œ | ç›®æ ‡æ€§èƒ½ |
|------|---------|
| MIDIå¯¼å…¥ (1000éŸ³ç¬¦) | <500ms |
| MIDIå¯¼å‡º (1000éŸ³ç¬¦) | <200ms |
| MusicXMLå¯¼å‡º (1000éŸ³ç¬¦) | <300ms |
| è½¨é“åˆ†æ (10è½¨) | <100ms |

---

## 7. æ–‡æ¡£æ›´æ–°

### 7.1 ç”¨æˆ·æ–‡æ¡£

- [ ] æ›´æ–°å¯¼å…¥å¯¼å‡ºåŠŸèƒ½è¯´æ˜
- [ ] æ·»åŠ é…ç½®é€‰é¡¹è¯´æ˜
- [ ] æ·»åŠ MIDIè½¨é“è¯†åˆ«è§„åˆ™è¯´æ˜

### 7.2 å¼€å‘æ–‡æ¡£

- [x] æœ¬è®¾è®¡æ–‡æ¡£
- [ ] APIæ–‡æ¡£æ›´æ–°
- [ ] ä»£ç æ³¨é‡Šå®Œå–„

---

## 8. åç»­ä¼˜åŒ–æ–¹å‘

### 8.1 çŸ­æœŸ (1-2å‘¨)

- [ ] æ·»åŠ å¯¼å…¥é¢„è§ˆUI
- [ ] æ”¯æŒç”¨æˆ·æ‰‹åŠ¨è°ƒæ•´è½¨é“åˆ†é…
- [ ] æ·»åŠ å¯¼å‡ºè´¨é‡éªŒè¯å·¥å…·

### 8.2 ä¸­æœŸ (1-2æœˆ)

- [ ] æ”¯æŒæ›´å¤šMIDIæ§åˆ¶å™¨ (expression, modulation)
- [ ] æ”¯æŒMusicXML 4.0æ–°ç‰¹æ€§
- [ ] ä¼˜åŒ–å¤§æ–‡ä»¶æ€§èƒ½

### 8.3 é•¿æœŸ (3-6æœˆ)

- [ ] æ”¯æŒMIDI 2.0
- [ ] æ”¯æŒæ›´å¤šæ ¼å¼ (Finale, Sibeliusä¸“æœ‰æ ¼å¼)
- [ ] AIè¾…åŠ©ä¿®æ­£å¯¼å…¥é”™è¯¯

---

## é™„å½•

### A. å‚è€ƒèµ„æ–™

- [MIDI 1.0 Specification](https://www.midi.org/specifications)
- [MusicXML 4.0 Documentation](https://www.w3.org/2021/06/musicxml40/)
- [SMuFL Standard](https://www.smufl.org/)

### B. ç›¸å…³Issue

- #001: MIDIå¤šè½¨åˆå¹¶é—®é¢˜
- #002: å¯¼å‡ºåå†å¯¼å…¥æ•°æ®ä¸¢å¤±
- #003: Beatæ—¶é•¿è®¡ç®—é”™è¯¯

### C. ç‰ˆæœ¬å†å²

| ç‰ˆæœ¬ | æ—¥æœŸ | è¯´æ˜ |
|------|------|------|
| v1.0 | 2026-02-06 | åˆç‰ˆï¼Œå®šä¹‰æ ¸å¿ƒä¼˜åŒ–æ–¹æ¡ˆ |
