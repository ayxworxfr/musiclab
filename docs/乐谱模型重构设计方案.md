# ä¹è°±æ¨¡å‹é‡æ„è®¾è®¡æ–¹æ¡ˆ v2.0

> **ç›®æ ‡**: å»ºç«‹ä¸“ä¸šã€æ ‡å‡†ã€å®Œæ•´çš„ä¹è°±æ•°æ®æ¨¡å‹,æ”¯æŒ MusicXML/MIDI å®Œæ•´å¯¼å…¥
>
> **ç‰ˆæœ¬**: v2.0
> **ä½œè€…**: MusicLab Team
> **åˆ›å»ºæ—¥æœŸ**: 2026-01-16

---

## ç›®å½•

1. [é—®é¢˜åˆ†æ](#1-é—®é¢˜åˆ†æ)
2. [è®¾è®¡ç›®æ ‡](#2-è®¾è®¡ç›®æ ‡)
3. [æ•°æ®æ¨¡å‹è®¾è®¡](#3-æ•°æ®æ¨¡å‹è®¾è®¡)
4. [ä¸æ ‡å‡†æ ¼å¼å¯¹é½](#4-ä¸æ ‡å‡†æ ¼å¼å¯¹é½)
5. [JSON æ ¼å¼è§„èŒƒ](#5-json-æ ¼å¼è§„èŒƒ)
6. [MusicXML å¯¼å…¥æ–¹æ¡ˆ](#6-musicxml-å¯¼å…¥æ–¹æ¡ˆ)
7. [MIDI å¯¼å…¥æ–¹æ¡ˆ](#7-midi-å¯¼å…¥æ–¹æ¡ˆ)
8. [è¿ç§»ç­–ç•¥](#8-è¿ç§»ç­–ç•¥)
9. [å®æ–½è®¡åˆ’](#9-å®æ–½è®¡åˆ’)

---

## 1. é—®é¢˜åˆ†æ

### 1.1 ç°æœ‰æ¨¡å‹çš„è‡´å‘½ç¼ºé™·

#### âŒ SheetModel (ç®€è°±æ¨¡å‹) çš„é—®é¢˜

```dart
// å½“å‰çš„ SheetNote ç»“æ„
class SheetNote {
  final int degree;        // 1-7,æ— æ³•ç›´æ¥æ˜ å°„åˆ°MIDI
  final int octave;        // ç›¸å¯¹åç§»,ä¸ç²¾ç¡®
  final NoteDuration duration;
  // ...
}

// å½“å‰çš„ SheetMeasure ç»“æ„
class SheetMeasure {
  final List<SheetNote> notes;  // âŒ æ‰å¹³ç»“æ„,æ— æ³•è¡¨è¾¾å’Œå¼¦
}
```

**æ ¸å¿ƒé—®é¢˜**:
1. **éŸ³é«˜è¡¨ç¤ºä¸ä¸“ä¸š** - ç”¨ `degree` (1-7) è¡¨ç¤ºéŸ³ç¬¦,æ— æ³•ç²¾ç¡®æ˜ å°„åˆ° 88 é”®é’¢ç´
2. **æ—  Beat å±‚çº§** - ç›´æ¥ Measure â†’ Note,æ— æ³•åŒºåˆ†å’Œå¼¦(åŒæ—¶æ¼”å¥)å’Œç¶éŸ³(é¡ºåºæ¼”å¥)
3. **æ— å¤šè½¨æ¦‚å¿µ** - ä¸€ä¸ª SheetModel åªèƒ½è¡¨ç¤ºå•å£°éƒ¨æ—‹å¾‹
4. **æ— æ³•è¡¨è¾¾é’¢ç´è°±** - æ²¡æœ‰å·¦å³æ‰‹ã€å¤§è°±è¡¨çš„æ¦‚å¿µ

#### âœ… Score æ¨¡å‹çš„ä¼˜åŠ¿

```dart
// å·²æœ‰çš„ Score å±‚çº§ç»“æ„(æ­£ç¡®çš„)
Score â†’ Track â†’ Measure â†’ Beat â†’ Note

class Note {
  final int pitch;         // âœ… MIDI éŸ³é«˜,ä¸“ä¸šæ ‡å‡†
  final NoteDuration duration;
  final Accidental accidental;
  final bool tieStart, tieEnd;
  // ...
}

class Beat {
  final List<Note> notes;  // âœ… å¯è¡¨è¾¾å’Œå¼¦
}
```

**ä¼˜åŠ¿**:
- âœ… ä½¿ç”¨ MIDI éŸ³é«˜ (21-108),ä¸å›½é™…æ ‡å‡†ä¸€è‡´
- âœ… å®Œæ•´çš„å±‚çº§ç»“æ„,å¯è¡¨è¾¾å¤æ‚ä¹è°±
- âœ… æ”¯æŒå¤šè½¨ (Track),å¯åŒºåˆ†å·¦å³æ‰‹
- âœ… æ”¯æŒä¸“ä¸šè®°å· (åŠ›åº¦ã€è¸æ¿ã€å¥æ³•)

### 1.2 ä¸ºä»€ä¹ˆæ— æ³•æ”¯æŒ CANON.MID.musicxml

å¡å†œ (Canon in D) æ˜¯å…¸å‹çš„é’¢ç´åŒæ‰‹è°±,åŒ…å«:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ¼ å³æ‰‹ (Treble Clef)                               â”‚
â”‚  â”â”â”â—â”â”â”â—â”â”â”â—â”â”â”  (æ—‹å¾‹)                            â”‚
â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”                                    â”‚
â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”                                    â”‚
â”‚                                                     â”‚
â”‚  ğŸ¼ å·¦æ‰‹ (Bass Clef)                                â”‚
â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”                                    â”‚
â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”                                    â”‚
â”‚  â”â”â—â”â”â”â—â”â”â”â—â”â”â”  (å’Œå¼¦ä¼´å¥)                         â”‚
â”‚     Ped.    Ped.    (è¸æ¿è®°å·)                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**éœ€è¦çš„åŠŸèƒ½:**
- âœ… **å¤šè½¨æ”¯æŒ** - å³æ‰‹è½¨ + å·¦æ‰‹è½¨
- âœ… **å’Œå¼¦æ”¯æŒ** - å¤šä¸ªéŸ³ç¬¦åŒæ—¶æ¼”å¥
- âœ… **MIDI éŸ³é«˜** - ç²¾ç¡®è¡¨è¾¾æ‰€æœ‰éŸ³é«˜
- âœ… **è¸æ¿è®°å·** - Pedal start/end
- âœ… **è¿éŸ³çº¿** - Tie/Slur

**å½“å‰ SheetModel çš„é—®é¢˜:**
- âŒ åªæœ‰å•è½¨,æ— æ³•åŒºåˆ†å·¦å³æ‰‹
- âŒ æ—  Beat å±‚çº§,æ— æ³•æ­£ç¡®è¡¨è¾¾å’Œå¼¦
- âŒ ç”¨ degree (1-7) è¡¨ç¤ºéŸ³é«˜,å…«åº¦å¤„ç†ä¸å‡†ç¡®
- âŒ MusicXML Parser è·³è¿‡äº†å’Œå¼¦éŸ³ (`if chord skip`)

---

## 2. è®¾è®¡ç›®æ ‡

### 2.1 æ ¸å¿ƒç›®æ ‡

| ç›®æ ‡ | è¯´æ˜ |
|------|------|
| **æ ‡å‡†åŒ–** | å®Œæ•´å¯¹é½ MusicXML å’Œ MIDI æ ‡å‡† |
| **ä¸“ä¸šæ€§** | ä½¿ç”¨ MIDI éŸ³é«˜,æ”¯æŒæ‰€æœ‰ä¸“ä¸šè®°å· |
| **å®Œæ•´æ€§** | æ”¯æŒå¤šè½¨ã€å¤šå£°éƒ¨ã€å¤æ‚èŠ‚å¥ |
| **æ˜“ç”¨æ€§** | æ˜“äºæ¸²æŸ“ã€æ’­æ”¾ã€å¯¼å…¥å¯¼å‡º |
| **å‘åå…¼å®¹** | æä¾›ç®€è°±è§†å›¾,å…¼å®¹å·²æœ‰æ•°æ® |

### 2.2 æ”¯æŒçš„åŠŸèƒ½æ¸…å•

#### P0 (å¿…é¡»æ”¯æŒ)
- [x] MIDI éŸ³é«˜è¡¨ç¤º (21-108)
- [x] å¤šè½¨ (Track) æ”¯æŒ
- [x] å·¦å³æ‰‹åŒºåˆ† (Hand.left / Hand.right)
- [x] å’Œå¼¦ (åŒä¸€ Beat å¤šä¸ª Note)
- [x] å®Œæ•´çš„æ—¶å€¼ (whole ~ thirty-second)
- [x] é™„ç‚¹éŸ³ç¬¦
- [x] å˜éŸ³è®°å· (â™¯/â™­/â™®)
- [x] è¿éŸ³çº¿ (Tie)
- [x] åŠ›åº¦è®°å· (pp/p/mp/mf/f/ff)
- [x] è¸æ¿è®°å· (Ped. / *)

#### P1 (é«˜ä¼˜å…ˆçº§)
- [ ] ä¸‰è¿éŸ³ (Tuplet)
- [ ] è£…é¥°éŸ³ (Grace notes)
- [ ] è¡¨æƒ…è®°å· (Slur)
- [ ] é€Ÿåº¦å˜åŒ– (Tempo change)
- [ ] å°èŠ‚çº¿ç±»å‹ (å•/åŒ/ç»ˆæ­¢)
- [ ] åå¤è®°å· (Repeat / D.C. / D.S.)

#### P2 (ä½ä¼˜å…ˆçº§)
- [ ] å¤šå£°éƒ¨ (Voice)
- [ ] æ­Œè¯å¯¹é½
- [ ] æŒ‡æ³•å»ºè®®
- [ ] å’Œå¼¦æ ‡è®° (C / Am / G7)

---

## 3. æ•°æ®æ¨¡å‹è®¾è®¡

### 3.1 æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Score (æ€»è°±)                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  metadata: ScoreMetadata                              â”‚  â”‚
â”‚  â”‚    - key: MusicKey                                    â”‚  â”‚
â”‚  â”‚    - timeSignature: "4/4"                             â”‚  â”‚
â”‚  â”‚    - tempo: 120                                       â”‚  â”‚
â”‚  â”‚    - composer, title, etc.                            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  tracks: List<Track>                                  â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚  Track 1: å³æ‰‹ (Treble Clef, Hand.right)        â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚  measures: List<Measure>                  â”‚   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚  â”‚  Measure 1                          â”‚  â”‚   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚  â”‚  â”‚  beats: List<Beat>            â”‚  â”‚  â”‚   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚  â”‚   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â”‚  Beat 0 (ç¬¬1æ‹)          â”‚  â”‚  â”‚  â”‚   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â”‚  notes: [Note(pitch:72)]â”‚  â”‚  â”‚  â”‚   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚  â”‚   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚  â”‚   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â”‚  Beat 1 (ç¬¬2æ‹)          â”‚  â”‚  â”‚  â”‚   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â”‚  notes: [Note(pitch:74)]â”‚  â”‚  â”‚  â”‚   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚  â”‚   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚                                                        â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚  Track 2: å·¦æ‰‹ (Bass Clef, Hand.left)           â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  measures: [...]                                 â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 æ ¸å¿ƒç±»å®šä¹‰

#### 3.2.1 Score (æ€»è°±)

```dart
class Score {
  /// ä¹è°±ID
  final String id;

  /// æ ‡é¢˜
  final String title;

  /// å‰¯æ ‡é¢˜
  final String? subtitle;

  /// ä½œæ›²å®¶
  final String? composer;

  /// ç¼–æ›²
  final String? arranger;

  /// å…ƒæ•°æ®
  final ScoreMetadata metadata;

  /// è½¨é“åˆ—è¡¨ (é€šå¸¸é’¢ç´è°±ä¸º 2 ä¸ª:å³æ‰‹+å·¦æ‰‹)
  final List<Track> tracks;

  /// å°é¢å›¾
  final String? coverImage;

  /// æ˜¯å¦æ”¶è—
  final bool isFavorite;

  /// æ˜¯å¦å†…ç½®
  final bool isBuiltIn;

  // è¾…åŠ©å±æ€§
  bool get isGrandStaff => tracks.length >= 2 &&
      tracks.any((t) => t.hand == Hand.right) &&
      tracks.any((t) => t.hand == Hand.left);

  Track? get rightHandTrack =>
      tracks.firstWhereOrNull((t) => t.hand == Hand.right);

  Track? get leftHandTrack =>
      tracks.firstWhereOrNull((t) => t.hand == Hand.left);

  int get measureCount => tracks.isEmpty ? 0 : tracks.first.measures.length;

  double get totalDuration {
    final totalBeats = measureCount * metadata.beatsPerMeasure;
    return totalBeats * 60 / metadata.tempo;
  }
}
```

#### 3.2.2 ScoreMetadata (å…ƒæ•°æ®)

```dart
class ScoreMetadata {
  /// è°ƒå· (C, G, D, F, Bb, etc.)
  final MusicKey key;

  /// æ‹å·åˆ†å­ (æ¯å°èŠ‚æ‹æ•°)
  final int beatsPerMeasure;

  /// æ‹å·åˆ†æ¯ (ä»¥å‡ åˆ†éŸ³ç¬¦ä¸ºä¸€æ‹)
  final int beatUnit;

  /// é€Ÿåº¦ BPM
  final int tempo;

  /// é€Ÿåº¦æœ¯è¯­ (Andante, Allegro, etc.)
  final String? tempoText;

  /// éš¾åº¦ (1-5)
  final int difficulty;

  /// åˆ†ç±»
  final ScoreCategory category;

  /// æ ‡ç­¾
  final List<String> tags;

  String get timeSignature => '$beatsPerMeasure/$beatUnit';
}
```

#### 3.2.3 Track (è½¨é“/å£°éƒ¨)

```dart
class Track {
  /// è½¨é“ID
  final String id;

  /// è½¨é“åç§°
  final String name;

  /// è°±å·
  final Clef clef;

  /// æ‰‹ (é’¢ç´ç”¨:å·¦æ‰‹/å³æ‰‹/åŒæ‰‹)
  final Hand? hand;

  /// å°èŠ‚åˆ—è¡¨
  final List<Measure> measures;

  /// éŸ³è‰²
  final Instrument instrument;

  /// æ˜¯å¦é™éŸ³
  final bool isMuted;

  /// éŸ³é‡ (0.0 - 1.0)
  final double volume;
}
```

#### 3.2.4 Measure (å°èŠ‚)

```dart
class Measure {
  /// å°èŠ‚å· (ä»1å¼€å§‹)
  final int number;

  /// æ‹åˆ—è¡¨
  final List<Beat> beats;

  /// åå¤è®°å·
  final RepeatSign? repeatSign;

  /// æˆ¿å­æ ‡è®° (1, 2)
  final int? ending;

  /// å°èŠ‚åŠ›åº¦ (p, mp, mf, f, etc.)
  final Dynamics? dynamics;

  /// è¸æ¿è®°å·
  final PedalMark? pedal;

  /// é€Ÿåº¦å˜åŒ–
  final int? tempoChange;

  // è¾…åŠ©æ–¹æ³•
  List<Note> get allNotes => beats.expand((b) => b.notes).toList();
  double get totalBeats => beats.fold(0.0, (sum, b) => sum + b.totalBeats);
}
```

#### 3.2.5 Beat (æ‹)

```dart
/// Beat - æ—¶é—´å¯¹é½çš„åŸºæœ¬å•ä½
///
/// å…³é”®æ¦‚å¿µ:
/// - åŒä¸€æ‹å†…çš„å¤šä¸ªéŸ³ç¬¦ = å’Œå¼¦ (åŒæ—¶æ¼”å¥)
/// - ä¸åŒæ‹çš„éŸ³ç¬¦ = æ—‹å¾‹çº¿ (é¡ºåºæ¼”å¥)
class Beat {
  /// æ‹ç´¢å¼• (å°èŠ‚å†…ç¬¬å‡ æ‹,ä»0å¼€å§‹)
  /// ä¾‹å¦‚ 4/4 æ‹: index å¯ä»¥æ˜¯ 0, 1, 2, 3
  final int index;

  /// éŸ³ç¬¦åˆ—è¡¨ (å¤šä¸ªéŸ³ç¬¦ = å’Œå¼¦)
  final List<Note> notes;

  /// ä¸‰è¿éŸ³æ ‡è®°
  final Tuplet? tuplet;

  // è¾…åŠ©å±æ€§
  bool get isRest => notes.isEmpty || notes.every((n) => n.isRest);
  bool get isChord => notes.length > 1;
  double get totalBeats => notes.isEmpty ? 1.0 : notes.first.actualBeats;
}
```

#### 3.2.6 Note (éŸ³ç¬¦) - æ ¸å¿ƒ!!!

```dart
class Note {
  /// â˜… éŸ³é«˜ (MIDI number: 21-108, 0=ä¼‘æ­¢ç¬¦)
  ///
  /// MIDI æ ‡å‡†:
  /// - 21  = A0 (é’¢ç´æœ€ä½éŸ³)
  /// - 60  = C4 (ä¸­å¤®C, Middle C)
  /// - 69  = A4 (440Hz æ ‡å‡†éŸ³)
  /// - 108 = C8 (é’¢ç´æœ€é«˜éŸ³)
  final int pitch;

  /// æ—¶å€¼
  final NoteDuration duration;

  /// ä¸´æ—¶å˜éŸ³è®°å·
  final Accidental accidental;

  /// é™„ç‚¹æ•°é‡ (0, 1, 2)
  final int dots;

  /// æŒ‡æ³• (1-5)
  final int? fingering;

  /// æ­Œè¯
  final String? lyric;

  /// å¥æ³• (staccato, accent, etc.)
  final Articulation articulation;

  /// è¿éŸ³çº¿èµ·å§‹
  final bool tieStart;

  /// è¿éŸ³çº¿ç»“æŸ
  final bool tieEnd;

  /// åŠ›åº¦ (å¯åœ¨éŸ³ç¬¦çº§åˆ«è¦†ç›–å°èŠ‚åŠ›åº¦)
  final Dynamics? dynamics;

  // è¾…åŠ©å±æ€§
  bool get isRest => pitch == 0;

  /// å®é™…æ‹æ•° (è€ƒè™‘é™„ç‚¹)
  double get actualBeats {
    var beats = duration.beats;
    var dotValue = beats / 2;
    for (var i = 0; i < dots; i++) {
      beats += dotValue;
      dotValue /= 2;
    }
    return beats;
  }

  /// è·å–éŸ³å (C, D, E, F, G, A, B)
  String get noteName {
    if (isRest) return 'R';
    const names = ['C', 'C#', 'D', 'D#', 'E', 'F',
                   'F#', 'G', 'G#', 'A', 'A#', 'B'];
    return names[pitch % 12];
  }

  /// è·å–å…«åº¦ (A0=0, C4=4)
  int get octave => (pitch / 12).floor();

  /// è·å–ç®€è°±æ•°å­— (1-7, æŒ‰è°ƒå·è½¬æ¢)
  int getJianpuDegree(MusicKey key) {
    // æ ¹æ®è°ƒå·è½¬æ¢
    // å®ç°é€»è¾‘è§å®Œæ•´ä»£ç 
  }

  /// è·å–ç®€è°±å…«åº¦åç§»
  int getOctaveOffset(MusicKey key) {
    // æ ¹æ®è°ƒå·è®¡ç®—
    // å®ç°é€»è¾‘è§å®Œæ•´ä»£ç 
  }
}
```

### 3.3 æšä¸¾å®šä¹‰

```dart
/// è°±å·
enum Clef {
  treble('ğ„', 'Gè°±å·'),    // é«˜éŸ³è°±å·
  bass('ğ„¢', 'Fè°±å·'),      // ä½éŸ³è°±å·
  alto('ğ„¡', 'Cè°±å·');      // ä¸­éŸ³è°±å·

  final String symbol;
  final String name;
  const Clef(this.symbol, this.name);
}

/// æ‰‹
enum Hand {
  right('å³æ‰‹', Color(0xFF2196F3)),  // è“è‰²
  left('å·¦æ‰‹', Color(0xFF4CAF50)),   // ç»¿è‰²
  both('åŒæ‰‹', Color(0xFF9C27B0));   // ç´«è‰²

  final String label;
  final Color color;
  const Hand(this.label, this.color);
}

/// æ—¶å€¼
enum NoteDuration {
  whole(4.0, 'ğ…', 0),
  half(2.0, 'ğ…—ğ…¥', 0),
  quarter(1.0, 'â™©', 0),
  eighth(0.5, 'â™ª', 1),
  sixteenth(0.25, 'ğ…˜ğ…¥ğ…¯', 2),
  thirtySecond(0.125, 'ğ…˜ğ…¥ğ…°', 3);

  final double beats;
  final String symbol;
  final int beamCount;  // ç¬¦æ æ•°é‡
  const NoteDuration(this.beats, this.symbol, this.beamCount);
}

/// è°ƒå·
enum MusicKey {
  C(0, 'Cå¤§è°ƒ'),
  G(1, 'Gå¤§è°ƒ'),
  D(2, 'Då¤§è°ƒ'),
  A(3, 'Aå¤§è°ƒ'),
  E(4, 'Eå¤§è°ƒ'),
  B(5, 'Bå¤§è°ƒ'),
  Fs(6, 'F#å¤§è°ƒ'),
  F(-1, 'Få¤§è°ƒ'),
  Bb(-2, 'Bbå¤§è°ƒ'),
  Eb(-3, 'Ebå¤§è°ƒ'),
  Ab(-4, 'Abå¤§è°ƒ'),
  Db(-5, 'Dbå¤§è°ƒ'),
  // å°è°ƒ
  Am(0, 'Aå°è°ƒ', isMinor: true),
  Em(1, 'Eå°è°ƒ', isMinor: true),
  Dm(-1, 'Då°è°ƒ', isMinor: true);

  final int sharpsOrFlats;  // æ­£æ•°=å‡å·æ•°,è´Ÿæ•°=é™å·æ•°
  final String name;
  final bool isMinor;
  const MusicKey(this.sharpsOrFlats, this.name, {this.isMinor = false});
}

/// å˜éŸ³è®°å·
enum Accidental {
  none('', ''),
  sharp('#', 'â™¯'),
  flat('b', 'â™­'),
  natural('=', 'â™®'),
  doubleSharp('x', 'ğ„ª'),
  doubleFlat('bb', 'ğ„«');

  final String symbol;
  final String displaySymbol;
  const Accidental(this.symbol, this.displaySymbol);
}

/// åŠ›åº¦è®°å·
enum Dynamics {
  ppp('ppp', 0.2),
  pp('pp', 0.3),
  p('p', 0.4),
  mp('mp', 0.5),
  mf('mf', 0.6),
  f('f', 0.7),
  ff('ff', 0.85),
  fff('fff', 1.0);

  final String symbol;
  final double velocity;
  const Dynamics(this.symbol, this.velocity);
}

/// å¥æ³•è®°å·
enum Articulation {
  none(''),
  staccato('.'),    // æ–­å¥
  accent('>'),      // é‡éŸ³
  tenuto('-'),      // ä¿æŒ
  legato('âŒ¢');      // è¿å¥

  final String symbol;
  const Articulation(this.symbol);
}

/// è¸æ¿è®°å·
enum PedalMark {
  start('Ped.'),    // è¸©ä¸‹
  end('*'),         // æŠ¬èµ·
  change('*Ped.');  // æ¢è¸æ¿

  final String symbol;
  const PedalMark(this.symbol);
}

/// åå¤è®°å·
enum RepeatSign {
  start,   // åå¤å¼€å§‹ |:
  end,     // åå¤ç»“æŸ :|
  both;    // åŒå‘åå¤ |::|
}

/// ä¸‰è¿éŸ³
class Tuplet {
  final int actual;    // å®é™…éŸ³ç¬¦æ•° (ä¾‹å¦‚ 3)
  final int normal;    // é€šå¸¸éŸ³ç¬¦æ•° (ä¾‹å¦‚ 2)

  const Tuplet({this.actual = 3, this.normal = 2});

  // å¸¸ç”¨ä¸‰è¿éŸ³
  static const triplet = Tuplet(actual: 3, normal: 2);
  static const quintuplet = Tuplet(actual: 5, normal: 4);
}
```

---

## 4. ä¸æ ‡å‡†æ ¼å¼å¯¹é½

### 4.1 MusicXML æ˜ å°„è¡¨

| MusicXML å…ƒç´  | Score æ¨¡å‹ | è¯´æ˜ |
|--------------|-----------|------|
| `<score-partwise>` | `Score` | æ€»è°± |
| `<part>` | `Track` | å£°éƒ¨/è½¨é“ |
| `<measure>` | `Measure` | å°èŠ‚ |
| `<note>` | `Note` | éŸ³ç¬¦ |
| `<pitch><step>` + `<octave>` | `Note.pitch` (MIDI) | è½¬æ¢ä¸º MIDI éŸ³é«˜ |
| `<duration>` + `<divisions>` | `NoteDuration` | æ—¶å€¼ |
| `<dot>` | `Note.dots` | é™„ç‚¹ |
| `<chord/>` | åŒä¸€ `Beat` å¤šä¸ª `Note` | å’Œå¼¦ |
| `<rest/>` | `Note.isRest` (pitch=0) | ä¼‘æ­¢ç¬¦ |
| `<tie>` | `Note.tieStart/tieEnd` | è¿éŸ³çº¿ |
| `<slur>` | `Articulation.legato` | è¡¨æƒ…çº¿ |
| `<dynamics>` | `Dynamics` | åŠ›åº¦è®°å· |
| `<pedal>` | `PedalMark` | è¸æ¿è®°å· |
| `<time-modification>` | `Tuplet` | ä¸‰è¿éŸ³ |

### 4.2 MIDI æ˜ å°„è¡¨

| MIDI äº‹ä»¶ | Score æ¨¡å‹ | è¯´æ˜ |
|-----------|-----------|------|
| Track | `Track` | è½¨é“ |
| Note On | `Note.pitch` | éŸ³ç¬¦å¼€å§‹ |
| Note Off | ä¸‹ä¸€ä¸ª `Beat` | éŸ³ç¬¦ç»“æŸ |
| Velocity | `Dynamics.velocity` | åŠ›åº¦ |
| Tempo | `ScoreMetadata.tempo` | é€Ÿåº¦ |
| Time Signature | `beatsPerMeasure/beatUnit` | æ‹å· |
| Key Signature | `MusicKey` | è°ƒå· |
| Control Change 64 | `PedalMark` | å»¶éŸ³è¸æ¿ |

---

## 5. JSON æ ¼å¼è§„èŒƒ

### 5.1 å®Œæ•´ç¤ºä¾‹ - Cå¤§è°ƒå¡å†œç‰‡æ®µ

```json
{
  "id": "canon_in_c",
  "title": "Cå¤§è°ƒå¡å†œ",
  "subtitle": "Canon in C",
  "composer": "å¸•èµ«è´å°”",
  "arranger": "ç®€åŒ–ç‰ˆ",
  "metadata": {
    "key": "C",
    "beatsPerMeasure": 4,
    "beatUnit": 4,
    "tempo": 60,
    "tempoText": "Andante",
    "difficulty": 3,
    "category": "classical",
    "tags": ["å·´æ´›å…‹", "ç»å…¸"]
  },
  "tracks": [
    {
      "id": "right_hand",
      "name": "å³æ‰‹",
      "clef": "treble",
      "hand": "right",
      "instrument": "piano",
      "isMuted": false,
      "volume": 1.0,
      "measures": [
        {
          "number": 1,
          "beats": [
            {
              "index": 0,
              "notes": [
                {
                  "pitch": 72,
                  "duration": "quarter",
                  "accidental": "none",
                  "dots": 0
                }
              ]
            },
            {
              "index": 1,
              "notes": [
                {
                  "pitch": 71,
                  "duration": "quarter"
                }
              ]
            },
            {
              "index": 2,
              "notes": [
                {
                  "pitch": 69,
                  "duration": "quarter"
                }
              ]
            },
            {
              "index": 3,
              "notes": [
                {
                  "pitch": 67,
                  "duration": "quarter"
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "id": "left_hand",
      "name": "å·¦æ‰‹",
      "clef": "bass",
      "hand": "left",
      "instrument": "piano",
      "isMuted": false,
      "volume": 1.0,
      "measures": [
        {
          "number": 1,
          "pedal": "start",
          "beats": [
            {
              "index": 0,
              "notes": [
                {
                  "pitch": 48,
                  "duration": "half",
                  "dots": 0
                }
              ]
            },
            {
              "index": 2,
              "notes": [
                {
                  "pitch": 43,
                  "duration": "half"
                }
              ]
            }
          ]
        }
      ]
    }
  ],
  "coverImage": null,
  "isFavorite": false,
  "isBuiltIn": true
}
```

### 5.2 å’Œå¼¦ç¤ºä¾‹

```json
{
  "number": 3,
  "beats": [
    {
      "index": 0,
      "notes": [
        {"pitch": 60, "duration": "quarter"},
        {"pitch": 64, "duration": "quarter"},
        {"pitch": 67, "duration": "quarter"}
      ]
    }
  ]
}
```

ä»¥ä¸Šä¸‰ä¸ªéŸ³ç¬¦ä¼š**åŒæ—¶æ¼”å¥**,å½¢æˆ C å¤§ä¸‰å’Œå¼¦ (C-E-G)ã€‚

### 5.3 è¿éŸ³çº¿ç¤ºä¾‹

```json
{
  "number": 4,
  "beats": [
    {
      "index": 0,
      "notes": [
        {
          "pitch": 72,
          "duration": "half",
          "tieStart": true
        }
      ]
    },
    {
      "index": 2,
      "notes": [
        {
          "pitch": 72,
          "duration": "half",
          "tieEnd": true
        }
      ]
    }
  ]
}
```

ä¸¤ä¸ªéŸ³ç¬¦é€šè¿‡è¿éŸ³çº¿è¿æ¥,å®é™…æ¼”å¥æ—¶é•¿ = half + half = å…¨éŸ³ç¬¦ã€‚

---

## 6. MusicXML å¯¼å…¥æ–¹æ¡ˆ

### 6.1 å®Œæ•´è§£ææµç¨‹

```
MusicXML æ–‡ä»¶
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. è§£æ XML ç»“æ„                        â”‚
â”‚     - score-partwise                    â”‚
â”‚     - part-list                         â”‚
â”‚     - part â†’ measure â†’ note             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. æå–å…ƒæ•°æ®                           â”‚
â”‚     - work-title â†’ Score.title          â”‚
â”‚     - creator â†’ Score.composer          â”‚
â”‚     - key (fifths) â†’ MusicKey           â”‚
â”‚     - time â†’ beatsPerMeasure/beatUnit   â”‚
â”‚     - sound tempo â†’ tempo               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. è§£æè½¨é“ (part)                      â”‚
â”‚     - æ¯ä¸ª part â†’ Track                 â”‚
â”‚     - è¯†åˆ«è°±å· (clef) â†’ Clef.treble/bassâ”‚
â”‚     - è‡ªåŠ¨è¯†åˆ«å·¦å³æ‰‹ (åŸºäºéŸ³é«˜èŒƒå›´)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4. è§£æå°èŠ‚å’ŒéŸ³ç¬¦                       â”‚
â”‚     - measure â†’ Measure                 â”‚
â”‚     - note â†’ Note                       â”‚
â”‚     - pitch (step+octave+alter) â†’ MIDI  â”‚
â”‚     - duration + divisions â†’ NoteDurationâ”‚
â”‚     - chord æ ‡è®° â†’ åŒä¸€ Beat å¤šä¸ª Note   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  5. æ„å»º Beat ç»“æ„                       â”‚
â”‚     - æŒ‰æ—¶é—´ä½ç½®å¯¹é½éŸ³ç¬¦                  â”‚
â”‚     - å’Œå¼¦éŸ³ç¬¦å½’å…¥åŒä¸€ Beat               â”‚
â”‚     - è®¡ç®— Beat.index                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
   Score
```

### 6.2 å…³é”®å®ç°

#### MIDI éŸ³é«˜è½¬æ¢

```dart
int _convertToMidi(String step, int octave, int alter) {
  // step: C, D, E, F, G, A, B
  // octave: 0-8
  // alter: -2/-1/0/1/2 (é™é™/é™/è¿˜åŸ/å‡/å‡å‡)

  const stepToMidi = {
    'C': 0, 'D': 2, 'E': 4, 'F': 5,
    'G': 7, 'A': 9, 'B': 11
  };

  final baseMidi = stepToMidi[step]! + (octave + 1) * 12;
  return baseMidi + alter;
}
```

#### å’Œå¼¦è¯†åˆ«

```dart
// MusicXML ä¸­,å’Œå¼¦çš„è¡¨ç¤º:
// <note>
//   <pitch>...</pitch>
// </note>
// <note>
//   <chord/>  <!-- æ ‡è®°:è¿™æ˜¯å’Œå¼¦çš„ä¸€éƒ¨åˆ† -->
//   <pitch>...</pitch>
// </note>

List<Note> _parseNotesInBeat(List<XmlElement> noteElements) {
  final notes = <Note>[];

  for (final noteElement in noteElements) {
    final note = _parseNote(noteElement);
    notes.add(note);

    // å¦‚æœä¸‹ä¸€ä¸ªéŸ³ç¬¦æœ‰ <chord/> æ ‡è®°,å®ƒä»¬å±äºåŒä¸€æ‹
    final nextElement = noteElements.next;
    if (nextElement?.findElements('chord').isEmpty ?? true) {
      break;  // ä¸æ˜¯å’Œå¼¦,é€€å‡º
    }
  }

  return notes;
}
```

#### å·¦å³æ‰‹è¯†åˆ«

```dart
Hand? _identifyHand(List<Note> notes, Clef clef) {
  if (notes.isEmpty) return null;

  final avgPitch = notes.map((n) => n.pitch).average;

  // é«˜éŸ³è°±è¡¨
  if (clef == Clef.treble) {
    return avgPitch >= 60 ? Hand.right : Hand.left;
  }

  // ä½éŸ³è°±è¡¨
  if (clef == Clef.bass) {
    return avgPitch < 60 ? Hand.left : Hand.right;
  }

  return null;
}
```

---

## 7. MIDI å¯¼å…¥æ–¹æ¡ˆ

### 7.1 MIDI è§£ææµç¨‹

```
MIDI æ–‡ä»¶
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. è¯»å– MIDI æ–‡ä»¶å¤´                     â”‚
â”‚     - Format (0/1/2)                    â”‚
â”‚     - Number of tracks                  â”‚
â”‚     - Ticks per quarter note (PPQ)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. è§£æ Meta äº‹ä»¶                       â”‚
â”‚     - Tempo â†’ ScoreMetadata.tempo       â”‚
â”‚     - Time Signature â†’ beatsPerMeasure  â”‚
â”‚     - Key Signature â†’ MusicKey          â”‚
â”‚     - Track Name â†’ Track.name           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. è§£ææ¯ä¸ªè½¨é“çš„ MIDI äº‹ä»¶              â”‚
â”‚     - Note On (pitch, velocity)         â”‚
â”‚     - Note Off                          â”‚
â”‚     - Control Change 64 (è¸æ¿)           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4. é‡åŒ–åˆ° Beat ç½‘æ ¼                     â”‚
â”‚     - å°†è¿ç»­æ—¶é—´é‡åŒ–åˆ°æ‹ä½ç½®              â”‚
â”‚     - è¯†åˆ«éŸ³ç¬¦æ—¶å€¼                       â”‚
â”‚     - åŒæ—¶åˆ»çš„éŸ³ç¬¦ â†’ å’Œå¼¦                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  5. è‡ªåŠ¨è¯†åˆ«å·¦å³æ‰‹                       â”‚
â”‚     - åŸºäºéŸ³é«˜èŒƒå›´åˆ†å‰²è½¨é“                â”‚
â”‚     - åˆ†é…è°±å· (Treble/Bass)             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
   Score
```

### 7.2 é‡åŒ–ç®—æ³•

```dart
/// å°† MIDI tick é‡åŒ–åˆ°æœ€è¿‘çš„æ‹ä½ç½®
int quantizeToBeat(int tickPosition, int ppq, double beatsPerMeasure) {
  // ppq = Pulses Per Quarter note (ä¾‹å¦‚ 480)
  // tickPosition = éŸ³ç¬¦çš„ç»å¯¹ tick ä½ç½®

  final beatPosition = tickPosition / ppq;  // è½¬æ¢ä¸ºæ‹æ•°
  final quantized = (beatPosition + 0.25).floor();  // é‡åŒ–åˆ°æœ€è¿‘çš„ 1/4 æ‹

  return quantized;
}

/// è¯†åˆ«æ—¶å€¼
NoteDuration identifyDuration(int tickDuration, int ppq) {
  final beats = tickDuration / ppq;

  if (beats >= 3.5) return NoteDuration.whole;
  if (beats >= 1.75) return NoteDuration.half;
  if (beats >= 0.875) return NoteDuration.quarter;
  if (beats >= 0.4375) return NoteDuration.eighth;
  if (beats >= 0.21875) return NoteDuration.sixteenth;
  return NoteDuration.thirtySecond;
}
```

---

## 8. è¿ç§»ç­–ç•¥

### 8.1 åºŸå¼ƒ SheetModel

```dart
// âŒ åºŸå¼ƒ (ä¸å†ä½¿ç”¨)
class SheetModel { ... }
class SheetNote { ... }
class SheetMeasure { ... }

// âœ… ç»Ÿä¸€ä½¿ç”¨
class Score { ... }
class Note { ... }
class Beat { ... }
class Measure { ... }
class Track { ... }
```

### 8.2 å…¼å®¹å±‚è®¾è®¡

ä¸ºäº†ä¿æŒç®€è°±æ¸²æŸ“åŠŸèƒ½,æä¾›è½¬æ¢å±‚:

```dart
/// ç®€è°±è§†å›¾æ•°æ® (ä» Score æ´¾ç”Ÿ)
class JianpuView {
  final Score score;
  final MusicKey key;

  JianpuView(this.score, this.key);

  /// è·å–ç®€è°±æ•°å­—
  List<JianpuNote> getJianpuNotes() {
    final notes = <JianpuNote>[];

    for (final track in score.tracks) {
      for (final measure in track.measures) {
        for (final beat in measure.beats) {
          for (final note in beat.notes) {
            notes.add(JianpuNote(
              degree: note.getJianpuDegree(key),
              octaveOffset: note.getOctaveOffset(key),
              duration: note.duration,
              isDotted: note.dots > 0,
            ));
          }
        }
      }
    }

    return notes;
  }
}
```

### 8.3 æ•°æ®è¿ç§»å·¥å…·

```dart
/// å°†æ—§çš„ SheetModel è½¬æ¢ä¸º Score
class SheetToScoreConverter {
  Score convert(SheetModel sheet) {
    // 1. å°† degree + octave è½¬æ¢ä¸º MIDI pitch
    // 2. å°†æ‰å¹³çš„ notes åˆ—è¡¨æ„å»ºä¸º Beat ç»“æ„
    // 3. åˆ›å»ºå•è½¨ Track

    final notes = <Note>[];
    for (final sheetNote in sheet.measures.expand((m) => m.notes)) {
      final midiPitch = _degreeToMidi(
        sheetNote.degree,
        sheetNote.octave,
        sheet.metadata.key,
      );

      notes.add(Note(
        pitch: midiPitch,
        duration: sheetNote.duration,
        accidental: sheetNote.accidental,
        dots: sheetNote.isDotted ? 1 : 0,
      ));
    }

    // æ„å»º Beat å’Œ Measure...

    return Score(...);
  }

  int _degreeToMidi(int degree, int octave, String key) {
    // åº¦æ•° â†’ MIDI è½¬æ¢é€»è¾‘
    // ...
  }
}
```

---

## 9. å®æ–½è®¡åˆ’

### 9.1 é˜¶æ®µåˆ’åˆ†

#### Phase 1: æ¨¡å‹ç»Ÿä¸€ (3å¤©)
- [x] Score/Track/Measure/Beat/Note å·²å­˜åœ¨,æ— éœ€æ–°å»º
- [ ] å®Œå–„æšä¸¾å®šä¹‰ (Tuplet ç­‰)
- [ ] åˆ é™¤ SheetModel ç›¸å…³ä»£ç 
- [ ] æ›´æ–° JSON è§£æå™¨

#### Phase 2: MusicXML å¢å¼º (3å¤©)
- [ ] é‡å†™ MusicXmlParser
  - æ”¯æŒå¤šè½¨è§£æ
  - æ”¯æŒå’Œå¼¦è¯†åˆ«
  - æ”¯æŒå®Œæ•´çš„éŸ³ç¬¦å±æ€§
- [ ] æ”¯æŒæ›´å¤š MusicXML ç‰¹æ€§
  - åŠ›åº¦è®°å·
  - è¸æ¿è®°å·
  - ä¸‰è¿éŸ³

#### Phase 3: MIDI å¯¼å…¥ (2å¤©)
- [ ] å®ç° MidiParser
- [ ] MIDI äº‹ä»¶è§£æ
- [ ] é‡åŒ–ç®—æ³•
- [ ] å·¦å³æ‰‹è‡ªåŠ¨è¯†åˆ«

#### Phase 4: æ¸²æŸ“é€‚é… (3å¤©)
- [ ] æ›´æ–° GrandStaffPainter (å·²æœ‰åŸºç¡€)
- [ ] æ›´æ–° PianoKeyboardPainter
- [ ] æ›´æ–° JianpuPainter (å…¼å®¹å±‚)
- [ ] å¸ƒå±€å¼•æ“è°ƒæ•´

#### Phase 5: æ•°æ®è¿ç§» (1å¤©)
- [ ] å®ç° SheetToScoreConverter
- [ ] è¿ç§»ç°æœ‰ JSON ä¹è°±
- [ ] æ›´æ–° assets/data/sheets/*.json

#### Phase 6: æµ‹è¯•éªŒè¯ (2å¤©)
- [ ] å¯¼å…¥ CANON.MID.musicxml æµ‹è¯•
- [ ] å¯¼å…¥æ ‡å‡† MIDI æ–‡ä»¶æµ‹è¯•
- [ ] æ’­æ”¾åŠŸèƒ½æµ‹è¯•
- [ ] æ€§èƒ½æµ‹è¯•

**æ€»å·¥æœŸ**: 14 å¤©

### 9.2 éªŒæ”¶æ ‡å‡†

| åŠŸèƒ½ | éªŒæ”¶æ¡ä»¶ |
|------|---------|
| **MusicXML å¯¼å…¥** | æˆåŠŸå¯¼å…¥ CANON.MID.musicxml,å·¦å³æ‰‹åˆ†è½¨æ­£ç¡® |
| **MIDI å¯¼å…¥** | æˆåŠŸå¯¼å…¥æ ‡å‡† MIDI æ–‡ä»¶,éŸ³é«˜å’Œæ—¶å€¼æ­£ç¡® |
| **å¤§è°±è¡¨æ¸²æŸ“** | é«˜éŸ³+ä½éŸ³è°±è¡¨åŒæ—¶æ˜¾ç¤º,èŠ±æ‹¬å·è¿æ¥ |
| **å’Œå¼¦æ”¯æŒ** | å’Œå¼¦éŸ³ç¬¦å‚ç›´å¯¹é½,åŒæ—¶æ¼”å¥ |
| **é’¢ç´é”®ç›˜åŒæ­¥** | æ’­æ”¾æ—¶å·¦å³æ‰‹é”®ç›˜é«˜äº®æ­£ç¡® |
| **ç®€è°±å…¼å®¹** | ç®€è°±æ¸²æŸ“åŠŸèƒ½æ­£å¸¸,å·²æœ‰ä¹è°±å¯æ˜¾ç¤º |

---

## é™„å½•

### A. MIDI éŸ³é«˜å‚è€ƒè¡¨

| MIDI | éŸ³ç¬¦ | é¢‘ç‡ (Hz) | è¯´æ˜ |
|------|------|-----------|------|
| 21 | A0 | 27.5 | é’¢ç´æœ€ä½éŸ³ |
| 40 | E2 | 82.4 | ä½éŸ³E |
| 48 | C3 | 130.8 | ä½éŸ³C |
| 60 | C4 | 261.6 | **ä¸­å¤®C (Middle C)** |
| 69 | A4 | 440.0 | **æ ‡å‡†éŸ³ (Concert A)** |
| 72 | C5 | 523.3 | é«˜éŸ³C |
| 84 | C6 | 1047 | æ›´é«˜éŸ³C |
| 108 | C8 | 4186 | é’¢ç´æœ€é«˜éŸ³ |

### B. MusicXML äº”åº¦åœˆè½¬æ¢è¡¨

| fifths | å‡å·æ•° | è°ƒå· | fifths | é™å·æ•° | è°ƒå· |
|--------|--------|------|--------|--------|------|
| 0 | 0 | C | 0 | 0 | C |
| 1 | 1 | G | -1 | 1 | F |
| 2 | 2 | D | -2 | 2 | Bb |
| 3 | 3 | A | -3 | 3 | Eb |
| 4 | 4 | E | -4 | 4 | Ab |
| 5 | 5 | B | -5 | 5 | Db |
| 6 | 6 | F# | -6 | 6 | Gb |
| 7 | 7 | C# | -7 | 7 | Cb |

### C. å‚è€ƒèµ„æ–™

- [MusicXML å®˜æ–¹æ–‡æ¡£](https://www.w3.org/2021/06/musicxml40/)
- [MIDI 1.0 è§„èŒƒ](https://www.midi.org/specifications)
- [SMuFL éŸ³ä¹ç¬¦å·å­—ä½“](https://www.smufl.org/)
- [Behind Bars - è®°è°±æ³•æŒ‡å—](https://www.amazon.com/Behind-Bars-Definitive-Music-Notation/dp/0571514561)

---

> ğŸ“ **æ–‡æ¡£ç‰ˆæœ¬**: v2.0
> **åˆ›å»ºæ—¥æœŸ**: 2026-01-16
> **çŠ¶æ€**: è®¾è®¡å®Œæˆ,å¾…å®¡æ ¸
> **ä¸‹ä¸€æ­¥**: å®¡æ ¸é€šè¿‡åå¼€å§‹ Phase 1 å®æ–½
