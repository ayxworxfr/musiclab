# 乐理通 - 发布指南

## 📦 自动化发布流程概述

已为项目配置完整的 GitHub Actions 自动化构建流程，支持一键发布到多个平台。

## 🎯 快速发布

### 方式一：使用发布脚本（推荐）

**Linux / macOS:**
```bash
# 给脚本添加执行权限（首次）
chmod +x scripts/release.sh

# 发布新版本
./scripts/release.sh 1.0.0
```

**Windows:**
```cmd
scripts\release.bat 1.0.0
```

脚本会自动完成以下操作：
1. ✅ 检查 Git 工作区状态
2. ✅ 更新 `pubspec.yaml` 版本号
3. ✅ 运行测试确保代码质量
4. ✅ 提交版本更新
5. ✅ 创建并推送 Git tag
6. ✅ 触发 GitHub Actions 自动构建

### 方式二：手动发布

```bash
# 1. 更新版本号（编辑 pubspec.yaml）
version: 1.0.0+1

# 2. 提交更改
git add pubspec.yaml
git commit -m "chore: bump version to 1.0.0"
git push

# 3. 创建 tag
git tag v1.0.0
git push origin v1.0.0
```

## 🏗️ 构建平台

| 平台 | 产物 | 构建时间 | 用途 |
|------|------|---------|------|
| Windows | `musiclab-windows-x64.zip` | ~5分钟 | 桌面端 |
| Android | `app-arm64-v8a-release.apk` | ~8分钟 | 移动端(64位) |
| Android | `app-armeabi-v7a-release.apk` | ~8分钟 | 移动端(32位) |
| Android | `app-release.aab` | ~8分钟 | Google Play |
| Linux | `musiclab-linux-x64.tar.gz` | ~6分钟 | 桌面端 |
| macOS | `musiclab-macos.dmg/.zip` | ~8分钟 | 桌面端 |
| Web | `musiclab-web.tar.gz` | ~3分钟 | 在线体验 |

**总构建时间：约 20-30 分钟**

## 📋 工作流说明

### 1. `build.yml` - 多平台打包

**触发条件：**
- 推送 tag（`v*.*.*` 格式）
- 手动触发（Actions → Build and Release → Run workflow）

**功能：**
- 并行构建所有平台
- 自动创建 GitHub Release
- 上传所有安装包

### 2. `pr-check.yml` - 代码检查

**触发条件：**
- Pull Request 到 main/develop
- 推送到 main/develop

**检查内容：**
- ✅ 代码格式（`dart format`）
- ✅ 静态分析（`flutter analyze`）
- ✅ 单元测试（`flutter test`）
- ✅ 快速构建验证

### 3. `deploy-web.yml` - Web 部署

**触发条件：**
- 推送到 main 分支

**功能：**
- 自动构建 Web 版本
- 部署到 GitHub Pages
- 访问地址：`https://你的用户名.github.io/musiclab/`

## 🔧 首次配置步骤

### 1. 启用 GitHub Actions

1. 进入 GitHub 仓库
2. 点击 **Settings** → **Actions** → **General**
3. 确保 **Actions permissions** 设置为：
   - ✅ Allow all actions and reusable workflows
4. 确保 **Workflow permissions** 设置为：
   - ✅ Read and write permissions

### 2. 启用 GitHub Pages（可选）

1. 进入 **Settings** → **Pages**
2. **Source** 选择 `GitHub Actions`
3. 保存后，推送代码到 main 分支即可自动部署

### 3. 配置 Android 签名（可选，用于正式发布）

如需发布到 Google Play Store：

```bash
# 1. 生成密钥库
keytool -genkey -v -keystore ~/musiclab.jks \
  -keyalg RSA -keysize 2048 -validity 10000 \
  -alias musiclab

# 2. 将密钥库转为 base64
base64 ~/musiclab.jks > musiclab.jks.base64

# 3. 在 GitHub 仓库 Settings → Secrets 添加：
# - ANDROID_KEYSTORE_BASE64: 上面生成的 base64 内容
# - ANDROID_KEYSTORE_PASSWORD: 密钥库密码
# - ANDROID_KEY_ALIAS: musiclab
# - ANDROID_KEY_PASSWORD: 密钥密码
```

## 📊 发布流程示例

### 场景：发布 v1.2.0 版本

```bash
# 1. 确保在主分支且代码最新
git checkout main
git pull

# 2. 运行发布脚本
./scripts/release.sh 1.2.0

# 3. 等待构建完成（20-30分钟）
# 查看进度：https://github.com/你的用户名/musiclab/actions

# 4. 构建完成后，编辑 Release 说明
# 访问：https://github.com/你的用户名/musiclab/releases
```

### Release 说明模板

```markdown
## 🎵 乐理通 v1.2.0

### ✨ 新功能
- 添加五线谱编辑器
- 支持导入 MusicXML 格式

### 🐛 修复
- 修复简谱延音符号位置问题
- 修复五线谱音符连接问题

### 🔧 改进
- 优化播放性能
- 改进用户界面

### 📦 下载说明
- **Windows**: 下载 `musiclab-windows-x64.zip`，解压后运行 `musiclab.exe`
- **Android**: 推荐下载 `app-arm64-v8a-release.apk`（64位设备）
- **macOS**: 下载 `musiclab-macos.dmg`，拖拽到应用程序文件夹
- **Linux**: 下载 `musiclab-linux-x64.tar.gz`，解压后运行 `musiclab`
- **Web**: 访问 https://你的用户名.github.io/musiclab/
```

## 🚨 故障排查

### 构建失败怎么办？

1. **查看构建日志：**
   - Actions → 失败的 workflow → 展开红色的步骤

2. **常见问题：**

   **问题：依赖下载失败**
   ```
   解决：重新运行 workflow（Re-run jobs）
   ```

   **问题：Flutter 版本不兼容**
   ```yaml
   # 编辑 .github/workflows/build.yml
   env:
     FLUTTER_VERSION: '3.35.0'  # 改为项目使用的版本
   ```

   **问题：构建超时**
   ```
   解决：GitHub Actions 免费账户有时间限制，
        可以取消不需要的平台构建
   ```

3. **测试本地构建：**
   ```bash
   # 确保本地可以成功构建
   flutter build windows --release  # Windows
   flutter build apk --release      # Android
   flutter build web --release      # Web
   ```

### 如何禁用某个平台？

编辑 `.github/workflows/build.yml`：

```yaml
jobs:
  # 注释掉不需要的平台
  # build-macos:
  #   ...

  create-release:
    needs: [
      build-windows, 
      build-android, 
      build-web, 
      build-linux,
      # build-macos,  # 也要从这里移除
    ]
```

## 📈 版本号规范

遵循 [语义化版本](https://semver.org/lang/zh-CN/)：

```
主版本号.次版本号.修订号+构建号
1.2.3+10

- 主版本号：不兼容的 API 修改
- 次版本号：向下兼容的功能性新增
- 修订号：向下兼容的问题修正
- 构建号：自动递增
```

**示例：**
- `1.0.0` - 首次正式发布
- `1.1.0` - 添加新功能
- `1.1.1` - 修复 bug
- `2.0.0` - 重大更新，可能不兼容

## 🎯 最佳实践

1. **发布前检查：**
   - ✅ 运行完整测试套件
   - ✅ 在多个平台测试构建
   - ✅ 更新 CHANGELOG.md
   - ✅ 准备 Release 说明

2. **版本管理：**
   - 开发版本在 `develop` 分支
   - 稳定版本在 `main` 分支
   - 从 `main` 分支创建 tag

3. **发布频率：**
   - 重大更新：每 2-3 个月
   - 功能更新：每 2-4 周
   - Bug 修复：按需发布

4. **回滚策略：**
   ```bash
   # 如果发布有问题，可以删除 tag
   git tag -d v1.2.0
   git push origin :refs/tags/v1.2.0
   
   # 然后修复问题后重新发布
   ```

## 📚 相关资源

- [GitHub Actions 文档](https://docs.github.com/actions)
- [Flutter 部署文档](https://docs.flutter.dev/deployment)
- [语义化版本规范](https://semver.org/)
- [.github/README.md](.github/README.md) - 详细技术文档

## ❓ 常见问题

**Q: 构建需要多久？**
A: 完整构建约 20-30 分钟，单个平台 3-8 分钟。

**Q: 可以只构建某个平台吗？**
A: 可以，手动触发 workflow 时可以选择，或者修改配置文件。

**Q: GitHub Actions 免费吗？**
A: 公开仓库免费，私有仓库每月有 2000 分钟免费额度。

**Q: 如何添加自动更新功能？**
A: 可以集成 Sparkle (macOS)、Squirrel (Windows) 或自建更新服务器。

**Q: 能否自动发布到应用商店？**
A: 可以，但需要额外配置：
- Google Play: 使用 Fastlane + Google Play Console API
- App Store: 使用 Fastlane + App Store Connect API
- Microsoft Store: 使用 Windows Store API

---

💡 **提示**: 首次发布建议先手动测试整个流程，确保一切正常后再使用自动化脚本。

