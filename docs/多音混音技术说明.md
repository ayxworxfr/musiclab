# 多音混音技术说明

## 问题：为什么预录音频叠加效果差？

当你把多个预录的音频文件一起播放时，经常会遇到以下问题：

1. **音量过大/削波**：多个音频叠加时，音量会线性增长（N个音频 = N倍音量），容易超过1.0导致削波失真
2. **相位抵消**：如果多个音频的相位对齐，某些频率会相互抵消，导致声音变弱或失真
3. **频率冲突**：相近频率会产生拍频（beating），听起来不自然
4. **动态范围问题**：峰值叠加导致动态范围被压缩

## 钢琴软件是如何解决的？

专业钢琴软件（如MIDI合成器）使用以下技术：

### 1. **RMS归一化（√N规则）**

**关键原理**：音量按 √N 增长，而不是 N

```python
# ❌ 错误方式（简单相加）
mixed = audio1 + audio2 + audio3  # 音量 = 3倍

# ✅ 正确方式（RMS归一化）
mixed = (audio1 + audio2 + audio3) / sqrt(3)  # 音量 = √3倍
```

**为什么有效**：
- 能量（功率）是振幅的平方
- N个音频的能量 = N × 单音能量
- 总振幅 = √(N × 单音能量) = √N × 单音振幅
- 这样音量增长更自然，不会线性爆炸

### 2. **软削波（Soft Clipping）**

防止硬削波失真：

```python
# ❌ 硬削波（会产生失真）
audio = np.clip(audio, -1.0, 1.0)

# ✅ 软削波（平滑压缩）
audio = threshold * tanh(audio / threshold)
```

### 3. **相位随机化**

避免相位对齐导致的增强/抵消：

```python
# 为每个音符添加随机相位偏移
phase_offset = random.uniform(0, 2 * np.pi)
audio = apply_phase_shift(audio, phase_offset)
```

### 4. **动态压缩**

控制峰值，保持动态范围：

```python
# 当信号超过阈值时，使用压缩比降低增益
if amplitude > threshold:
    gain = threshold + (amplitude - threshold) / ratio
```

### 5. **频率分离处理**

对不同音域使用不同的滤波处理，避免频率冲突。

## 代码实现

在 `generate_audio.py` 中，`AudioProcessor.mix()` 方法已经实现了智能混音：

```python
# 使用智能混音
mixed = AudioProcessor.mix([audio1, audio2, audio3], use_smart_mixing=True)
```

关键特性：
- ✅ RMS归一化（`/ sqrt(num_notes)`）
- ✅ 软削波保护
- ✅ 可选的相位随机化

## 对比测试

运行演示查看效果差异：

```bash
python scripts/generate_audio.py --demo-mixing
```

这会生成两个文件：
- `chord_simple_mix.wav` - 简单相加（效果差）
- `chord_smart_mix.wav` - 智能混音（效果好）

## 实际应用建议

### 对于预录音频：

1. **使用智能混音**：
   ```python
   mixed = AudioProcessor.mix(audios, use_smart_mixing=True)
   ```

2. **降低单音音量**：
   ```python
   # 如果混合N个音频，每个音频音量设为 1/√N
   volume_per_note = 1.0 / np.sqrt(num_notes)
   ```

3. **应用动态压缩**：
   ```python
   # 使用 audio_util.py 中的 ChordMixer
   mixer = ChordMixer(config, sample_rate)
   mixed = mixer.mix(note_audios, midi_notes)
   ```

### 对于实时生成（推荐）：

使用 `audio_util.py` 中的 `EnhancedPianoGenerator`，它已经内置了：
- 相位随机化
- 和弦优化
- 智能混音
- 动态压缩

```python
from scripts.audio_util import EnhancedPianoGenerator, AudioConfig, PianoConfig

generator = EnhancedPianoGenerator(AudioConfig(), PianoConfig())
# 生成和弦（自动使用智能混音）
chord = generator.generate_chord([60, 64, 67], velocity=0.8)
```

## 总结

钢琴软件能够同时播放多个音符的关键在于：

1. **不是简单相加**，而是使用RMS归一化
2. **相位随机化**避免相位对齐问题
3. **动态压缩和软削波**防止失真
4. **实时生成**而不是预录叠加

这些技术确保了即使同时播放10个音符，音质依然清晰自然。

